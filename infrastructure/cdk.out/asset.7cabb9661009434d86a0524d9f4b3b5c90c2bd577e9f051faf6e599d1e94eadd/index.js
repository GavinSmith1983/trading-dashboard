"use strict";var R=Object.create;var P=Object.defineProperty;var D=Object.getOwnPropertyDescriptor;var A=Object.getOwnPropertyNames;var x=Object.getPrototypeOf,N=Object.prototype.hasOwnProperty;var M=(d,e)=>{for(var r in e)P(d,r,{get:e[r],enumerable:!0})},w=(d,e,r,n)=>{if(e&&typeof e=="object"||typeof e=="function")for(let t of A(e))!N.call(d,t)&&t!==r&&P(d,t,{get:()=>e[t],enumerable:!(n=D(e,t))||n.enumerable});return d};var f=(d,e,r)=>(r=d!=null?R(x(d)):{},w(e||!d||!d.__esModule?P(r,"default",{value:d,enumerable:!0}):r,d)),O=d=>w(P({},"__esModule",{value:!0}),d);var V={};M(V,{handler:()=>_});module.exports=O(V);var B=require("googleapis");var b=class{apiKey;tenantId;baseUrl;constructor(e){this.apiKey=e.apiKey,this.tenantId=e.tenantId,this.baseUrl=e.baseUrl||"https://api.channelengine.net/api/v2"}async request(e,r="GET",n,t={}){let a=new URLSearchParams;a.set("apikey",this.apiKey);for(let[o,c]of Object.entries(t))a.set(o,String(c));let s=`${this.baseUrl}${e}?${a.toString()}`,i=await fetch(s,{method:r,headers:{"Content-Type":"application/json",Accept:"application/json"},body:n?JSON.stringify(n):void 0});if(!i.ok){let o=await i.text();throw new Error(`ChannelEngine API error: ${i.status} ${i.statusText} - ${o}`)}return i.json()}async fetchProducts(e){let r=[],n=1,t=100,a=!0,s=0;for(console.log(`[CE] Starting product fetch from ${this.baseUrl}/products`);a;){console.log(`[CE] Fetching page ${n}...`);try{let i=await this.request("/products","GET",void 0,{page:n,pageSize:t});if(s=i.TotalCount||s,i.Content&&i.Content.length>0){let o=[];for(let c of i.Content)o.push({merchantProductNo:c.MerchantProductNo,name:c.Name,description:c.Description,brand:c.Brand,ean:c.Ean,stock:c.Stock,price:c.Price,categoryTrail:c.CategoryTrail});r.push(...o),console.log(`[CE] Page ${n}: Got ${o.length} products (${r.length}/${s})`),e&&await e(o,n,s),n++,a=i.Content.length===t}else console.log(`[CE] Page ${n}: No more products`),a=!1}catch(i){throw console.error(`[CE] Error fetching page ${n}:`,i),i}}return console.log(`[CE] Completed: Fetched ${r.length} total products`),r}async fetchSalesData(e,r){let n=new Map,t=1,a=100,s=!0,i=e.toISOString(),o=r.toISOString();for(;s;){let c=await this.request("/orders","GET",void 0,{fromDate:i,toDate:o,page:t,pageSize:a});if(c.Content&&c.Content.length>0){for(let g of c.Content)if(g.Lines)for(let p of g.Lines){let u=n.get(p.MerchantProductNo)||{quantity:0,revenue:0};u.quantity+=p.Quantity,u.revenue+=p.UnitPriceInclVat*p.Quantity,n.set(p.MerchantProductNo,u)}t++,s=c.Content.length===a}else s=!1}return n}async fetchSalesMetrics(){let e=new Date,r=new Date(e.getTime()-7*24*60*60*1e3),n=new Date(e.getTime()-30*24*60*60*1e3),[t,a]=await Promise.all([this.fetchSalesData(r,e),this.fetchSalesData(n,e)]),s=new Set([...t.keys(),...a.keys()]);return Array.from(s).map(i=>({merchantProductNo:i,salesLast7Days:t.get(i)?.quantity||0,salesLast30Days:a.get(i)?.quantity||0}))}async fetchOrders(e,r){let n=[],t=1,a=100,s=!0,i=0,o=e.toISOString();for(console.log(`[CE] Starting order fetch from ${o}`);s;){console.log(`[CE] Fetching orders page ${t}...`);try{let c=await this.request("/orders","GET",void 0,{fromDate:o,page:t,pageSize:a});i=c.TotalCount||i,c.Content&&c.Content.length>0?(n.push(...c.Content),console.log(`[CE] Page ${t}: Got ${c.Content.length} orders (${n.length}/${i})`),r&&await r(c.Content,t,i),t++,s=c.Content.length===a):(console.log(`[CE] Page ${t}: No more orders`),s=!1)}catch(c){throw console.error(`[CE] Error fetching orders page ${t}:`,c),c}}return console.log(`[CE] Completed: Fetched ${n.length} total orders`),n}async updatePrices(e){let r=[];for(let t=0;t<e.length;t+=100){let a=e.slice(t,t+100);try{let s=a.map(o=>({MerchantProductNo:o.merchantProductNo,Price:o.price})),i=await this.request("/products/bulk","PUT",s);i.Success||r.push(`Batch ${t/100+1}: ${i.Message}`)}catch(s){r.push(`Batch ${t/100+1}: ${s instanceof Error?s.message:"Unknown error"}`)}}return{success:r.length===0,errors:r}}async updateStock(e){let r=[];for(let t=0;t<e.length;t+=100){let a=e.slice(t,t+100);try{let s=a.map(o=>({MerchantProductNo:o.merchantProductNo,Stock:o.stock})),i=await this.request("/offer/stock","PUT",s);i.Success||r.push(`Batch ${t/100+1}: ${i.Message}`)}catch(s){r.push(`Batch ${t/100+1}: ${s instanceof Error?s.message:"Unknown error"}`)}}return{success:r.length===0,errors:r}}};async function v(d){let{SecretsManagerClient:e,GetSecretValueCommand:r}=await import("@aws-sdk/client-secrets-manager"),t=await new e({}).send(new r({SecretId:d}));if(!t.SecretString)throw new Error("ChannelEngine secret not found");let a=JSON.parse(t.SecretString);return new b({apiKey:a.apiKey,tenantId:a.tenantId,baseUrl:a.baseUrl})}var $=require("uuid");var S=require("@aws-sdk/client-dynamodb"),l=require("@aws-sdk/lib-dynamodb"),C=class{docClient;productsTable;rulesTable;proposalsTable;channelsTable;ordersTable;carrierCostsTable;constructor(e){let r=new S.DynamoDBClient({});this.docClient=l.DynamoDBDocumentClient.from(r,{marshallOptions:{removeUndefinedValues:!0}}),this.productsTable=e.productsTable,this.rulesTable=e.rulesTable,this.proposalsTable=e.proposalsTable,this.channelsTable=e.channelsTable,this.ordersTable=e.ordersTable||"repricing-orders",this.carrierCostsTable=e.carrierCostsTable||"repricing-carrier-costs"}async getProduct(e){return(await this.docClient.send(new l.GetCommand({TableName:this.productsTable,Key:{sku:e}}))).Item||null}async putProduct(e){await this.docClient.send(new l.PutCommand({TableName:this.productsTable,Item:{...e,lastUpdated:new Date().toISOString()}}))}async getAllProducts(){let e=[],r;do{let n=await this.docClient.send(new l.ScanCommand({TableName:this.productsTable,ExclusiveStartKey:r}));n.Items&&e.push(...n.Items),r=n.LastEvaluatedKey}while(r);return e}async batchPutProducts(e){let r=new Date().toISOString(),n=this.chunkArray(e,25);for(let t of n)await this.docClient.send(new l.BatchWriteCommand({RequestItems:{[this.productsTable]:t.map(a=>({PutRequest:{Item:{...a,lastUpdated:r}}}))}}))}async getProductsByBrand(e){return(await this.docClient.send(new l.QueryCommand({TableName:this.productsTable,IndexName:"by-brand",KeyConditionExpression:"brand = :brand",ExpressionAttributeValues:{":brand":e}}))).Items||[]}async getRule(e){return(await this.docClient.send(new l.GetCommand({TableName:this.rulesTable,Key:{ruleId:e}}))).Item||null}async putRule(e){await this.docClient.send(new l.PutCommand({TableName:this.rulesTable,Item:{...e,updatedAt:new Date().toISOString()}}))}async getAllRules(){return((await this.docClient.send(new l.ScanCommand({TableName:this.rulesTable}))).Items||[]).sort((r,n)=>r.priority-n.priority)}async deleteRule(e){let{DeleteCommand:r}=await import("@aws-sdk/lib-dynamodb");await this.docClient.send(new r({TableName:this.rulesTable,Key:{ruleId:e}}))}async getProposal(e){return(await this.docClient.send(new l.GetCommand({TableName:this.proposalsTable,Key:{proposalId:e}}))).Item||null}async putProposal(e){await this.docClient.send(new l.PutCommand({TableName:this.proposalsTable,Item:e}))}async batchPutProposals(e){let r=this.chunkArray(e,25);for(let n of r)await this.docClient.send(new l.BatchWriteCommand({RequestItems:{[this.proposalsTable]:n.map(t=>({PutRequest:{Item:t}}))}}))}async getProposalsByStatus(e){return(await this.docClient.send(new l.QueryCommand({TableName:this.proposalsTable,IndexName:"by-status",KeyConditionExpression:"#status = :status",ExpressionAttributeNames:{"#status":"status"},ExpressionAttributeValues:{":status":e},ScanIndexForward:!1}))).Items||[]}async queryProposals(e,r=1,n=50){let t=[],a={},s={};if(e.status){let u=Array.isArray(e.status)?e.status:[e.status];u.length===1&&(t.push("#status = :status"),a["#status"]="status",s[":status"]=u[0])}e.brand&&(t.push("brand = :brand"),s[":brand"]=e.brand),e.batchId&&(t.push("batchId = :batchId"),s[":batchId"]=e.batchId),e.hasWarnings&&(t.push("size(warnings) > :zero"),s[":zero"]=0);let o=(await this.docClient.send(new l.ScanCommand({TableName:this.proposalsTable,FilterExpression:t.length>0?t.join(" AND "):void 0,ExpressionAttributeNames:Object.keys(a).length>0?a:void 0,ExpressionAttributeValues:Object.keys(s).length>0?s:void 0}))).Items||[];if(e.searchTerm){let u=e.searchTerm.toLowerCase();o=o.filter(h=>h.sku.toLowerCase().includes(u)||h.productTitle.toLowerCase().includes(u))}o.sort((u,h)=>new Date(h.createdAt).getTime()-new Date(u.createdAt).getTime());let c=o.length,g=(r-1)*n;return{items:o.slice(g,g+n),totalCount:c,page:r,pageSize:n,hasMore:g+n<c}}async updateProposalStatus(e,r,n,t,a){let s=["#status = :status","reviewedAt = :reviewedAt","reviewedBy = :reviewedBy"],i={"#status":"status"},o={":status":r,":reviewedAt":new Date().toISOString(),":reviewedBy":n};t&&(s.push("reviewNotes = :notes"),o[":notes"]=t),a!==void 0&&(s.push("approvedPrice = :approvedPrice"),o[":approvedPrice"]=a),await this.docClient.send(new l.UpdateCommand({TableName:this.proposalsTable,Key:{proposalId:e},UpdateExpression:`SET ${s.join(", ")}`,ExpressionAttributeNames:i,ExpressionAttributeValues:o}))}async getChannel(e){return(await this.docClient.send(new l.GetCommand({TableName:this.channelsTable,Key:{channelId:e}}))).Item||null}async putChannel(e){await this.docClient.send(new l.PutCommand({TableName:this.channelsTable,Item:{...e,lastUpdated:new Date().toISOString()}}))}async getAllChannels(){return(await this.docClient.send(new l.ScanCommand({TableName:this.channelsTable}))).Items||[]}async getCarrierCost(e){return(await this.docClient.send(new l.GetCommand({TableName:this.carrierCostsTable,Key:{carrierId:e}}))).Item||null}async putCarrierCost(e){await this.docClient.send(new l.PutCommand({TableName:this.carrierCostsTable,Item:{...e,lastUpdated:new Date().toISOString()}}))}async getAllCarrierCosts(){return(await this.docClient.send(new l.ScanCommand({TableName:this.carrierCostsTable}))).Items||[]}async deleteCarrierCost(e){let{DeleteCommand:r}=await import("@aws-sdk/lib-dynamodb");await this.docClient.send(new r({TableName:this.carrierCostsTable,Key:{carrierId:e}}))}async batchPutCarrierCosts(e){let r=new Date().toISOString(),n=this.chunkArray(e,25);for(let t of n)await this.docClient.send(new l.BatchWriteCommand({RequestItems:{[this.carrierCostsTable]:t.map(a=>({PutRequest:{Item:{...a,lastUpdated:r}}}))}}))}async batchPutOrders(e){let r=this.chunkArray(e,25);for(let n of r)await this.docClient.send(new l.BatchWriteCommand({RequestItems:{[this.ordersTable]:n.map(t=>({PutRequest:{Item:t}}))}}))}async getOrdersByDate(e){return(await this.docClient.send(new l.QueryCommand({TableName:this.ordersTable,IndexName:"by-date",KeyConditionExpression:"orderDateDay = :dateDay",ExpressionAttributeValues:{":dateDay":e}}))).Items||[]}async getOrdersByChannel(e,r,n){return(await this.docClient.send(new l.QueryCommand({TableName:this.ordersTable,IndexName:"by-channel",KeyConditionExpression:"channelName = :channel AND orderDate BETWEEN :fromDate AND :toDate",ExpressionAttributeValues:{":channel":e,":fromDate":r,":toDate":n}}))).Items||[]}async getOrderCount(){return(await this.docClient.send(new l.ScanCommand({TableName:this.ordersTable,Select:"COUNT"}))).Count||0}async getProductLookupMap(){let e=await this.getAllProducts(),r=new Map,n=new Map;for(let t of e)r.set(t.sku.toUpperCase(),t),t.balterleySku&&n.set(t.balterleySku.toUpperCase(),t);return{bySku:r,byBalterleySku:n}}async getSalesBySku(e=7){let r=new Map,n=new Date,t=[];for(let a=0;a<e;a++){let s=new Date(n);s.setDate(s.getDate()-a),t.push(s.toISOString().substring(0,10))}for(let a of t){let s=await this.getOrdersByDate(a);for(let i of s)if(i.lines)for(let o of i.lines){let c=r.get(o.sku)||{quantity:0,revenue:0};c.quantity+=o.quantity,c.revenue+=o.lineTotalInclVat,r.set(o.sku,c)}}return r}chunkArray(e,r){let n=[];for(let t=0;t<e.length;t+=r)n.push(e.slice(t,t+r));return n}};function T(){return new C({productsTable:process.env.PRODUCTS_TABLE||"repricing-products",rulesTable:process.env.PRICING_RULES_TABLE||"repricing-rules",proposalsTable:process.env.PRICE_PROPOSALS_TABLE||"repricing-proposals",channelsTable:process.env.CHANNEL_CONFIG_TABLE||"repricing-channels",ordersTable:process.env.ORDERS_TABLE||"repricing-orders",carrierCostsTable:process.env.CARRIER_COSTS_TABLE||"repricing-carrier-costs"})}async function _(d,e){console.log("Starting order sync",{event:d,requestId:e.awsRequestId});let r=T(),n=0;try{let t;d.fromDate?(t=new Date(d.fromDate),console.log(`[ORDERS] Backfill mode: fetching from ${d.fromDate}`)):(t=new Date,t.setDate(t.getDate()-30),console.log(`[ORDERS] Incremental mode: fetching from ${t.toISOString()}`));let a=process.env.CHANNEL_ENGINE_SECRET_ARN;if(!a)throw new Error("CHANNEL_ENGINE_SECRET_ARN not configured");let s=await v(a),i=new Date().toISOString();await s.fetchOrders(t,async(o,c,g)=>{let p=[];for(let u of o){let h=u.OrderDate,I=h.substring(0,10),k=(u.Lines||[]).map(m=>({lineId:String(m.Id),channelOrderLineNo:m.ChannelOrderLineNo,sku:m.MerchantProductNo||"UNKNOWN",description:m.Description||"",gtin:m.Gtin,quantity:m.Quantity,unitPriceInclVat:m.UnitPriceInclVat,unitPriceExclVat:m.UnitPriceExclVat,lineTotalInclVat:m.LineTotalInclVat,lineTotalExclVat:m.LineTotalExclVat,lineVat:m.LineVat,vatRate:m.VatRate,feeFixed:m.FeeFixed,feeRate:m.FeeRate,shippingMethod:m.ShippingMethod,shippingServiceLevel:m.ShippingServiceLevel,status:m.Status})),y=u.Lines?.[0],E={orderId:String(u.Id),channelOrderNo:u.ChannelOrderNo,channelName:u.ChannelName||"Unknown",channelId:u.ChannelId,orderDate:h,orderDateDay:I,status:u.Status,subTotalInclVat:u.SubTotalInclVat,subTotalExclVat:u.SubTotalInclVat-u.SubTotalVat,totalVat:u.TotalVat,shippingCostsInclVat:u.ShippingCostsInclVat,totalInclVat:u.TotalInclVat,totalFee:u.TotalFee,currencyCode:u.CurrencyCode,shippingMethod:y?.ShippingMethod,shippingServiceLevel:y?.ShippingServiceLevel,lines:k,syncedAt:i};p.push(E)}p.length>0&&(await r.batchPutOrders(p),n+=p.length),console.log(`[DB] Saved batch ${c}: ${p.length} orders (${n}/${g} total saved)`)}),console.log(`[DONE] Order sync complete: ${n} orders saved`)}catch(t){throw console.error(`[ERROR] Order sync failed after saving ${n} orders:`,t),t}}0&&(module.exports={handler});
//# sourceMappingURL=index.js.map
