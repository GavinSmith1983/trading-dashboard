"use strict";var I=Object.create;var h=Object.defineProperty;var T=Object.getOwnPropertyDescriptor;var R=Object.getOwnPropertyNames;var M=Object.getPrototypeOf,x=Object.prototype.hasOwnProperty;var D=(c,e)=>{for(var t in e)h(c,t,{get:e[t],enumerable:!0})},S=(c,e,t,r)=>{if(e&&typeof e=="object"||typeof e=="function")for(let n of R(e))!x.call(c,n)&&n!==t&&h(c,n,{get:()=>e[n],enumerable:!(r=T(e,n))||r.enumerable});return c};var P=(c,e,t)=>(t=c!=null?I(M(c)):{},S(e||!c||!c.__esModule?h(t,"default",{value:c,enumerable:!0}):t,c)),N=c=>S(h({},"__esModule",{value:!0}),c);var G={};D(G,{handler:()=>_});module.exports=N(G);var f=require("googleapis"),b=class{sheets;spreadsheetId;constructor(e,t){let r=new f.google.auth.GoogleAuth({credentials:e,scopes:["https://www.googleapis.com/auth/spreadsheets.readonly"]});this.sheets=f.google.sheets({version:"v4",auth:r}),this.spreadsheetId=t}async fetchProducts(e="Sheet1"){let r=(await this.sheets.spreadsheets.values.get({spreadsheetId:this.spreadsheetId,range:`${e}!A:O`})).data.values;if(!r||r.length<2)return[];let n=r[0];return r.slice(1).filter(s=>s[1]).map(s=>this.parseRow(s,n))}parseRow(e,t){let r=a=>e[a]?.trim()||"",n=a=>{let s=e[a]?.replace(/[Â£$,]/g,"").trim();return parseFloat(s)||0};return{brandName:r(0),productSku:r(1),balterleySku:r(2),familyVariants:r(3),mrp:n(4),bandqPricing:n(5),amazonPricing:n(6),ebayPricing:n(7),manoManoPricing:n(8),shopifyPricing:n(9),discountStartDate:r(11)||void 0,discountEndDate:r(12)||void 0,discountPrice:n(13)||void 0}}static toProduct(e){let t=[e.amazonPricing,e.ebayPricing,e.bandqPricing,e.manoManoPricing,e.shopifyPricing].filter(n=>n>0),r=t.length>0?t[0]:e.mrp;return{sku:e.productSku,balterleySku:e.balterleySku||void 0,title:e.productSku,brand:e.brandName,familyVariants:e.familyVariants||void 0,mrp:e.mrp,currentPrice:r,channelPrices:{amazon:e.amazonPricing||void 0,ebay:e.ebayPricing||void 0,bandq:e.bandqPricing||void 0,manomano:e.manoManoPricing||void 0,shopify:e.shopifyPricing||void 0},discountPrice:e.discountPrice||void 0,discountStartDate:e.discountStartDate||void 0,discountEndDate:e.discountEndDate||void 0,lastSyncedFromSheet:new Date().toISOString()}}async getSheetNames(){return(await this.sheets.spreadsheets.get({spreadsheetId:this.spreadsheetId})).data.sheets?.map(t=>t.properties?.title||"")||[]}};async function v(c){let{SecretsManagerClient:e,GetSecretValueCommand:t}=await import("@aws-sdk/client-secrets-manager"),n=await new e({}).send(new t({SecretId:c}));if(!n.SecretString)throw new Error("Google Sheets secret not found");let a=JSON.parse(n.SecretString),s=JSON.parse(a.credentials);return new b(s,a.spreadsheetId)}var y=class{apiKey;tenantId;baseUrl;constructor(e){this.apiKey=e.apiKey,this.tenantId=e.tenantId,this.baseUrl=e.baseUrl||"https://api.channelengine.net/api/v2"}async request(e,t="GET",r,n={}){let a=new URLSearchParams;a.set("apikey",this.apiKey);for(let[i,d]of Object.entries(n))a.set(i,String(d));let s=`${this.baseUrl}${e}?${a.toString()}`,o=await fetch(s,{method:t,headers:{"Content-Type":"application/json",Accept:"application/json"},body:r?JSON.stringify(r):void 0});if(!o.ok){let i=await o.text();throw new Error(`ChannelEngine API error: ${o.status} ${o.statusText} - ${i}`)}return o.json()}async fetchProducts(){let e=[],t=1,r=100,n=!0,a=0;for(console.log(`[CE] Starting product fetch from ${this.baseUrl}/products`);n;){console.log(`[CE] Fetching page ${t}...`);try{let s=await this.request("/products","GET",void 0,{page:t,pageSize:r});if(a=s.TotalCount||a,s.Content&&s.Content.length>0){console.log(`[CE] Page ${t}: Got ${s.Content.length} products (${e.length+s.Content.length}/${a})`);for(let o of s.Content)e.push({merchantProductNo:o.MerchantProductNo,name:o.Name,description:o.Description,brand:o.Brand,ean:o.Ean,stock:o.Stock,price:o.Price,categoryTrail:o.CategoryTrail});t++,n=s.Content.length===r}else console.log(`[CE] Page ${t}: No more products`),n=!1}catch(s){throw console.error(`[CE] Error fetching page ${t}:`,s),s}}return console.log(`[CE] Completed: Fetched ${e.length} total products`),e}async fetchSalesData(e,t){let r=new Map,n=1,a=100,s=!0,o=e.toISOString(),i=t.toISOString();for(;s;){let d=await this.request("/orders","GET",void 0,{fromDate:o,toDate:i,page:n,pageSize:a});if(d.Content&&d.Content.length>0){for(let p of d.Content)if(p.Lines)for(let l of p.Lines){let m=r.get(l.MerchantProductNo)||{quantity:0,revenue:0};m.quantity+=l.Quantity,m.revenue+=l.UnitPriceInclVat*l.Quantity,r.set(l.MerchantProductNo,m)}n++,s=d.Content.length===a}else s=!1}return r}async fetchSalesMetrics(){let e=new Date,t=new Date(e.getTime()-7*24*60*60*1e3),r=new Date(e.getTime()-30*24*60*60*1e3),[n,a]=await Promise.all([this.fetchSalesData(t,e),this.fetchSalesData(r,e)]),s=new Set([...n.keys(),...a.keys()]);return Array.from(s).map(o=>({merchantProductNo:o,salesLast7Days:n.get(o)?.quantity||0,salesLast30Days:a.get(o)?.quantity||0}))}async updatePrices(e){let t=[];for(let n=0;n<e.length;n+=100){let a=e.slice(n,n+100);try{let s=a.map(i=>({MerchantProductNo:i.merchantProductNo,Price:i.price})),o=await this.request("/products/bulk","PUT",s);o.Success||t.push(`Batch ${n/100+1}: ${o.Message}`)}catch(s){t.push(`Batch ${n/100+1}: ${s instanceof Error?s.message:"Unknown error"}`)}}return{success:t.length===0,errors:t}}async updateStock(e){let t=[];for(let n=0;n<e.length;n+=100){let a=e.slice(n,n+100);try{let s=a.map(i=>({MerchantProductNo:i.merchantProductNo,Stock:i.stock})),o=await this.request("/offer/stock","PUT",s);o.Success||t.push(`Batch ${n/100+1}: ${o.Message}`)}catch(s){t.push(`Batch ${n/100+1}: ${s instanceof Error?s.message:"Unknown error"}`)}}return{success:t.length===0,errors:t}}};async function k(c){let{SecretsManagerClient:e,GetSecretValueCommand:t}=await import("@aws-sdk/client-secrets-manager"),n=await new e({}).send(new t({SecretId:c}));if(!n.SecretString)throw new Error("ChannelEngine secret not found");let a=JSON.parse(n.SecretString);return new y({apiKey:a.apiKey,tenantId:a.tenantId,baseUrl:a.baseUrl})}var B=require("uuid");var E=require("@aws-sdk/client-dynamodb"),u=require("@aws-sdk/lib-dynamodb"),C=class{docClient;productsTable;rulesTable;proposalsTable;channelsTable;constructor(e){let t=new E.DynamoDBClient({});this.docClient=u.DynamoDBDocumentClient.from(t,{marshallOptions:{removeUndefinedValues:!0}}),this.productsTable=e.productsTable,this.rulesTable=e.rulesTable,this.proposalsTable=e.proposalsTable,this.channelsTable=e.channelsTable}async getProduct(e){return(await this.docClient.send(new u.GetCommand({TableName:this.productsTable,Key:{sku:e}}))).Item||null}async putProduct(e){await this.docClient.send(new u.PutCommand({TableName:this.productsTable,Item:{...e,lastUpdated:new Date().toISOString()}}))}async getAllProducts(){let e=[],t;do{let r=await this.docClient.send(new u.ScanCommand({TableName:this.productsTable,ExclusiveStartKey:t}));r.Items&&e.push(...r.Items),t=r.LastEvaluatedKey}while(t);return e}async batchPutProducts(e){let t=new Date().toISOString(),r=this.chunkArray(e,25);for(let n of r)await this.docClient.send(new u.BatchWriteCommand({RequestItems:{[this.productsTable]:n.map(a=>({PutRequest:{Item:{...a,lastUpdated:t}}}))}}))}async getProductsByBrand(e){return(await this.docClient.send(new u.QueryCommand({TableName:this.productsTable,IndexName:"by-brand",KeyConditionExpression:"brand = :brand",ExpressionAttributeValues:{":brand":e}}))).Items||[]}async getRule(e){return(await this.docClient.send(new u.GetCommand({TableName:this.rulesTable,Key:{ruleId:e}}))).Item||null}async putRule(e){await this.docClient.send(new u.PutCommand({TableName:this.rulesTable,Item:{...e,updatedAt:new Date().toISOString()}}))}async getAllRules(){return((await this.docClient.send(new u.ScanCommand({TableName:this.rulesTable}))).Items||[]).sort((t,r)=>t.priority-r.priority)}async deleteRule(e){let{DeleteCommand:t}=await import("@aws-sdk/lib-dynamodb");await this.docClient.send(new t({TableName:this.rulesTable,Key:{ruleId:e}}))}async getProposal(e){return(await this.docClient.send(new u.GetCommand({TableName:this.proposalsTable,Key:{proposalId:e}}))).Item||null}async putProposal(e){await this.docClient.send(new u.PutCommand({TableName:this.proposalsTable,Item:e}))}async batchPutProposals(e){let t=this.chunkArray(e,25);for(let r of t)await this.docClient.send(new u.BatchWriteCommand({RequestItems:{[this.proposalsTable]:r.map(n=>({PutRequest:{Item:n}}))}}))}async getProposalsByStatus(e){return(await this.docClient.send(new u.QueryCommand({TableName:this.proposalsTable,IndexName:"by-status",KeyConditionExpression:"#status = :status",ExpressionAttributeNames:{"#status":"status"},ExpressionAttributeValues:{":status":e},ScanIndexForward:!1}))).Items||[]}async queryProposals(e,t=1,r=50){let n=[],a={},s={};if(e.status){let m=Array.isArray(e.status)?e.status:[e.status];m.length===1&&(n.push("#status = :status"),a["#status"]="status",s[":status"]=m[0])}e.brand&&(n.push("brand = :brand"),s[":brand"]=e.brand),e.batchId&&(n.push("batchId = :batchId"),s[":batchId"]=e.batchId),e.hasWarnings&&(n.push("size(warnings) > :zero"),s[":zero"]=0);let i=(await this.docClient.send(new u.ScanCommand({TableName:this.proposalsTable,FilterExpression:n.length>0?n.join(" AND "):void 0,ExpressionAttributeNames:Object.keys(a).length>0?a:void 0,ExpressionAttributeValues:Object.keys(s).length>0?s:void 0}))).Items||[];if(e.searchTerm){let m=e.searchTerm.toLowerCase();i=i.filter(g=>g.sku.toLowerCase().includes(m)||g.productTitle.toLowerCase().includes(m))}i.sort((m,g)=>new Date(g.createdAt).getTime()-new Date(m.createdAt).getTime());let d=i.length,p=(t-1)*r;return{items:i.slice(p,p+r),totalCount:d,page:t,pageSize:r,hasMore:p+r<d}}async updateProposalStatus(e,t,r,n,a){let s=["#status = :status","reviewedAt = :reviewedAt","reviewedBy = :reviewedBy"],o={"#status":"status"},i={":status":t,":reviewedAt":new Date().toISOString(),":reviewedBy":r};n&&(s.push("reviewNotes = :notes"),i[":notes"]=n),a!==void 0&&(s.push("approvedPrice = :approvedPrice"),i[":approvedPrice"]=a),await this.docClient.send(new u.UpdateCommand({TableName:this.proposalsTable,Key:{proposalId:e},UpdateExpression:`SET ${s.join(", ")}`,ExpressionAttributeNames:o,ExpressionAttributeValues:i}))}async getChannel(e){return(await this.docClient.send(new u.GetCommand({TableName:this.channelsTable,Key:{channelId:e}}))).Item||null}async putChannel(e){await this.docClient.send(new u.PutCommand({TableName:this.channelsTable,Item:{...e,lastUpdated:new Date().toISOString()}}))}async getAllChannels(){return(await this.docClient.send(new u.ScanCommand({TableName:this.channelsTable}))).Items||[]}chunkArray(e,t){let r=[];for(let n=0;n<e.length;n+=t)r.push(e.slice(n,n+t));return r}};function A(){return new C({productsTable:process.env.PRODUCTS_TABLE||"repricing-products",rulesTable:process.env.PRICING_RULES_TABLE||"repricing-rules",proposalsTable:process.env.PRICE_PROPOSALS_TABLE||"repricing-proposals",channelsTable:process.env.CHANNEL_CONFIG_TABLE||"repricing-channels"})}async function _(c,e){console.log("Starting data sync",{event:c,requestId:e.awsRequestId});let t=A();try{console.log("Fetching products from ChannelEngine (primary source)...");let r=await L();console.log(`Fetched ${r.products.length} products from ChannelEngine`),console.log("Fetching enrichment data from Google Sheets...");let n=await $();console.log(`Fetched ${n.size} products from Google Sheets for enrichment`),console.log("Loading existing products from database...");let a=await t.getAllProducts(),s=new Map(a.map(l=>[l.sku,l]));console.log(`Found ${a.length} existing products`),console.log("Building product records...");let o=F(r,n,s);console.log(`Built ${o.length} product records`),console.log("Saving to database..."),await t.batchPutProducts(o),console.log("Data sync complete");let i=o.filter(l=>n.has(l.sku)).length,d=o.filter(l=>l.costPrice>0).length,p={totalProducts:o.length,fromChannelEngine:r.products.length,enrichedFromSheet:i,withSalesData:r.salesMap.size,withCostData:d,newProducts:o.filter(l=>!s.has(l.sku)).length,updatedProducts:o.filter(l=>s.has(l.sku)).length};console.log("Sync summary:",p)}catch(r){throw console.error("Data sync failed:",r),r}}async function L(){let c=process.env.CHANNEL_ENGINE_SECRET_ARN;if(!c)throw new Error("CHANNEL_ENGINE_SECRET_ARN not configured - ChannelEngine is required as primary data source");console.log("[CE] Initializing ChannelEngine service...");let e=await k(c);console.log("[CE] Fetching products...");let t=await e.fetchProducts();return console.log(`[CE] Fetched ${t.length} products`),console.log("[CE] Skipping sales metrics fetch (performance optimization)"),{products:t,salesMap:new Map}}async function $(){let c=process.env.GOOGLE_SHEETS_SECRET_ARN;if(!c)return console.warn("GOOGLE_SHEETS_SECRET_ARN not configured - skipping Sheets enrichment"),new Map;try{let t=await(await v(c)).fetchProducts(),r=new Map;for(let n of t)n.productSku&&r.set(n.productSku,n);return r}catch(e){return console.error("Google Sheets fetch failed:",e),new Map}}function F(c,e,t){let r=new Date().toISOString(),n=[];for(let a of c.products){let s=a.merchantProductNo,o=t.get(s),i=e.get(s),d=c.salesMap.get(s),p=i?{amazon:i.amazonPricing||void 0,ebay:i.ebayPricing||void 0,bandq:i.bandqPricing||void 0,manomano:i.manoManoPricing||void 0,shopify:i.shopifyPricing||void 0}:void 0,l=[i?.amazonPricing,i?.ebayPricing,i?.bandqPricing,i?.manoManoPricing,i?.shopifyPricing].filter(w=>w!==void 0&&w>0),m=l.length>0?l[0]:a.price,g={sku:s,title:a.name||s,brand:i?.brandName||a.brand||"",category:a.categoryTrail,balterleySku:i?.balterleySku||o?.balterleySku,familyVariants:i?.familyVariants||o?.familyVariants,mrp:i?.mrp||o?.mrp||0,currentPrice:m,channelPrices:p,discountPrice:i?.discountPrice,discountStartDate:i?.discountStartDate,discountEndDate:i?.discountEndDate,costPrice:o?.costPrice||0,deliveryCost:o?.deliveryCost||0,stockLevel:a.stock,stockLastUpdated:r,salesLast7Days:d?.salesLast7Days||0,salesLast30Days:d?.salesLast30Days||0,salesLastUpdated:d?r:o?.salesLastUpdated,lastUpdated:r,lastSyncedFromSheet:i?r:o?.lastSyncedFromSheet,lastSyncedFromChannelEngine:r};n.push(g)}return n}0&&(module.exports={handler});
//# sourceMappingURL=index.js.map
