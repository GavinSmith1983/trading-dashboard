"use strict";var x=Object.create;var f=Object.defineProperty;var D=Object.getOwnPropertyDescriptor;var N=Object.getOwnPropertyNames;var M=Object.getPrototypeOf,$=Object.prototype.hasOwnProperty;var B=(i,e)=>{for(var t in e)f(i,t,{get:e[t],enumerable:!0})},v=(i,e,t,r)=>{if(e&&typeof e=="object"||typeof e=="function")for(let n of N(e))!$.call(i,n)&&n!==t&&f(i,n,{get:()=>e[n],enumerable:!(r=D(e,n))||r.enumerable});return i};var O=(i,e,t)=>(t=i!=null?x(M(i)):{},v(e||!i||!i.__esModule?f(t,"default",{value:i,enumerable:!0}):t,i)),_=i=>v(f({},"__esModule",{value:!0}),i);var U={};B(U,{handler:()=>F});module.exports=_(U);var E=require("uuid");var S={amazon:{channelId:"amazon",name:"Amazon UK",isActive:!0,commissionPercent:15,fixedFee:0,paymentProcessingPercent:0,defaultAcosPercent:15,includeAdvertisingInMargin:!0,vatPercent:20,pricesIncludeVat:!0},ebay:{channelId:"ebay",name:"eBay UK",isActive:!0,commissionPercent:12.8,fixedFee:.3,paymentProcessingPercent:0,defaultAcosPercent:10,includeAdvertisingInMargin:!0,vatPercent:20,pricesIncludeVat:!0},bandq:{channelId:"bandq",name:"B&Q",isActive:!0,commissionPercent:15,fixedFee:0,paymentProcessingPercent:0,defaultAcosPercent:0,includeAdvertisingInMargin:!1,vatPercent:20,pricesIncludeVat:!0},manomano:{channelId:"manomano",name:"ManoMano",isActive:!0,commissionPercent:15,fixedFee:0,paymentProcessingPercent:0,defaultAcosPercent:10,includeAdvertisingInMargin:!0,vatPercent:20,pricesIncludeVat:!0},shopify:{channelId:"shopify",name:"Shopify (Direct)",isActive:!0,commissionPercent:0,fixedFee:0,paymentProcessingPercent:2.9,defaultAcosPercent:5,includeAdvertisingInMargin:!0,vatPercent:20,pricesIncludeVat:!0}};var b={minimumMarginPercent:15,maximumDiscountPercent:50,defaultRoundingRule:"nearest_99p",calculateWithVat:!0,includeAdvertisingInMargin:!0};function T(i,e,t,r,n,s,a,c,g){let l=1+c/100,m=g?i/l:i,u=g?i-m:0,d=i*(r/100),p=i*(s/100),P=i*(a/100),h=e+t+d+n+p+P,V=m-h+u,w=i-h,R=w/i*100;return{sellingPrice:i,vatAmount:u,priceExVat:m,costPrice:e,deliveryCost:t,channelCommission:d,channelFixedFee:n,paymentProcessing:p,advertisingCost:P,totalCosts:h,netProfit:w,marginPercent:R}}var L=require("googleapis");var I=require("uuid"),C=class{config;rules;channels;constructor(e=b,t=[],r=[]){this.config=e,this.rules=t.sort((n,s)=>n.priority-s.priority),this.channels=new Map(r.map(n=>[n.channelId,n]))}calculatePrice(e,t="amazon"){let r=this.channels.get(t);if(!r)throw new Error(`Channel ${t} not configured`);let n=[];(!e.costPrice||e.costPrice<=0)&&n.push("Missing cost price - cannot calculate accurate margin");let s=this.calculateCostBreakdown(e,e.currentPrice,r),a=this.findApplicableRule(e,s),c=e.currentPrice,g="No rule applied - price unchanged";if(a){let h=this.applyRule(a,e,r);c=h.price,g=h.reason}c=this.applyRounding(c,this.config.defaultRoundingRule);let l=this.calculateFloorPrice(e,r),m=!1;c<l&&(c=this.applyRounding(l,this.config.defaultRoundingRule),n.push(`Price raised to floor (${this.config.minimumMarginPercent}% minimum margin)`),m=!0);let u=e.mrp,d=!1;c>u&&(c=u,n.push("Price capped at MRP"),d=!0);let p=this.calculateCostBreakdown(e,c,r),P=p.marginPercent<this.config.minimumMarginPercent;return P&&!m&&n.push(`Margin (${p.marginPercent.toFixed(1)}%) below minimum (${this.config.minimumMarginPercent}%)`),{sku:e.sku,currentPrice:e.currentPrice,proposedPrice:c,priceChange:c-e.currentPrice,priceChangePercent:e.currentPrice>0?(c-e.currentPrice)/e.currentPrice*100:0,currentMargin:s.marginPercent,proposedMargin:p.marginPercent,marginChange:p.marginPercent-s.marginPercent,currentProfit:s.netProfit,proposedProfit:p.netProfit,costBreakdown:p,appliedRule:a?.name,reason:g,warnings:n,belowMinimumMargin:P,atFloorPrice:m,atCeilingPrice:d}}calculateCostBreakdown(e,t,r){let n=r.includeAdvertisingInMargin&&r.defaultAcosPercent||0;return T(t,e.costPrice||0,e.deliveryCost||0,r.commissionPercent,r.fixedFee||0,r.paymentProcessingPercent||0,n,r.vatPercent,r.pricesIncludeVat)}findApplicableRule(e,t){for(let r of this.rules)if(r.isActive&&this.ruleMatches(r,e,t))return r}ruleMatches(e,t,r){let n=e.conditions;return!(n.brands&&n.brands.length>0&&!n.brands.includes(t.brand)||n.categories&&n.categories.length>0&&(!t.category||!n.categories.includes(t.category))||n.skus&&n.skus.length>0&&!n.skus.includes(t.sku)||n.skuPatterns&&n.skuPatterns.length>0&&!n.skuPatterns.some(a=>new RegExp(a).test(t.sku))||n.marginBelow!==void 0&&r.marginPercent>=n.marginBelow||n.marginAbove!==void 0&&r.marginPercent<=n.marginAbove||n.stockBelow!==void 0&&t.stockLevel>=n.stockBelow||n.stockAbove!==void 0&&t.stockLevel<=n.stockAbove||n.salesVelocityBelow!==void 0&&t.salesLast7Days>=n.salesVelocityBelow||n.salesVelocityAbove!==void 0&&t.salesLast7Days<=n.salesVelocityAbove||n.priceBelow!==void 0&&t.currentPrice>=n.priceBelow||n.priceAbove!==void 0&&t.currentPrice<=n.priceAbove)}applyRule(e,t,r){let n=e.action;switch(n.type){case"set_margin":{let s=n.value/100,a=(r.commissionPercent+(r.paymentProcessingPercent||0)+(r.defaultAcosPercent||0))/100,c=(t.costPrice||0)+(t.deliveryCost||0)+(r.fixedFee||0),g=1-a-s;return g<=0?{price:t.currentPrice,reason:`Cannot achieve ${n.value}% margin - costs too high`}:{price:c/g,reason:`Set to achieve ${n.value}% margin (rule: ${e.name})`}}case"set_markup":return{price:(t.costPrice||0)*n.value,reason:`Applied ${n.value}x markup on cost (rule: ${e.name})`};case"adjust_percent":{let s=t.currentPrice*(1+n.value/100),a=n.value>=0?"increase":"decrease";return{price:s,reason:`${Math.abs(n.value)}% ${a} (rule: ${e.name})`}}case"adjust_fixed":{let s=t.currentPrice+n.value,a=n.value>=0?"increase":"decrease";return{price:s,reason:`\xA3${Math.abs(n.value).toFixed(2)} ${a} (rule: ${e.name})`}}case"set_price":return{price:n.value,reason:`Set to fixed price \xA3${n.value.toFixed(2)} (rule: ${e.name})`};case"match_mrp":return{price:t.mrp,reason:`Set to MRP (rule: ${e.name})`};case"discount_from_mrp":return{price:t.mrp*(1-n.value/100),reason:`${n.value}% discount from MRP (rule: ${e.name})`};default:return{price:t.currentPrice,reason:"Unknown action type"}}}calculateFloorPrice(e,t){let r=this.config.minimumMarginPercent/100,n=(t.commissionPercent+(t.paymentProcessingPercent||0)+(t.defaultAcosPercent||0))/100,s=(e.costPrice||0)+(e.deliveryCost||0)+(t.fixedFee||0),a=1-n-r;return a<=0?e.currentPrice:s/a}applyRounding(e,t){switch(t){case"nearest_99p":return Math.floor(e)+.99;case"nearest_95p":return Math.floor(e)+.95;case"nearest_pound":return Math.round(e);case"round_down":return Math.floor(e*100)/100;case"round_up":return Math.ceil(e*100)/100;case"none":default:return Math.round(e*100)/100}}generateProposals(e,t){let r=[];for(let n of e){let s=this.calculatePrice(n);if(Math.abs(s.priceChange)<.01)continue;let a={proposalId:(0,I.v4)(),sku:n.sku,productTitle:n.title,brand:n.brand,category:n.category,currentPrice:s.currentPrice,proposedPrice:s.proposedPrice,priceChange:s.priceChange,priceChangePercent:s.priceChangePercent,currentMargin:s.currentMargin,proposedMargin:s.proposedMargin,marginChange:s.marginChange,costBreakdown:s.costBreakdown,stockLevel:n.stockLevel,salesLast7Days:n.salesLast7Days,salesLast30Days:n.salesLast30Days,appliedRuleName:s.appliedRule,reason:s.reason,warnings:s.warnings,status:"pending",createdAt:new Date().toISOString(),batchId:t,ttl:Math.floor(Date.now()/1e3)+30*24*60*60};r.push(a)}return r}};var A=require("@aws-sdk/client-dynamodb"),o=require("@aws-sdk/lib-dynamodb"),y=class{docClient;productsTable;rulesTable;proposalsTable;channelsTable;ordersTable;constructor(e){let t=new A.DynamoDBClient({});this.docClient=o.DynamoDBDocumentClient.from(t,{marshallOptions:{removeUndefinedValues:!0}}),this.productsTable=e.productsTable,this.rulesTable=e.rulesTable,this.proposalsTable=e.proposalsTable,this.channelsTable=e.channelsTable,this.ordersTable=e.ordersTable||"repricing-orders"}async getProduct(e){return(await this.docClient.send(new o.GetCommand({TableName:this.productsTable,Key:{sku:e}}))).Item||null}async putProduct(e){await this.docClient.send(new o.PutCommand({TableName:this.productsTable,Item:{...e,lastUpdated:new Date().toISOString()}}))}async getAllProducts(){let e=[],t;do{let r=await this.docClient.send(new o.ScanCommand({TableName:this.productsTable,ExclusiveStartKey:t}));r.Items&&e.push(...r.Items),t=r.LastEvaluatedKey}while(t);return e}async batchPutProducts(e){let t=new Date().toISOString(),r=this.chunkArray(e,25);for(let n of r)await this.docClient.send(new o.BatchWriteCommand({RequestItems:{[this.productsTable]:n.map(s=>({PutRequest:{Item:{...s,lastUpdated:t}}}))}}))}async getProductsByBrand(e){return(await this.docClient.send(new o.QueryCommand({TableName:this.productsTable,IndexName:"by-brand",KeyConditionExpression:"brand = :brand",ExpressionAttributeValues:{":brand":e}}))).Items||[]}async getRule(e){return(await this.docClient.send(new o.GetCommand({TableName:this.rulesTable,Key:{ruleId:e}}))).Item||null}async putRule(e){await this.docClient.send(new o.PutCommand({TableName:this.rulesTable,Item:{...e,updatedAt:new Date().toISOString()}}))}async getAllRules(){return((await this.docClient.send(new o.ScanCommand({TableName:this.rulesTable}))).Items||[]).sort((t,r)=>t.priority-r.priority)}async deleteRule(e){let{DeleteCommand:t}=await import("@aws-sdk/lib-dynamodb");await this.docClient.send(new t({TableName:this.rulesTable,Key:{ruleId:e}}))}async getProposal(e){return(await this.docClient.send(new o.GetCommand({TableName:this.proposalsTable,Key:{proposalId:e}}))).Item||null}async putProposal(e){await this.docClient.send(new o.PutCommand({TableName:this.proposalsTable,Item:e}))}async batchPutProposals(e){let t=this.chunkArray(e,25);for(let r of t)await this.docClient.send(new o.BatchWriteCommand({RequestItems:{[this.proposalsTable]:r.map(n=>({PutRequest:{Item:n}}))}}))}async getProposalsByStatus(e){return(await this.docClient.send(new o.QueryCommand({TableName:this.proposalsTable,IndexName:"by-status",KeyConditionExpression:"#status = :status",ExpressionAttributeNames:{"#status":"status"},ExpressionAttributeValues:{":status":e},ScanIndexForward:!1}))).Items||[]}async queryProposals(e,t=1,r=50){let n=[],s={},a={};if(e.status){let d=Array.isArray(e.status)?e.status:[e.status];d.length===1&&(n.push("#status = :status"),s["#status"]="status",a[":status"]=d[0])}e.brand&&(n.push("brand = :brand"),a[":brand"]=e.brand),e.batchId&&(n.push("batchId = :batchId"),a[":batchId"]=e.batchId),e.hasWarnings&&(n.push("size(warnings) > :zero"),a[":zero"]=0);let g=(await this.docClient.send(new o.ScanCommand({TableName:this.proposalsTable,FilterExpression:n.length>0?n.join(" AND "):void 0,ExpressionAttributeNames:Object.keys(s).length>0?s:void 0,ExpressionAttributeValues:Object.keys(a).length>0?a:void 0}))).Items||[];if(e.searchTerm){let d=e.searchTerm.toLowerCase();g=g.filter(p=>p.sku.toLowerCase().includes(d)||p.productTitle.toLowerCase().includes(d))}g.sort((d,p)=>new Date(p.createdAt).getTime()-new Date(d.createdAt).getTime());let l=g.length,m=(t-1)*r;return{items:g.slice(m,m+r),totalCount:l,page:t,pageSize:r,hasMore:m+r<l}}async updateProposalStatus(e,t,r,n,s){let a=["#status = :status","reviewedAt = :reviewedAt","reviewedBy = :reviewedBy"],c={"#status":"status"},g={":status":t,":reviewedAt":new Date().toISOString(),":reviewedBy":r};n&&(a.push("reviewNotes = :notes"),g[":notes"]=n),s!==void 0&&(a.push("approvedPrice = :approvedPrice"),g[":approvedPrice"]=s),await this.docClient.send(new o.UpdateCommand({TableName:this.proposalsTable,Key:{proposalId:e},UpdateExpression:`SET ${a.join(", ")}`,ExpressionAttributeNames:c,ExpressionAttributeValues:g}))}async getChannel(e){return(await this.docClient.send(new o.GetCommand({TableName:this.channelsTable,Key:{channelId:e}}))).Item||null}async putChannel(e){await this.docClient.send(new o.PutCommand({TableName:this.channelsTable,Item:{...e,lastUpdated:new Date().toISOString()}}))}async getAllChannels(){return(await this.docClient.send(new o.ScanCommand({TableName:this.channelsTable}))).Items||[]}async batchPutOrders(e){let t=this.chunkArray(e,25);for(let r of t)await this.docClient.send(new o.BatchWriteCommand({RequestItems:{[this.ordersTable]:r.map(n=>({PutRequest:{Item:n}}))}}))}async getOrdersByDate(e){return(await this.docClient.send(new o.QueryCommand({TableName:this.ordersTable,IndexName:"by-date",KeyConditionExpression:"orderDateDay = :dateDay",ExpressionAttributeValues:{":dateDay":e}}))).Items||[]}async getOrdersByChannel(e,t,r){return(await this.docClient.send(new o.QueryCommand({TableName:this.ordersTable,IndexName:"by-channel",KeyConditionExpression:"channelName = :channel AND orderDate BETWEEN :fromDate AND :toDate",ExpressionAttributeValues:{":channel":e,":fromDate":t,":toDate":r}}))).Items||[]}async getOrderCount(){return(await this.docClient.send(new o.ScanCommand({TableName:this.ordersTable,Select:"COUNT"}))).Count||0}chunkArray(e,t){let r=[];for(let n=0;n<e.length;n+=t)r.push(e.slice(n,n+t));return r}};function k(){return new y({productsTable:process.env.PRODUCTS_TABLE||"repricing-products",rulesTable:process.env.PRICING_RULES_TABLE||"repricing-rules",proposalsTable:process.env.PRICE_PROPOSALS_TABLE||"repricing-proposals",channelsTable:process.env.CHANNEL_CONFIG_TABLE||"repricing-channels",ordersTable:process.env.ORDERS_TABLE||"repricing-orders"})}async function F(i,e){console.log("Starting price calculation",{event:i,requestId:e.awsRequestId});let t=k(),r=(0,E.v4)();try{console.log("Loading products...");let n=await t.getAllProducts();console.log(`Loaded ${n.length} products`);let s=n.filter(u=>u.costPrice>0);if(console.log(`${s.length} products have cost data`),s.length===0){console.warn("No products with cost data - skipping price calculation");return}console.log("Loading pricing rules...");let a=await t.getAllRules();console.log(`Loaded ${a.length} pricing rules`),console.log("Loading channel configuration...");let c=await t.getAllChannels();if(c.length===0){console.log("No channels configured - initializing defaults");let u=Object.values(S).map(d=>({...d,lastUpdated:new Date().toISOString()}));for(let d of u)await t.putChannel(d);c=u}let g=new C(b,a,c);console.log("Generating price proposals...");let l=g.generateProposals(s,r);if(console.log(`Generated ${l.length} proposals`),l.length===0){console.log("No price changes proposed");return}console.log("Saving proposals..."),await t.batchPutProposals(l),console.log("Proposals saved");let m={batchId:r,totalProducts:n.length,productsWithCosts:s.length,proposalsGenerated:l.length,priceIncreases:l.filter(u=>u.priceChange>0).length,priceDecreases:l.filter(u=>u.priceChange<0).length,avgPriceChange:l.length>0?l.reduce((u,d)=>u+d.priceChangePercent,0)/l.length:0,avgMarginChange:l.length>0?l.reduce((u,d)=>u+d.marginChange,0)/l.length:0,proposalsWithWarnings:l.filter(u=>u.warnings.length>0).length};console.log("Calculation summary:",m),console.log(`Price proposals ready for review. Batch ID: ${r}`)}catch(n){throw console.error("Price calculation failed:",n),n}}0&&(module.exports={handler});
//# sourceMappingURL=index.js.map
