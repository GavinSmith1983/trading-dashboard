"use strict";var R=Object.create;var f=Object.defineProperty;var D=Object.getOwnPropertyDescriptor;var N=Object.getOwnPropertyNames;var x=Object.getPrototypeOf,O=Object.prototype.hasOwnProperty;var L=(u,e)=>{for(var t in e)f(u,t,{get:e[t],enumerable:!0})},v=(u,e,t,r)=>{if(e&&typeof e=="object"||typeof e=="function")for(let n of N(e))!O.call(u,n)&&n!==t&&f(u,n,{get:()=>e[n],enumerable:!(r=D(e,n))||r.enumerable});return u};var S=(u,e,t)=>(t=u!=null?R(x(u)):{},v(e||!u||!u.__esModule?f(t,"default",{value:u,enumerable:!0}):t,u)),M=u=>v(f({},"__esModule",{value:!0}),u);var _={};L(_,{handler:()=>V});module.exports=M(_);var $=require("googleapis");var C=class{apiKey;tenantId;baseUrl;constructor(e){this.apiKey=e.apiKey,this.tenantId=e.tenantId,this.baseUrl=e.baseUrl||"https://api.channelengine.net/api/v2"}async request(e,t="GET",r,n={}){let s=new URLSearchParams;s.set("apikey",this.apiKey);for(let[o,l]of Object.entries(n))s.set(o,String(l));let a=`${this.baseUrl}${e}?${s.toString()}`,i=await fetch(a,{method:t,headers:{"Content-Type":"application/json",Accept:"application/json"},body:r?JSON.stringify(r):void 0});if(!i.ok){let o=await i.text();throw new Error(`ChannelEngine API error: ${i.status} ${i.statusText} - ${o}`)}return i.json()}async fetchProducts(e){let t=[],r=1,n=100,s=!0,a=0;for(console.log(`[CE] Starting product fetch from ${this.baseUrl}/products`);s;){console.log(`[CE] Fetching page ${r}...`);try{let i=await this.request("/products","GET",void 0,{page:r,pageSize:n});if(a=i.TotalCount||a,i.Content&&i.Content.length>0){let o=[];for(let l of i.Content)o.push({merchantProductNo:l.MerchantProductNo,name:l.Name,description:l.Description,brand:l.Brand,ean:l.Ean,stock:l.Stock,price:l.Price,categoryTrail:l.CategoryTrail});t.push(...o),console.log(`[CE] Page ${r}: Got ${o.length} products (${t.length}/${a})`),e&&await e(o,r,a),r++,s=i.Content.length===n}else console.log(`[CE] Page ${r}: No more products`),s=!1}catch(i){throw console.error(`[CE] Error fetching page ${r}:`,i),i}}return console.log(`[CE] Completed: Fetched ${t.length} total products`),t}async fetchSalesData(e,t){let r=new Map,n=1,s=100,a=!0,i=e.toISOString(),o=t.toISOString();for(;a;){let l=await this.request("/orders","GET",void 0,{fromDate:i,toDate:o,page:n,pageSize:s});if(l.Content&&l.Content.length>0){for(let h of l.Content)if(h.Lines)for(let P of h.Lines){let m=r.get(P.MerchantProductNo)||{quantity:0,revenue:0};m.quantity+=P.Quantity,m.revenue+=P.UnitPriceInclVat*P.Quantity,r.set(P.MerchantProductNo,m)}n++,a=l.Content.length===s}else a=!1}return r}async fetchSalesMetrics(){let e=new Date,t=new Date(e.getTime()-7*24*60*60*1e3),r=new Date(e.getTime()-30*24*60*60*1e3),[n,s]=await Promise.all([this.fetchSalesData(t,e),this.fetchSalesData(r,e)]),a=new Set([...n.keys(),...s.keys()]);return Array.from(a).map(i=>({merchantProductNo:i,salesLast7Days:n.get(i)?.quantity||0,salesLast30Days:s.get(i)?.quantity||0}))}async fetchOrders(e,t){let r=[],n=1,s=100,a=!0,i=0,o=e.toISOString();for(console.log(`[CE] Starting order fetch from ${o}`);a;){console.log(`[CE] Fetching orders page ${n}...`);try{let l=await this.request("/orders","GET",void 0,{fromDate:o,page:n,pageSize:s});i=l.TotalCount||i,l.Content&&l.Content.length>0?(r.push(...l.Content),console.log(`[CE] Page ${n}: Got ${l.Content.length} orders (${r.length}/${i})`),t&&await t(l.Content,n,i),n++,a=l.Content.length===s):(console.log(`[CE] Page ${n}: No more orders`),a=!1)}catch(l){throw console.error(`[CE] Error fetching orders page ${n}:`,l),l}}return console.log(`[CE] Completed: Fetched ${r.length} total orders`),r}async updatePrices(e){let t=[];for(let n=0;n<e.length;n+=100){let s=e.slice(n,n+100);try{let a=s.map(o=>({MerchantProductNo:o.merchantProductNo,Price:o.price})),i=await this.request("/products/bulk","PUT",a);i.Success||t.push(`Batch ${n/100+1}: ${i.Message}`)}catch(a){t.push(`Batch ${n/100+1}: ${a instanceof Error?a.message:"Unknown error"}`)}}return{success:t.length===0,errors:t}}async updateStock(e){let t=[];for(let n=0;n<e.length;n+=100){let s=e.slice(n,n+100);try{let a=s.map(o=>({MerchantProductNo:o.merchantProductNo,Stock:o.stock})),i=await this.request("/offer/stock","PUT",a);i.Success||t.push(`Batch ${n/100+1}: ${i.Message}`)}catch(a){t.push(`Batch ${n/100+1}: ${a instanceof Error?a.message:"Unknown error"}`)}}return{success:t.length===0,errors:t}}};async function T(u){let{SecretsManagerClient:e,GetSecretValueCommand:t}=await import("@aws-sdk/client-secrets-manager"),n=await new e({}).send(new t({SecretId:u}));if(!n.SecretString)throw new Error("ChannelEngine secret not found");let s=JSON.parse(n.SecretString);return new C({apiKey:s.apiKey,tenantId:s.tenantId,baseUrl:s.baseUrl})}var B=require("uuid");var I=require("@aws-sdk/client-dynamodb"),c=require("@aws-sdk/lib-dynamodb"),y=class{docClient;productsTable;rulesTable;proposalsTable;channelsTable;ordersTable;orderLinesTable;constructor(e){let t=new I.DynamoDBClient({});this.docClient=c.DynamoDBDocumentClient.from(t,{marshallOptions:{removeUndefinedValues:!0}}),this.productsTable=e.productsTable,this.rulesTable=e.rulesTable,this.proposalsTable=e.proposalsTable,this.channelsTable=e.channelsTable,this.ordersTable=e.ordersTable||"repricing-orders",this.orderLinesTable=e.orderLinesTable||"repricing-order-lines"}async getProduct(e){return(await this.docClient.send(new c.GetCommand({TableName:this.productsTable,Key:{sku:e}}))).Item||null}async putProduct(e){await this.docClient.send(new c.PutCommand({TableName:this.productsTable,Item:{...e,lastUpdated:new Date().toISOString()}}))}async getAllProducts(){let e=[],t;do{let r=await this.docClient.send(new c.ScanCommand({TableName:this.productsTable,ExclusiveStartKey:t}));r.Items&&e.push(...r.Items),t=r.LastEvaluatedKey}while(t);return e}async batchPutProducts(e){let t=new Date().toISOString(),r=this.chunkArray(e,25);for(let n of r)await this.docClient.send(new c.BatchWriteCommand({RequestItems:{[this.productsTable]:n.map(s=>({PutRequest:{Item:{...s,lastUpdated:t}}}))}}))}async getProductsByBrand(e){return(await this.docClient.send(new c.QueryCommand({TableName:this.productsTable,IndexName:"by-brand",KeyConditionExpression:"brand = :brand",ExpressionAttributeValues:{":brand":e}}))).Items||[]}async getRule(e){return(await this.docClient.send(new c.GetCommand({TableName:this.rulesTable,Key:{ruleId:e}}))).Item||null}async putRule(e){await this.docClient.send(new c.PutCommand({TableName:this.rulesTable,Item:{...e,updatedAt:new Date().toISOString()}}))}async getAllRules(){return((await this.docClient.send(new c.ScanCommand({TableName:this.rulesTable}))).Items||[]).sort((t,r)=>t.priority-r.priority)}async deleteRule(e){let{DeleteCommand:t}=await import("@aws-sdk/lib-dynamodb");await this.docClient.send(new t({TableName:this.rulesTable,Key:{ruleId:e}}))}async getProposal(e){return(await this.docClient.send(new c.GetCommand({TableName:this.proposalsTable,Key:{proposalId:e}}))).Item||null}async putProposal(e){await this.docClient.send(new c.PutCommand({TableName:this.proposalsTable,Item:e}))}async batchPutProposals(e){let t=this.chunkArray(e,25);for(let r of t)await this.docClient.send(new c.BatchWriteCommand({RequestItems:{[this.proposalsTable]:r.map(n=>({PutRequest:{Item:n}}))}}))}async getProposalsByStatus(e){return(await this.docClient.send(new c.QueryCommand({TableName:this.proposalsTable,IndexName:"by-status",KeyConditionExpression:"#status = :status",ExpressionAttributeNames:{"#status":"status"},ExpressionAttributeValues:{":status":e},ScanIndexForward:!1}))).Items||[]}async queryProposals(e,t=1,r=50){let n=[],s={},a={};if(e.status){let m=Array.isArray(e.status)?e.status:[e.status];m.length===1&&(n.push("#status = :status"),s["#status"]="status",a[":status"]=m[0])}e.brand&&(n.push("brand = :brand"),a[":brand"]=e.brand),e.batchId&&(n.push("batchId = :batchId"),a[":batchId"]=e.batchId),e.hasWarnings&&(n.push("size(warnings) > :zero"),a[":zero"]=0);let o=(await this.docClient.send(new c.ScanCommand({TableName:this.proposalsTable,FilterExpression:n.length>0?n.join(" AND "):void 0,ExpressionAttributeNames:Object.keys(s).length>0?s:void 0,ExpressionAttributeValues:Object.keys(a).length>0?a:void 0}))).Items||[];if(e.searchTerm){let m=e.searchTerm.toLowerCase();o=o.filter(p=>p.sku.toLowerCase().includes(m)||p.productTitle.toLowerCase().includes(m))}o.sort((m,p)=>new Date(p.createdAt).getTime()-new Date(m.createdAt).getTime());let l=o.length,h=(t-1)*r;return{items:o.slice(h,h+r),totalCount:l,page:t,pageSize:r,hasMore:h+r<l}}async updateProposalStatus(e,t,r,n,s){let a=["#status = :status","reviewedAt = :reviewedAt","reviewedBy = :reviewedBy"],i={"#status":"status"},o={":status":t,":reviewedAt":new Date().toISOString(),":reviewedBy":r};n&&(a.push("reviewNotes = :notes"),o[":notes"]=n),s!==void 0&&(a.push("approvedPrice = :approvedPrice"),o[":approvedPrice"]=s),await this.docClient.send(new c.UpdateCommand({TableName:this.proposalsTable,Key:{proposalId:e},UpdateExpression:`SET ${a.join(", ")}`,ExpressionAttributeNames:i,ExpressionAttributeValues:o}))}async getChannel(e){return(await this.docClient.send(new c.GetCommand({TableName:this.channelsTable,Key:{channelId:e}}))).Item||null}async putChannel(e){await this.docClient.send(new c.PutCommand({TableName:this.channelsTable,Item:{...e,lastUpdated:new Date().toISOString()}}))}async getAllChannels(){return(await this.docClient.send(new c.ScanCommand({TableName:this.channelsTable}))).Items||[]}async batchPutOrders(e){let t=this.chunkArray(e,25);for(let r of t)await this.docClient.send(new c.BatchWriteCommand({RequestItems:{[this.ordersTable]:r.map(n=>({PutRequest:{Item:n}}))}}))}async batchPutOrderLines(e){let t=this.chunkArray(e,25);for(let r of t)await this.docClient.send(new c.BatchWriteCommand({RequestItems:{[this.orderLinesTable]:r.map(n=>({PutRequest:{Item:n}}))}}))}async getOrderLinesBySku(e,t,r){let n="sku = :sku",s={":sku":e};return t&&r?(n+=" AND orderDate BETWEEN :fromDate AND :toDate",s[":fromDate"]=t,s[":toDate"]=r):t&&(n+=" AND orderDate >= :fromDate",s[":fromDate"]=t),(await this.docClient.send(new c.QueryCommand({TableName:this.orderLinesTable,IndexName:"by-sku",KeyConditionExpression:n,ExpressionAttributeValues:s}))).Items||[]}async getOrderLinesByDate(e){return(await this.docClient.send(new c.QueryCommand({TableName:this.orderLinesTable,IndexName:"by-date",KeyConditionExpression:"orderDateDay = :dateDay",ExpressionAttributeValues:{":dateDay":e}}))).Items||[]}async getOrderLinesByChannelAndDate(e,t,r){return(await this.docClient.send(new c.QueryCommand({TableName:this.orderLinesTable,IndexName:"by-channel-date",KeyConditionExpression:"channelName = :channel AND orderDate BETWEEN :fromDate AND :toDate",ExpressionAttributeValues:{":channel":e,":fromDate":t,":toDate":r}}))).Items||[]}async getOrderCount(){return(await this.docClient.send(new c.ScanCommand({TableName:this.ordersTable,Select:"COUNT"}))).Count||0}async getOrderLineCount(){return(await this.docClient.send(new c.ScanCommand({TableName:this.orderLinesTable,Select:"COUNT"}))).Count||0}chunkArray(e,t){let r=[];for(let n=0;n<e.length;n+=t)r.push(e.slice(n,n+t));return r}};function E(){return new y({productsTable:process.env.PRODUCTS_TABLE||"repricing-products",rulesTable:process.env.PRICING_RULES_TABLE||"repricing-rules",proposalsTable:process.env.PRICE_PROPOSALS_TABLE||"repricing-proposals",channelsTable:process.env.CHANNEL_CONFIG_TABLE||"repricing-channels",ordersTable:process.env.ORDERS_TABLE||"repricing-orders",orderLinesTable:process.env.ORDER_LINES_TABLE||"repricing-order-lines"})}async function V(u,e){console.log("Starting order sync",{event:u,requestId:e.awsRequestId});let t=E(),r=0,n=0;try{let s;u.fromDate?(s=new Date(u.fromDate),console.log(`[ORDERS] Backfill mode: fetching from ${u.fromDate}`)):(s=new Date,s.setDate(s.getDate()-30),console.log(`[ORDERS] Incremental mode: fetching from ${s.toISOString()}`));let a=process.env.CHANNEL_ENGINE_SECRET_ARN;if(!a)throw new Error("CHANNEL_ENGINE_SECRET_ARN not configured");let i=await T(a),o=new Date().toISOString();await i.fetchOrders(s,async(l,h,P)=>{let m=[],p=[];for(let d of l){let b=d.OrderDate,w=b.substring(0,10),A={orderId:String(d.Id),channelOrderNo:d.ChannelOrderNo,channelName:d.ChannelName||"Unknown",channelId:d.ChannelId,orderDate:b,orderDateDay:w,status:d.Status,subTotalInclVat:d.SubTotalInclVat,subTotalExclVat:d.SubTotalInclVat-d.SubTotalVat,totalVat:d.TotalVat,shippingCostsInclVat:d.ShippingCostsInclVat,totalInclVat:d.TotalInclVat,totalFee:d.TotalFee,currencyCode:d.CurrencyCode,lineCount:d.Lines?.length||0,syncedAt:o};if(m.push(A),d.Lines)for(let g of d.Lines){let k={orderLineId:`${d.Id}#${g.Id}`,orderId:String(d.Id),channelOrderLineNo:g.ChannelOrderLineNo,sku:g.MerchantProductNo||"UNKNOWN",description:g.Description||"",gtin:g.Gtin,quantity:g.Quantity,unitPriceInclVat:g.UnitPriceInclVat,unitPriceExclVat:g.UnitPriceExclVat,lineTotalInclVat:g.LineTotalInclVat,lineTotalExclVat:g.LineTotalExclVat,lineVat:g.LineVat,vatRate:g.VatRate,feeFixed:g.FeeFixed,feeRate:g.FeeRate,shippingMethod:g.ShippingMethod,shippingServiceLevel:g.ShippingServiceLevel,channelName:d.ChannelName||"Unknown",orderDate:b,orderDateDay:w,status:g.Status,syncedAt:o};p.push(k)}}m.length>0&&(await t.batchPutOrders(m),r+=m.length),p.length>0&&(await t.batchPutOrderLines(p),n+=p.length),console.log(`[DB] Saved batch ${h}: ${m.length} orders, ${p.length} lines (${r}/${P} orders saved)`)}),console.log(`[DONE] Order sync complete: ${r} orders, ${n} lines saved`)}catch(s){throw console.error(`[ERROR] Order sync failed after saving ${r} orders, ${n} lines:`,s),s}}0&&(module.exports={handler});
//# sourceMappingURL=index.js.map
