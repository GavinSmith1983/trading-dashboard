"use strict";var B=Object.create;var v=Object.defineProperty;var $=Object.getOwnPropertyDescriptor;var U=Object.getOwnPropertyNames;var G=Object.getPrototypeOf,_=Object.prototype.hasOwnProperty;var F=(a,e)=>{for(var r in e)v(a,r,{get:e[r],enumerable:!0})},E=(a,e,r,t)=>{if(e&&typeof e=="object"||typeof e=="function")for(let n of U(e))!_.call(a,n)&&n!==r&&v(a,n,{get:()=>e[n],enumerable:!(t=$(e,n))||t.enumerable});return a};var S=(a,e,r)=>(r=a!=null?B(G(a)):{},E(e||!a||!a.__esModule?v(r,"default",{value:a,enumerable:!0}):r,a)),L=a=>E(v({},"__esModule",{value:!0}),a);var te={};F(te,{handler:()=>K});module.exports=L(te);function I(a){if(!a||a.trim()==="")return"unknown";let e=a.toLowerCase().trim();return e.startsWith("homefleet")?"homefleet":e.includes("dpd")?"dpd":e.includes("dx")?"dx":e.includes("arrow")?"arrowxl":e.includes("parcelforce")?"parcelforce":e.includes("worthington")?"ak_worthington":e.includes("consolidated")?"consolidated":e.includes("hold delivery")?"hold_delivery":e.replace(/[^a-z0-9]/g,"_").replace(/_+/g,"_").replace(/^_|_$/g,"")}function A(a){return{homefleet:"HomeFleet",dpd:"DPD Logistics",dx:"DX",arrowxl:"ArrowXL",parcelforce:"Parcelforce",ak_worthington:"AK Worthington",consolidated:"Consolidated Delivery",hold_delivery:"Hold Delivery",today_despatch:"Today Despatch",unknown:"Unknown"}[a]||a}function x(a){if(!a)return!0;let e=a.toLowerCase().trim();return!!(e.includes("hold delivery")||e.includes("hold_delivery")||e.includes("consolidated delivery")||e.includes("consolidated")||e.includes("today_despatch")||e.includes("today despatch")||e==="today_despatch")}var q=require("googleapis");var T=class{apiKey;tenantId;baseUrl;constructor(e){this.apiKey=e.apiKey,this.tenantId=e.tenantId,this.baseUrl=e.baseUrl||"https://api.channelengine.net/api/v2"}async request(e,r="GET",t,n={}){let s=new URLSearchParams;s.set("apikey",this.apiKey);for(let[u,l]of Object.entries(n))s.set(u,String(l));let o=`${this.baseUrl}${e}?${s.toString()}`,i=await fetch(o,{method:r,headers:{"Content-Type":"application/json",Accept:"application/json"},body:t?JSON.stringify(t):void 0});if(!i.ok){let u=await i.text();throw new Error(`ChannelEngine API error: ${i.status} ${i.statusText} - ${u}`)}return i.json()}async fetchProducts(e){let r=[],t=1,n=100,s=!0,o=0;for(console.log(`[CE] Starting product fetch from ${this.baseUrl}/products`);s;){console.log(`[CE] Fetching page ${t}...`);try{let i=await this.request("/products","GET",void 0,{page:t,pageSize:n});if(o=i.TotalCount||o,i.Content&&i.Content.length>0){let u=[];for(let l of i.Content)u.push({merchantProductNo:l.MerchantProductNo,name:l.Name,description:l.Description,brand:l.Brand,ean:l.Ean,stock:l.Stock,price:l.Price,categoryTrail:l.CategoryTrail});r.push(...u),console.log(`[CE] Page ${t}: Got ${u.length} products (${r.length}/${o})`),e&&await e(u,t,o),t++,s=i.Content.length===n}else console.log(`[CE] Page ${t}: No more products`),s=!1}catch(i){throw console.error(`[CE] Error fetching page ${t}:`,i),i}}return console.log(`[CE] Completed: Fetched ${r.length} total products`),r}async fetchSalesData(e,r){let t=new Map,n=1,s=100,o=!0,i=e.toISOString(),u=r.toISOString();for(;o;){let l=await this.request("/orders","GET",void 0,{fromDate:i,toDate:u,page:n,pageSize:s});if(l.Content&&l.Content.length>0){for(let g of l.Content)if(g.Lines)for(let P of g.Lines){let h=t.get(P.MerchantProductNo)||{quantity:0,revenue:0};h.quantity+=P.Quantity,h.revenue+=P.UnitPriceInclVat*P.Quantity,t.set(P.MerchantProductNo,h)}n++,o=l.Content.length===s}else o=!1}return t}async fetchSalesMetrics(){let e=new Date,r=new Date(e.getTime()-7*24*60*60*1e3),t=new Date(e.getTime()-30*24*60*60*1e3),[n,s]=await Promise.all([this.fetchSalesData(r,e),this.fetchSalesData(t,e)]),o=new Set([...n.keys(),...s.keys()]);return Array.from(o).map(i=>({merchantProductNo:i,salesLast7Days:n.get(i)?.quantity||0,salesLast30Days:s.get(i)?.quantity||0}))}async fetchOrders(e,r){let t=[],n=1,s=100,o=!0,i=0,u=e.toISOString();for(console.log(`[CE] Starting order fetch from ${u}`);o;){console.log(`[CE] Fetching orders page ${n}...`);try{let l=await this.request("/orders","GET",void 0,{fromDate:u,page:n,pageSize:s});i=l.TotalCount||i,l.Content&&l.Content.length>0?(t.push(...l.Content),console.log(`[CE] Page ${n}: Got ${l.Content.length} orders (${t.length}/${i})`),r&&await r(l.Content,n,i),n++,o=l.Content.length===s):(console.log(`[CE] Page ${n}: No more orders`),o=!1)}catch(l){throw console.error(`[CE] Error fetching orders page ${n}:`,l),l}}return console.log(`[CE] Completed: Fetched ${t.length} total orders`),t}async updatePrices(e){let r=[];for(let n=0;n<e.length;n+=100){let s=e.slice(n,n+100);try{let o=s.map(u=>({MerchantProductNo:u.merchantProductNo,Price:u.price})),i=await this.request("/products/bulk","PUT",o);i.Success||r.push(`Batch ${n/100+1}: ${i.Message}`)}catch(o){r.push(`Batch ${n/100+1}: ${o instanceof Error?o.message:"Unknown error"}`)}}return{success:r.length===0,errors:r}}async updateStock(e){let r=[];for(let n=0;n<e.length;n+=100){let s=e.slice(n,n+100);try{let o=s.map(u=>({MerchantProductNo:u.merchantProductNo,Stock:u.stock})),i=await this.request("/offer/stock","PUT",o);i.Success||r.push(`Batch ${n/100+1}: ${i.Message}`)}catch(o){r.push(`Batch ${n/100+1}: ${o instanceof Error?o.message:"Unknown error"}`)}}return{success:r.length===0,errors:r}}};async function R(a){let{SecretsManagerClient:e,GetSecretValueCommand:r}=await import("@aws-sdk/client-secrets-manager"),n=await new e({}).send(new r({SecretId:a}));if(!n.SecretString)throw new Error("ChannelEngine secret not found");let s=JSON.parse(n.SecretString);return new T({apiKey:s.apiKey,tenantId:s.tenantId,baseUrl:s.baseUrl})}var V=require("uuid");var D=require("@aws-sdk/client-dynamodb"),p=require("@aws-sdk/lib-dynamodb"),k=class{docClient;productsTable;rulesTable;proposalsTable;channelsTable;ordersTable;carrierCostsTable;constructor(e){let r=new D.DynamoDBClient({});this.docClient=p.DynamoDBDocumentClient.from(r,{marshallOptions:{removeUndefinedValues:!0}}),this.productsTable=e.productsTable,this.rulesTable=e.rulesTable,this.proposalsTable=e.proposalsTable,this.channelsTable=e.channelsTable,this.ordersTable=e.ordersTable||"repricing-orders",this.carrierCostsTable=e.carrierCostsTable||"repricing-carrier-costs"}async getProduct(e){return(await this.docClient.send(new p.GetCommand({TableName:this.productsTable,Key:{sku:e}}))).Item||null}async putProduct(e){await this.docClient.send(new p.PutCommand({TableName:this.productsTable,Item:{...e,lastUpdated:new Date().toISOString()}}))}async getAllProducts(){let e=[],r;do{let t=await this.docClient.send(new p.ScanCommand({TableName:this.productsTable,ExclusiveStartKey:r}));t.Items&&e.push(...t.Items),r=t.LastEvaluatedKey}while(r);return e}async batchPutProducts(e){let r=new Date().toISOString(),t=this.chunkArray(e,25);for(let n of t)await this.docClient.send(new p.BatchWriteCommand({RequestItems:{[this.productsTable]:n.map(s=>({PutRequest:{Item:{...s,lastUpdated:r}}}))}}))}async getProductsByBrand(e){return(await this.docClient.send(new p.QueryCommand({TableName:this.productsTable,IndexName:"by-brand",KeyConditionExpression:"brand = :brand",ExpressionAttributeValues:{":brand":e}}))).Items||[]}async getRule(e){return(await this.docClient.send(new p.GetCommand({TableName:this.rulesTable,Key:{ruleId:e}}))).Item||null}async putRule(e){await this.docClient.send(new p.PutCommand({TableName:this.rulesTable,Item:{...e,updatedAt:new Date().toISOString()}}))}async getAllRules(){return((await this.docClient.send(new p.ScanCommand({TableName:this.rulesTable}))).Items||[]).sort((r,t)=>r.priority-t.priority)}async deleteRule(e){let{DeleteCommand:r}=await import("@aws-sdk/lib-dynamodb");await this.docClient.send(new r({TableName:this.rulesTable,Key:{ruleId:e}}))}async getProposal(e){return(await this.docClient.send(new p.GetCommand({TableName:this.proposalsTable,Key:{proposalId:e}}))).Item||null}async putProposal(e){await this.docClient.send(new p.PutCommand({TableName:this.proposalsTable,Item:e}))}async batchPutProposals(e){let r=this.chunkArray(e,25);for(let t of r)await this.docClient.send(new p.BatchWriteCommand({RequestItems:{[this.proposalsTable]:t.map(n=>({PutRequest:{Item:n}}))}}))}async getProposalsByStatus(e){return(await this.docClient.send(new p.QueryCommand({TableName:this.proposalsTable,IndexName:"by-status",KeyConditionExpression:"#status = :status",ExpressionAttributeNames:{"#status":"status"},ExpressionAttributeValues:{":status":e},ScanIndexForward:!1}))).Items||[]}async queryProposals(e,r=1,t=50){let n=[],s={},o={};if(e.status){let h=Array.isArray(e.status)?e.status:[e.status];h.length===1&&(n.push("#status = :status"),s["#status"]="status",o[":status"]=h[0])}e.brand&&(n.push("brand = :brand"),o[":brand"]=e.brand),e.batchId&&(n.push("batchId = :batchId"),o[":batchId"]=e.batchId),e.hasWarnings&&(n.push("size(warnings) > :zero"),o[":zero"]=0);let u=(await this.docClient.send(new p.ScanCommand({TableName:this.proposalsTable,FilterExpression:n.length>0?n.join(" AND "):void 0,ExpressionAttributeNames:Object.keys(s).length>0?s:void 0,ExpressionAttributeValues:Object.keys(o).length>0?o:void 0}))).Items||[];if(e.searchTerm){let h=e.searchTerm.toLowerCase();u=u.filter(f=>f.sku.toLowerCase().includes(h)||f.productTitle.toLowerCase().includes(h))}u.sort((h,f)=>new Date(f.createdAt).getTime()-new Date(h.createdAt).getTime());let l=u.length,g=(r-1)*t;return{items:u.slice(g,g+t),totalCount:l,page:r,pageSize:t,hasMore:g+t<l}}async updateProposalStatus(e,r,t,n,s){let o=["#status = :status","reviewedAt = :reviewedAt","reviewedBy = :reviewedBy"],i={"#status":"status"},u={":status":r,":reviewedAt":new Date().toISOString(),":reviewedBy":t};n&&(o.push("reviewNotes = :notes"),u[":notes"]=n),s!==void 0&&(o.push("approvedPrice = :approvedPrice"),u[":approvedPrice"]=s),await this.docClient.send(new p.UpdateCommand({TableName:this.proposalsTable,Key:{proposalId:e},UpdateExpression:`SET ${o.join(", ")}`,ExpressionAttributeNames:i,ExpressionAttributeValues:u}))}async getChannel(e){return(await this.docClient.send(new p.GetCommand({TableName:this.channelsTable,Key:{channelId:e}}))).Item||null}async putChannel(e){await this.docClient.send(new p.PutCommand({TableName:this.channelsTable,Item:{...e,lastUpdated:new Date().toISOString()}}))}async getAllChannels(){return(await this.docClient.send(new p.ScanCommand({TableName:this.channelsTable}))).Items||[]}async getCarrierCost(e){return(await this.docClient.send(new p.GetCommand({TableName:this.carrierCostsTable,Key:{carrierId:e}}))).Item||null}async putCarrierCost(e){await this.docClient.send(new p.PutCommand({TableName:this.carrierCostsTable,Item:{...e,lastUpdated:new Date().toISOString()}}))}async getAllCarrierCosts(){return(await this.docClient.send(new p.ScanCommand({TableName:this.carrierCostsTable}))).Items||[]}async deleteCarrierCost(e){let{DeleteCommand:r}=await import("@aws-sdk/lib-dynamodb");await this.docClient.send(new r({TableName:this.carrierCostsTable,Key:{carrierId:e}}))}async batchPutCarrierCosts(e){let r=new Date().toISOString(),t=this.chunkArray(e,25);for(let n of t)await this.docClient.send(new p.BatchWriteCommand({RequestItems:{[this.carrierCostsTable]:n.map(s=>({PutRequest:{Item:{...s,lastUpdated:r}}}))}}))}async batchPutOrders(e){let r=this.chunkArray(e,25);for(let t of r)await this.docClient.send(new p.BatchWriteCommand({RequestItems:{[this.ordersTable]:t.map(n=>({PutRequest:{Item:n}}))}}))}async getOrdersByDate(e){return(await this.docClient.send(new p.QueryCommand({TableName:this.ordersTable,IndexName:"by-date",KeyConditionExpression:"orderDateDay = :dateDay",ExpressionAttributeValues:{":dateDay":e}}))).Items||[]}async getOrdersByChannel(e,r,t){return(await this.docClient.send(new p.QueryCommand({TableName:this.ordersTable,IndexName:"by-channel",KeyConditionExpression:"channelName = :channel AND orderDate BETWEEN :fromDate AND :toDate",ExpressionAttributeValues:{":channel":e,":fromDate":r,":toDate":t}}))).Items||[]}async getOrderCount(){return(await this.docClient.send(new p.ScanCommand({TableName:this.ordersTable,Select:"COUNT"}))).Count||0}async getOrder(e){return(await this.docClient.send(new p.GetCommand({TableName:this.ordersTable,Key:{orderId:e}}))).Item||null}async updateOrderDelivery(e,r){await this.docClient.send(new p.UpdateCommand({TableName:this.ordersTable,Key:{orderId:e},UpdateExpression:"SET deliveryCarrier = :carrier, deliveryCarrierRaw = :carrierRaw, deliveryParcels = :parcels, deliveryImportedAt = :importedAt",ExpressionAttributeValues:{":carrier":r.deliveryCarrier,":carrierRaw":r.deliveryCarrierRaw,":parcels":r.deliveryParcels,":importedAt":new Date().toISOString()}}))}async getAllOrders(){let e=[],r;do{let t=await this.docClient.send(new p.ScanCommand({TableName:this.ordersTable,ExclusiveStartKey:r}));t.Items&&e.push(...t.Items),r=t.LastEvaluatedKey}while(r);return e}async getProductLookupMap(){let e=await this.getAllProducts(),r=new Map,t=new Map;for(let n of e)r.set(n.sku.toUpperCase(),n),n.balterleySku&&t.set(n.balterleySku.toUpperCase(),n);return{bySku:r,byBalterleySku:t}}async getSalesBySku(e=7){let r=new Map,t=new Date,n=[];for(let s=0;s<e;s++){let o=new Date(t);o.setDate(o.getDate()-s),n.push(o.toISOString().substring(0,10))}for(let s of n){let o=await this.getOrdersByDate(s);for(let i of o)if(i.lines)for(let u of i.lines){let l=r.get(u.sku)||{quantity:0,revenue:0};l.quantity+=u.quantity,l.revenue+=u.lineTotalInclVat,r.set(u.sku,l)}}return r}chunkArray(e,r){let t=[];for(let n=0;n<e.length;n+=r)t.push(e.slice(n,n+r));return t}};function N(){return new k({productsTable:process.env.PRODUCTS_TABLE||"repricing-products",rulesTable:process.env.PRICING_RULES_TABLE||"repricing-rules",proposalsTable:process.env.PRICE_PROPOSALS_TABLE||"repricing-proposals",channelsTable:process.env.CHANNEL_CONFIG_TABLE||"repricing-channels",ordersTable:process.env.ORDERS_TABLE||"repricing-orders",carrierCostsTable:process.env.CARRIER_COSTS_TABLE||"repricing-carrier-costs"})}var M=require("uuid"),d=N();async function K(a,e){console.log("API request:",{method:a.httpMethod,path:a.path,requestId:e.awsRequestId});try{let r=a.path,t=a.httpMethod;return r.startsWith("/products")?z(a):r.startsWith("/proposals")?W(a):r.startsWith("/rules")?J(a):r.startsWith("/channels")?H(a):r.startsWith("/analytics")?Q(a):r.startsWith("/import")?X(a):r.startsWith("/carriers")?Z(a):r==="/sync"&&t==="POST"?ee(a):c(404,{error:"Not found"})}catch(r){return console.error("API error:",r),c(500,{error:r instanceof Error?r.message:"Internal server error"})}}async function z(a){let e=a.httpMethod,r=a.pathParameters?.sku;if(e==="GET"&&!r){let t=await d.getAllProducts();return c(200,{items:t,count:t.length})}if(e==="GET"&&r){let t=await d.getProduct(r);return t?c(200,t):c(404,{error:"Product not found"})}if(e==="PUT"&&r){let t=JSON.parse(a.body||"{}"),n=await d.getProduct(r);if(!n)return c(404,{error:"Product not found"});let s={...n,costPrice:t.costPrice??n.costPrice,deliveryCost:t.deliveryCost??n.deliveryCost,category:t.category??n.category};return await d.putProduct(s),c(200,s)}return c(405,{error:"Method not allowed"})}async function W(a){let e=a.httpMethod,r=a.path,t=a.pathParameters?.proposalId;if(r.endsWith("/bulk-approve")&&e==="POST"){let n=JSON.parse(a.body||"{}"),s=[];for(let o of n.proposalIds)await d.updateProposalStatus(o,"approved",n.reviewedBy,n.notes),s.push({proposalId:o,status:"approved"});return c(200,{results:s})}if(r.endsWith("/bulk-reject")&&e==="POST"){let n=JSON.parse(a.body||"{}"),s=[];for(let o of n.proposalIds)await d.updateProposalStatus(o,"rejected",n.reviewedBy,n.notes),s.push({proposalId:o,status:"rejected"});return c(200,{results:s})}if(r.endsWith("/push")&&e==="POST")return j(a);if(e==="GET"&&!t){let n=a.queryStringParameters||{},s={status:n.status,batchId:n.batchId,brand:n.brand,searchTerm:n.search,hasWarnings:n.hasWarnings==="true"},o=parseInt(n.page||"1",10),i=parseInt(n.pageSize||"50",10),u=await d.queryProposals(s,o,i);return c(200,u)}if(e==="GET"&&t){let n=await d.getProposal(t);return n?c(200,n):c(404,{error:"Proposal not found"})}if(e==="PUT"&&t){let n=JSON.parse(a.body||"{}"),{action:s,modifiedPrice:o,notes:i,reviewedBy:u}=n;if(!s||!u)return c(400,{error:"action and reviewedBy are required"});let l,g;switch(s){case"approve":l="approved";break;case"reject":l="rejected";break;case"modify":if(o===void 0)return c(400,{error:"modifiedPrice required for modify action"});l="modified",g=o;break;default:return c(400,{error:"Invalid action"})}await d.updateProposalStatus(t,l,u,i,g);let P=await d.getProposal(t);return c(200,P)}return c(405,{error:"Method not allowed"})}async function j(a){let r=JSON.parse(a.body||"{}").dryRun===!0,t=await d.getProposalsByStatus("approved"),n=await d.getProposalsByStatus("modified"),s=[...t,...n];if(s.length===0)return c(200,{message:"No approved proposals to push",count:0});let o=s.map(g=>({merchantProductNo:g.sku,price:g.approvedPrice??g.proposedPrice}));if(r)return c(200,{dryRun:!0,count:o.length,updates:o});let i=process.env.CHANNEL_ENGINE_SECRET_ARN;if(!i)return c(500,{error:"ChannelEngine not configured"});let l=await(await R(i)).updatePrices(o);if(l.success)for(let g of s)await d.updateProposalStatus(g.proposalId,"pushed","system","Pushed to ChannelEngine");return c(200,{success:l.success,pushed:o.length,errors:l.errors})}async function J(a){let e=a.httpMethod,r=a.pathParameters?.ruleId;if(e==="GET"&&!r){let t=await d.getAllRules();return c(200,{items:t,count:t.length})}if(e==="GET"&&r){let t=await d.getRule(r);return t?c(200,t):c(404,{error:"Rule not found"})}if(e==="POST"){let t=JSON.parse(a.body||"{}"),n={ruleId:(0,M.v4)(),name:t.name,description:t.description,priority:t.priority??100,isActive:t.isActive??!0,conditions:t.conditions||{},action:t.action,createdAt:new Date().toISOString(),updatedAt:new Date().toISOString()};return await d.putRule(n),c(201,n)}if(e==="PUT"&&r){let t=await d.getRule(r);if(!t)return c(404,{error:"Rule not found"});let n=JSON.parse(a.body||"{}"),s={...t,name:n.name??t.name,description:n.description??t.description,priority:n.priority??t.priority,isActive:n.isActive??t.isActive,conditions:n.conditions??t.conditions,action:n.action??t.action,updatedAt:new Date().toISOString()};return await d.putRule(s),c(200,s)}return e==="DELETE"&&r?(await d.deleteRule(r),c(204,null)):c(405,{error:"Method not allowed"})}async function H(a){let e=a.httpMethod,r=a.pathParameters?.channelId;if(e==="GET"&&!r){let t=await d.getAllChannels();return c(200,{items:t,count:t.length})}if(e==="GET"&&r){let t=await d.getChannel(r);return t?c(200,t):c(404,{error:"Channel not found"})}if(e==="PUT"&&r){let t=await d.getChannel(r),n=JSON.parse(a.body||"{}"),s={channelId:r,name:n.name??t?.name??r,isActive:n.isActive??t?.isActive??!0,commissionPercent:n.commissionPercent??t?.commissionPercent??0,fixedFee:n.fixedFee??t?.fixedFee,paymentProcessingPercent:n.paymentProcessingPercent??t?.paymentProcessingPercent,defaultAcosPercent:n.defaultAcosPercent??t?.defaultAcosPercent,includeAdvertisingInMargin:n.includeAdvertisingInMargin??t?.includeAdvertisingInMargin??!0,vatPercent:n.vatPercent??t?.vatPercent??20,pricesIncludeVat:n.pricesIncludeVat??t?.pricesIncludeVat??!0,channelEngineId:n.channelEngineId??t?.channelEngineId,lastUpdated:new Date().toISOString()};return await d.putChannel(s),c(200,s)}return c(405,{error:"Method not allowed"})}async function Q(a){let e=a.path,r=a.queryStringParameters||{};if(e.endsWith("/summary")){let t=await d.getAllProducts(),n=await d.getProposalsByStatus("pending"),s={totalProducts:t.length,productsWithCosts:t.filter(o=>o.costPrice>0).length,productsWithoutCosts:t.filter(o=>!o.costPrice||o.costPrice===0).length,outOfStock:t.filter(o=>o.stockLevel===0).length,lowStock:t.filter(o=>o.stockLevel>0&&o.stockLevel<10).length,pendingProposals:n.length,avgMargin:t.length>0?t.reduce((o,i)=>o+(i.calculatedMargin||0),0)/t.length:0};return c(200,s)}if(e.endsWith("/margins")){let t=await d.getAllProducts(),n={negative:t.filter(s=>(s.calculatedMargin||0)<0).length,low:t.filter(s=>(s.calculatedMargin||0)>=0&&(s.calculatedMargin||0)<15).length,target:t.filter(s=>(s.calculatedMargin||0)>=15&&(s.calculatedMargin||0)<30).length,high:t.filter(s=>(s.calculatedMargin||0)>=30).length};return c(200,{marginBands:n,total:t.length})}if(e.endsWith("/sales")){let t=parseInt(r.days||"7",10),n=await d.getSalesBySku(t),s={};return n.forEach((o,i)=>{s[i]=o}),c(200,{days:t,skuCount:n.size,sales:s})}return c(404,{error:"Analytics endpoint not found"})}async function X(a){let e=a.path;if(e.endsWith("/costs")&&a.httpMethod==="POST"){let t=JSON.parse(a.body||"{}").data;if(!t||!Array.isArray(t))return c(400,{error:"Invalid data format. Expected { data: [...] }"});let{bySku:n,byBalterleySku:s}=await d.getProductLookupMap();console.log(`[Import] Built lookup maps: ${n.size} products by SKU, ${s.size} by Balterley SKU`);let o=0,i=0,u=0,l=[],g=[];for(let m of t){let b=m.sku.toUpperCase().trim(),y=n.get(b);y||(y=s.get(b),y&&u++),y?(y.costPrice=m.costPrice,m.deliveryCost!==void 0&&(y.deliveryCost=m.deliveryCost),g.push(y),o++):(i++,l.length<20&&l.push(m.sku))}g.length>0&&(console.log(`[Import] Batch writing ${g.length} products...`),await d.batchPutProducts(g));let P=new Set(t.map(m=>m.sku.toUpperCase().trim()));console.log(`[Import] importedSkuSet size: ${P.size}, bySku size: ${n.size}`);let h=[],f=0;for(let[m,b]of n)P.has(m)||(f++,h.length<50&&h.push(b.sku));let C=f;return console.log(`[Import] Found ${f} DB SKUs missing from file, collected ${h.length} samples`),console.log(`[Import] Complete: ${o} updated, ${i} not found in DB, ${C} DB SKUs missing from file, ${u} matched by Balterley SKU`),l.length>0&&console.log(`[Import] Sample file SKUs not in DB: ${l.join(", ")}`),h.length>0&&console.log(`[Import] Sample DB SKUs missing from file: ${h.join(", ")}`),c(200,{message:"Cost import complete",updated:o,notFoundInDb:i,matchedByBalterleySku:u,total:t.length,sampleNotFoundInDb:l.length>0?l:void 0,dbProductsMissingFromFile:C,sampleDbSkusMissingFromFile:h.length>0?h:void 0})}return e.endsWith("/delivery")&&a.httpMethod==="POST"?Y(a):c(404,{error:"Import endpoint not found"})}async function Y(a){let r=JSON.parse(a.body||"{}").data;if(!r||!Array.isArray(r))return c(400,{error:"Invalid data format. Expected { data: [...] }"});console.log(`[DeliveryImport] Processing ${r.length} delivery records`);let t=await d.getAllCarrierCosts(),n=new Map(t.map(m=>[m.carrierId,m.costPerParcel]));console.log(`[DeliveryImport] Loaded ${t.length} carrier cost configurations`);let s=await d.getAllOrders();console.log(`[DeliveryImport] Loaded ${s.length} orders for matching`);let o=new Map(s.map(m=>[m.orderId,m])),i=new Map(s.map(m=>[m.channelOrderNo,m])),u=new Set,l=new Set,g=0,P=0,h=0,f=0;for(let m of r){if(g++,x(m.carrier)){l.add(m.carrier),h++;continue}let b=I(m.carrier);b!=="unknown"&&u.add(b);let y=m.orderNumber.trim(),w=i.get(y);if(!w&&y.includes("-")){let O=y.split("-")[0];w=i.get(O)}w?(await d.updateOrderDelivery(w.orderId,{deliveryCarrier:b,deliveryCarrierRaw:m.carrier,deliveryParcels:m.parcels}),P++):f++}let C=[];for(let m of u)if(!n.has(m)){let b={carrierId:m,carrierName:A(m),costPerParcel:0,isActive:!0,lastUpdated:new Date().toISOString()};C.push(b)}return C.length>0&&(await d.batchPutCarrierCosts(C),console.log(`[DeliveryImport] Created ${C.length} new carrier entries`)),console.log(`[DeliveryImport] Complete: ${P} matched, ${f} not found, ${h} skipped (excluded carriers)`),c(200,{message:"Delivery import complete",ordersProcessed:g,ordersMatched:P,ordersNotFound:f,ordersSkipped:h,excludedCarriers:Array.from(l),carriersFound:Array.from(u),newCarriersCreated:C.map(m=>m.carrierName),note:P>0?`Updated ${P} orders with delivery info. ${C.length>0?"New carriers created - please set costs on the Delivery Costs page.":""}`:"No orders matched. Check that PONumber in Vector Summary matches your ChannelEngine order IDs."})}async function Z(a){let e=a.httpMethod,r=a.pathParameters?.carrierId;if(e==="GET"&&!r){let t=await d.getAllCarrierCosts();return c(200,{items:t,count:t.length})}if(e==="GET"&&r){let t=await d.getCarrierCost(r);return t?c(200,t):c(404,{error:"Carrier not found"})}if(e==="POST"){let t=JSON.parse(a.body||"{}"),n=I(t.carrierName||t.carrierId),s={carrierId:n,carrierName:t.carrierName||A(n),costPerParcel:t.costPerParcel??0,isActive:t.isActive??!0,lastUpdated:new Date().toISOString()};return await d.putCarrierCost(s),c(201,s)}if(e==="PUT"&&r){let t=await d.getCarrierCost(r);if(!t)return c(404,{error:"Carrier not found"});let n=JSON.parse(a.body||"{}"),s={...t,carrierName:n.carrierName??t.carrierName,costPerParcel:n.costPerParcel??t.costPerParcel,isActive:n.isActive??t.isActive,lastUpdated:new Date().toISOString()};return await d.putCarrierCost(s),c(200,s)}return e==="DELETE"&&r?(await d.deleteCarrierCost(r),c(204,null)):c(405,{error:"Method not allowed"})}async function ee(a){return c(200,{message:"Manual sync not yet implemented. Use AWS Console to invoke data-sync Lambda."})}function c(a,e){return{statusCode:a,headers:{"Content-Type":"application/json","Access-Control-Allow-Origin":"*","Access-Control-Allow-Methods":"GET, POST, PUT, DELETE, OPTIONS","Access-Control-Allow-Headers":"Content-Type, Authorization"},body:e?JSON.stringify(e):""}}0&&(module.exports={handler});
//# sourceMappingURL=index.js.map
