"use strict";var A=Object.create;var P=Object.defineProperty;var I=Object.getOwnPropertyDescriptor;var T=Object.getOwnPropertyNames;var R=Object.getPrototypeOf,E=Object.prototype.hasOwnProperty;var x=(i,e)=>{for(var n in e)P(i,n,{get:e[n],enumerable:!0})},C=(i,e,n,r)=>{if(e&&typeof e=="object"||typeof e=="function")for(let t of T(e))!E.call(i,t)&&t!==n&&P(i,t,{get:()=>e[t],enumerable:!(r=I(e,t))||r.enumerable});return i};var f=(i,e,n)=>(n=i!=null?A(R(i)):{},C(e||!i||!i.__esModule?P(n,"default",{value:i,enumerable:!0}):n,i)),D=i=>C(P({},"__esModule",{value:!0}),i);var F={};x(F,{handler:()=>L});module.exports=D(F);var b=require("googleapis"),g=class{sheets;spreadsheetId;constructor(e,n){let r=new b.google.auth.GoogleAuth({credentials:e,scopes:["https://www.googleapis.com/auth/spreadsheets.readonly"]});this.sheets=b.google.sheets({version:"v4",auth:r}),this.spreadsheetId=n}async fetchProducts(e="Sheet1"){let r=(await this.sheets.spreadsheets.values.get({spreadsheetId:this.spreadsheetId,range:`${e}!A:O`})).data.values;if(!r||r.length<2)return[];let t=r[0];return r.slice(1).filter(s=>s[1]).map(s=>this.parseRow(s,t))}parseRow(e,n){let r=a=>e[a]?.trim()||"",t=a=>{let s=e[a]?.replace(/[Â£$,]/g,"").trim();return parseFloat(s)||0};return{brandName:r(0),productSku:r(1),balterleySku:r(2),familyVariants:r(3),mrp:t(4),bandqPricing:t(5),amazonPricing:t(6),ebayPricing:t(7),manoManoPricing:t(8),shopifyPricing:t(9),discountStartDate:r(11)||void 0,discountEndDate:r(12)||void 0,discountPrice:t(13)||void 0}}static toProduct(e){let n=[e.amazonPricing,e.ebayPricing,e.bandqPricing,e.manoManoPricing,e.shopifyPricing].filter(t=>t>0),r=n.length>0?n[0]:e.mrp;return{sku:e.productSku,balterleySku:e.balterleySku||void 0,title:e.productSku,brand:e.brandName,familyVariants:e.familyVariants||void 0,mrp:e.mrp,currentPrice:r,channelPrices:{amazon:e.amazonPricing||void 0,ebay:e.ebayPricing||void 0,bandq:e.bandqPricing||void 0,manomano:e.manoManoPricing||void 0,shopify:e.shopifyPricing||void 0},discountPrice:e.discountPrice||void 0,discountStartDate:e.discountStartDate||void 0,discountEndDate:e.discountEndDate||void 0,lastSyncedFromSheet:new Date().toISOString()}}async getSheetNames(){return(await this.sheets.spreadsheets.get({spreadsheetId:this.spreadsheetId})).data.sheets?.map(n=>n.properties?.title||"")||[]}};async function v(i){let{SecretsManagerClient:e,GetSecretValueCommand:n}=await import("@aws-sdk/client-secrets-manager"),t=await new e({}).send(new n({SecretId:i}));if(!t.SecretString)throw new Error("Google Sheets secret not found");let a=JSON.parse(t.SecretString),s=JSON.parse(a.credentials);return new g(s,a.spreadsheetId)}var y=class{apiKey;tenantId;baseUrl;constructor(e){this.apiKey=e.apiKey,this.tenantId=e.tenantId,this.baseUrl=e.baseUrl||"https://api.channelengine.net/api/v2"}async request(e,n="GET",r){let t=`${this.baseUrl}${e}`,a=await fetch(t,{method:n,headers:{"Content-Type":"application/json","X-CE-KEY":this.apiKey},body:r?JSON.stringify(r):void 0});if(!a.ok)throw new Error(`ChannelEngine API error: ${a.status} ${a.statusText}`);return a.json()}async fetchProducts(){let e=[],n=1,r=100,t=!0;for(;t;){let a=await this.request(`/products?page=${n}&pageSize=${r}`);if(a.Content&&a.Content.length>0){for(let s of a.Content)e.push({merchantProductNo:s.MerchantProductNo,stock:s.Stock});n++,t=a.Content.length===r}else t=!1}return e}async fetchSalesData(e,n){let r=new Map,t=1,a=100,s=!0,c=e.toISOString(),u=n.toISOString();for(;s;){let l=await this.request(`/orders?fromDate=${c}&toDate=${u}&page=${t}&pageSize=${a}`);if(l.Content&&l.Content.length>0){for(let p of l.Content)if(p.Lines)for(let m of p.Lines){let d=r.get(m.MerchantProductNo)||{quantity:0,revenue:0};d.quantity+=m.Quantity,d.revenue+=m.UnitPriceInclVat*m.Quantity,r.set(m.MerchantProductNo,d)}t++,s=l.Content.length===a}else s=!1}return r}async fetchSalesMetrics(){let e=new Date,n=new Date(e.getTime()-7*24*60*60*1e3),r=new Date(e.getTime()-30*24*60*60*1e3),[t,a]=await Promise.all([this.fetchSalesData(n,e),this.fetchSalesData(r,e)]),s=new Set([...t.keys(),...a.keys()]);return Array.from(s).map(c=>({merchantProductNo:c,salesLast7Days:t.get(c)?.quantity||0,salesLast30Days:a.get(c)?.quantity||0}))}async updatePrices(e){let n=[];for(let t=0;t<e.length;t+=100){let a=e.slice(t,t+100);try{let s=a.map(u=>({MerchantProductNo:u.merchantProductNo,Price:u.price})),c=await this.request("/products/bulk","PUT",s);c.Success||n.push(`Batch ${t/100+1}: ${c.Message}`)}catch(s){n.push(`Batch ${t/100+1}: ${s instanceof Error?s.message:"Unknown error"}`)}}return{success:n.length===0,errors:n}}async updateStock(e){let n=[];for(let t=0;t<e.length;t+=100){let a=e.slice(t,t+100);try{let s=a.map(u=>({MerchantProductNo:u.merchantProductNo,Stock:u.stock})),c=await this.request("/offer/stock","PUT",s);c.Success||n.push(`Batch ${t/100+1}: ${c.Message}`)}catch(s){n.push(`Batch ${t/100+1}: ${s instanceof Error?s.message:"Unknown error"}`)}}return{success:n.length===0,errors:n}}};async function S(i){let{SecretsManagerClient:e,GetSecretValueCommand:n}=await import("@aws-sdk/client-secrets-manager"),t=await new e({}).send(new n({SecretId:i}));if(!t.SecretString)throw new Error("ChannelEngine secret not found");let a=JSON.parse(t.SecretString);return new y({apiKey:a.apiKey,tenantId:a.tenantId})}var N=require("uuid");var k=require("@aws-sdk/client-dynamodb"),o=require("@aws-sdk/lib-dynamodb"),w=class{docClient;productsTable;rulesTable;proposalsTable;channelsTable;constructor(e){let n=new k.DynamoDBClient({});this.docClient=o.DynamoDBDocumentClient.from(n,{marshallOptions:{removeUndefinedValues:!0}}),this.productsTable=e.productsTable,this.rulesTable=e.rulesTable,this.proposalsTable=e.proposalsTable,this.channelsTable=e.channelsTable}async getProduct(e){return(await this.docClient.send(new o.GetCommand({TableName:this.productsTable,Key:{sku:e}}))).Item||null}async putProduct(e){await this.docClient.send(new o.PutCommand({TableName:this.productsTable,Item:{...e,lastUpdated:new Date().toISOString()}}))}async getAllProducts(){let e=[],n;do{let r=await this.docClient.send(new o.ScanCommand({TableName:this.productsTable,ExclusiveStartKey:n}));r.Items&&e.push(...r.Items),n=r.LastEvaluatedKey}while(n);return e}async batchPutProducts(e){let n=new Date().toISOString(),r=this.chunkArray(e,25);for(let t of r)await this.docClient.send(new o.BatchWriteCommand({RequestItems:{[this.productsTable]:t.map(a=>({PutRequest:{Item:{...a,lastUpdated:n}}}))}}))}async getProductsByBrand(e){return(await this.docClient.send(new o.QueryCommand({TableName:this.productsTable,IndexName:"by-brand",KeyConditionExpression:"brand = :brand",ExpressionAttributeValues:{":brand":e}}))).Items||[]}async getRule(e){return(await this.docClient.send(new o.GetCommand({TableName:this.rulesTable,Key:{ruleId:e}}))).Item||null}async putRule(e){await this.docClient.send(new o.PutCommand({TableName:this.rulesTable,Item:{...e,updatedAt:new Date().toISOString()}}))}async getAllRules(){return((await this.docClient.send(new o.ScanCommand({TableName:this.rulesTable}))).Items||[]).sort((n,r)=>n.priority-r.priority)}async deleteRule(e){let{DeleteCommand:n}=await import("@aws-sdk/lib-dynamodb");await this.docClient.send(new n({TableName:this.rulesTable,Key:{ruleId:e}}))}async getProposal(e){return(await this.docClient.send(new o.GetCommand({TableName:this.proposalsTable,Key:{proposalId:e}}))).Item||null}async putProposal(e){await this.docClient.send(new o.PutCommand({TableName:this.proposalsTable,Item:e}))}async batchPutProposals(e){let n=this.chunkArray(e,25);for(let r of n)await this.docClient.send(new o.BatchWriteCommand({RequestItems:{[this.proposalsTable]:r.map(t=>({PutRequest:{Item:t}}))}}))}async getProposalsByStatus(e){return(await this.docClient.send(new o.QueryCommand({TableName:this.proposalsTable,IndexName:"by-status",KeyConditionExpression:"#status = :status",ExpressionAttributeNames:{"#status":"status"},ExpressionAttributeValues:{":status":e},ScanIndexForward:!1}))).Items||[]}async queryProposals(e,n=1,r=50){let t=[],a={},s={};if(e.status){let d=Array.isArray(e.status)?e.status:[e.status];d.length===1&&(t.push("#status = :status"),a["#status"]="status",s[":status"]=d[0])}e.brand&&(t.push("brand = :brand"),s[":brand"]=e.brand),e.batchId&&(t.push("batchId = :batchId"),s[":batchId"]=e.batchId),e.hasWarnings&&(t.push("size(warnings) > :zero"),s[":zero"]=0);let u=(await this.docClient.send(new o.ScanCommand({TableName:this.proposalsTable,FilterExpression:t.length>0?t.join(" AND "):void 0,ExpressionAttributeNames:Object.keys(a).length>0?a:void 0,ExpressionAttributeValues:Object.keys(s).length>0?s:void 0}))).Items||[];if(e.searchTerm){let d=e.searchTerm.toLowerCase();u=u.filter(h=>h.sku.toLowerCase().includes(d)||h.productTitle.toLowerCase().includes(d))}u.sort((d,h)=>new Date(h.createdAt).getTime()-new Date(d.createdAt).getTime());let l=u.length,p=(n-1)*r;return{items:u.slice(p,p+r),totalCount:l,page:n,pageSize:r,hasMore:p+r<l}}async updateProposalStatus(e,n,r,t,a){let s=["#status = :status","reviewedAt = :reviewedAt","reviewedBy = :reviewedBy"],c={"#status":"status"},u={":status":n,":reviewedAt":new Date().toISOString(),":reviewedBy":r};t&&(s.push("reviewNotes = :notes"),u[":notes"]=t),a!==void 0&&(s.push("approvedPrice = :approvedPrice"),u[":approvedPrice"]=a),await this.docClient.send(new o.UpdateCommand({TableName:this.proposalsTable,Key:{proposalId:e},UpdateExpression:`SET ${s.join(", ")}`,ExpressionAttributeNames:c,ExpressionAttributeValues:u}))}async getChannel(e){return(await this.docClient.send(new o.GetCommand({TableName:this.channelsTable,Key:{channelId:e}}))).Item||null}async putChannel(e){await this.docClient.send(new o.PutCommand({TableName:this.channelsTable,Item:{...e,lastUpdated:new Date().toISOString()}}))}async getAllChannels(){return(await this.docClient.send(new o.ScanCommand({TableName:this.channelsTable}))).Items||[]}chunkArray(e,n){let r=[];for(let t=0;t<e.length;t+=n)r.push(e.slice(t,t+n));return r}};function M(){return new w({productsTable:process.env.PRODUCTS_TABLE||"repricing-products",rulesTable:process.env.PRICING_RULES_TABLE||"repricing-rules",proposalsTable:process.env.PRICE_PROPOSALS_TABLE||"repricing-proposals",channelsTable:process.env.CHANNEL_CONFIG_TABLE||"repricing-channels"})}async function L(i,e){console.log("Starting data sync",{event:i,requestId:e.awsRequestId});let n=M();try{console.log("Fetching data from Google Sheets...");let r=await B();console.log(`Fetched ${r.length} products from Google Sheets`),console.log("Fetching data from ChannelEngine...");let t=await _();console.log(`Fetched stock for ${t.stockMap.size} products, sales for ${t.salesMap.size} products`),console.log("Loading existing products from database...");let a=await n.getAllProducts(),s=new Map(a.map(l=>[l.sku,l]));console.log(`Found ${a.length} existing products`),console.log("Merging data...");let c=$(r,t,s);console.log(`Merged ${c.length} products`),console.log("Saving to database..."),await n.batchPutProducts(c),console.log("Data sync complete");let u={totalProducts:c.length,fromSheet:r.length,withStock:t.stockMap.size,withSales:t.salesMap.size,newProducts:c.filter(l=>!s.has(l.sku)).length,updatedProducts:c.filter(l=>s.has(l.sku)).length};console.log("Sync summary:",u)}catch(r){throw console.error("Data sync failed:",r),r}}async function B(){let i=process.env.GOOGLE_SHEETS_SECRET_ARN;if(!i)throw new Error("GOOGLE_SHEETS_SECRET_ARN not configured");return(await(await v(i)).fetchProducts()).map(r=>g.toProduct(r))}async function _(){let i=process.env.CHANNEL_ENGINE_SECRET_ARN;if(!i)return console.warn("CHANNEL_ENGINE_SECRET_ARN not configured - skipping ChannelEngine sync"),{stockMap:new Map,salesMap:new Map};try{let e=await S(i),n=await e.fetchProducts(),r=new Map(n.map(s=>[s.merchantProductNo,s.stock])),t=await e.fetchSalesMetrics(),a=new Map(t.map(s=>[s.merchantProductNo,{salesLast7Days:s.salesLast7Days,salesLast30Days:s.salesLast30Days}]));return{stockMap:r,salesMap:a}}catch(e){return console.error("ChannelEngine sync failed:",e),{stockMap:new Map,salesMap:new Map}}}function $(i,e,n){let r=new Date().toISOString(),t=[];for(let a of i){if(!a.sku)continue;let s=n.get(a.sku),c=e.stockMap.get(a.sku),u=e.salesMap.get(a.sku),l={...s||{sku:a.sku,title:a.sku,brand:"",costPrice:0,deliveryCost:0,stockLevel:0,salesLast7Days:0,salesLast30Days:0,currentPrice:0,mrp:0,lastUpdated:r},...a,stockLevel:c??s?.stockLevel??0,stockLastUpdated:c!==void 0?r:s?.stockLastUpdated,salesLast7Days:u?.salesLast7Days??s?.salesLast7Days??0,salesLast30Days:u?.salesLast30Days??s?.salesLast30Days??0,salesLastUpdated:u?r:s?.salesLastUpdated,costPrice:s?.costPrice??0,deliveryCost:s?.deliveryCost??0,lastUpdated:r,lastSyncedFromSheet:r,lastSyncedFromChannelEngine:c!==void 0||u?r:s?.lastSyncedFromChannelEngine};t.push(l)}return t}0&&(module.exports={handler});
//# sourceMappingURL=index.js.map
