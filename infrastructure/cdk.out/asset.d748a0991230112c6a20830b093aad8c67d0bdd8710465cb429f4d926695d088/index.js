"use strict";var Q=Object.create;var R=Object.defineProperty;var H=Object.getOwnPropertyDescriptor;var X=Object.getOwnPropertyNames;var Y=Object.getPrototypeOf,Z=Object.prototype.hasOwnProperty;var ee=(o,e)=>{for(var n in e)R(o,n,{get:e[n],enumerable:!0})},F=(o,e,n,t)=>{if(e&&typeof e=="object"||typeof e=="function")for(let r of X(e))!Z.call(o,r)&&r!==n&&R(o,r,{get:()=>e[r],enumerable:!(t=H(e,r))||t.enumerable});return o};var O=(o,e,n)=>(n=o!=null?Q(Y(o)):{},F(e||!o||!o.__esModule?R(n,"default",{value:o,enumerable:!0}):n,o)),te=o=>F(R({},"__esModule",{value:!0}),o);var he={};ee(he,{handler:()=>se});module.exports=te(he);function B(o){if(!o||o.trim()==="")return"unknown";let e=o.toLowerCase().trim();return e.startsWith("homefleet")?"homefleet":e.includes("dpd")?"dpd":e.includes("dx")?"dx":e.includes("arrow")?"arrowxl":e.includes("parcelforce")?"parcelforce":e.includes("worthington")?"ak_worthington":e.includes("consolidated")?"consolidated":e.includes("hold delivery")?"hold_delivery":e.replace(/[^a-z0-9]/g,"_").replace(/_+/g,"_").replace(/^_|_$/g,"")}function $(o){return{homefleet:"HomeFleet",dpd:"DPD Logistics",dx:"DX",arrowxl:"ArrowXL",parcelforce:"Parcelforce",ak_worthington:"AK Worthington",consolidated:"Consolidated Delivery",hold_delivery:"Hold Delivery",today_despatch:"Today Despatch",unknown:"Unknown"}[o]||o}function L(o){if(!o)return!0;let e=o.toLowerCase().trim();return!!(e.includes("hold delivery")||e.includes("hold_delivery")||e.includes("consolidated delivery")||e.includes("consolidated")||e.includes("today_despatch")||e.includes("today despatch")||e==="today_despatch")}var re=require("googleapis");var U=class{apiKey;tenantId;baseUrl;constructor(e){this.apiKey=e.apiKey,this.tenantId=e.tenantId,this.baseUrl=e.baseUrl||"https://api.channelengine.net/api/v2"}async request(e,n="GET",t,r={}){let s=new URLSearchParams;s.set("apikey",this.apiKey);for(let[u,c]of Object.entries(r))s.set(u,String(c));let a=`${this.baseUrl}${e}?${s.toString()}`,i=await fetch(a,{method:n,headers:{"Content-Type":"application/json",Accept:"application/json"},body:t?JSON.stringify(t):void 0});if(!i.ok){let u=await i.text();throw new Error(`ChannelEngine API error: ${i.status} ${i.statusText} - ${u}`)}return i.json()}async fetchProducts(e){let n=[],t=1,r=100,s=!0,a=0;for(console.log(`[CE] Starting product fetch from ${this.baseUrl}/products`);s;){console.log(`[CE] Fetching page ${t}...`);try{let i=await this.request("/products","GET",void 0,{page:t,pageSize:r});if(a=i.TotalCount||a,i.Content&&i.Content.length>0){let u=[];for(let c of i.Content)u.push({merchantProductNo:c.MerchantProductNo,name:c.Name,description:c.Description,brand:c.Brand,ean:c.Ean,stock:c.Stock,price:c.Price,categoryTrail:c.CategoryTrail});n.push(...u),console.log(`[CE] Page ${t}: Got ${u.length} products (${n.length}/${a})`),e&&await e(u,t,a),t++,s=i.Content.length===r}else console.log(`[CE] Page ${t}: No more products`),s=!1}catch(i){throw console.error(`[CE] Error fetching page ${t}:`,i),i}}return console.log(`[CE] Completed: Fetched ${n.length} total products`),n}async fetchSalesData(e,n){let t=new Map,r=1,s=100,a=!0,i=e.toISOString(),u=n.toISOString();for(;a;){let c=await this.request("/orders","GET",void 0,{fromDate:i,toDate:u,page:r,pageSize:s});if(c.Content&&c.Content.length>0){for(let h of c.Content)if(h.Lines)for(let f of h.Lines){let g=t.get(f.MerchantProductNo)||{quantity:0,revenue:0};g.quantity+=f.Quantity,g.revenue+=f.UnitPriceInclVat*f.Quantity,t.set(f.MerchantProductNo,g)}r++,a=c.Content.length===s}else a=!1}return t}async fetchSalesMetrics(){let e=new Date,n=new Date(e.getTime()-7*24*60*60*1e3),t=new Date(e.getTime()-30*24*60*60*1e3),[r,s]=await Promise.all([this.fetchSalesData(n,e),this.fetchSalesData(t,e)]),a=new Set([...r.keys(),...s.keys()]);return Array.from(a).map(i=>({merchantProductNo:i,salesLast7Days:r.get(i)?.quantity||0,salesLast30Days:s.get(i)?.quantity||0}))}async fetchOrders(e,n){let t=[],r=1,s=100,a=!0,i=0,u=e.toISOString();for(console.log(`[CE] Starting order fetch from ${u}`);a;){console.log(`[CE] Fetching orders page ${r}...`);try{let c=await this.request("/orders","GET",void 0,{fromDate:u,page:r,pageSize:s});i=c.TotalCount||i,c.Content&&c.Content.length>0?(t.push(...c.Content),console.log(`[CE] Page ${r}: Got ${c.Content.length} orders (${t.length}/${i})`),n&&await n(c.Content,r,i),r++,a=c.Content.length===s):(console.log(`[CE] Page ${r}: No more orders`),a=!1)}catch(c){throw console.error(`[CE] Error fetching orders page ${r}:`,c),c}}return console.log(`[CE] Completed: Fetched ${t.length} total orders`),t}async updatePrices(e){let n=[];for(let r=0;r<e.length;r+=100){let s=e.slice(r,r+100);try{let a=s.map(u=>({MerchantProductNo:u.merchantProductNo,Price:u.price})),i=await this.request("/products/bulk","PUT",a);i.Success||n.push(`Batch ${r/100+1}: ${i.Message}`)}catch(a){n.push(`Batch ${r/100+1}: ${a instanceof Error?a.message:"Unknown error"}`)}}return{success:n.length===0,errors:n}}async updateStock(e){let n=[];for(let r=0;r<e.length;r+=100){let s=e.slice(r,r+100);try{let a=s.map(u=>({MerchantProductNo:u.merchantProductNo,Stock:u.stock})),i=await this.request("/offer/stock","PUT",a);i.Success||n.push(`Batch ${r/100+1}: ${i.Message}`)}catch(a){n.push(`Batch ${r/100+1}: ${a instanceof Error?a.message:"Unknown error"}`)}}return{success:n.length===0,errors:n}}};async function q(o){let{SecretsManagerClient:e,GetSecretValueCommand:n}=await import("@aws-sdk/client-secrets-manager"),r=await new e({}).send(new n({SecretId:o}));if(!r.SecretString)throw new Error("ChannelEngine secret not found");let s=JSON.parse(r.SecretString);return new U({apiKey:s.apiKey,tenantId:s.tenantId,baseUrl:s.baseUrl})}var ne=require("uuid");var V=require("@aws-sdk/client-dynamodb"),p=require("@aws-sdk/lib-dynamodb"),G=class{docClient;productsTable;rulesTable;proposalsTable;channelsTable;ordersTable;carrierCostsTable;constructor(e){let n=new V.DynamoDBClient({});this.docClient=p.DynamoDBDocumentClient.from(n,{marshallOptions:{removeUndefinedValues:!0}}),this.productsTable=e.productsTable,this.rulesTable=e.rulesTable,this.proposalsTable=e.proposalsTable,this.channelsTable=e.channelsTable,this.ordersTable=e.ordersTable||"repricing-orders",this.carrierCostsTable=e.carrierCostsTable||"repricing-carrier-costs"}async getProduct(e){return(await this.docClient.send(new p.GetCommand({TableName:this.productsTable,Key:{sku:e}}))).Item||null}async putProduct(e){await this.docClient.send(new p.PutCommand({TableName:this.productsTable,Item:{...e,lastUpdated:new Date().toISOString()}}))}async getAllProducts(){let e=[],n;do{let t=await this.docClient.send(new p.ScanCommand({TableName:this.productsTable,ExclusiveStartKey:n}));t.Items&&e.push(...t.Items),n=t.LastEvaluatedKey}while(n);return e}async batchPutProducts(e){let n=new Date().toISOString(),t=this.chunkArray(e,25);for(let r of t)await this.docClient.send(new p.BatchWriteCommand({RequestItems:{[this.productsTable]:r.map(s=>({PutRequest:{Item:{...s,lastUpdated:n}}}))}}))}async getProductsByBrand(e){return(await this.docClient.send(new p.QueryCommand({TableName:this.productsTable,IndexName:"by-brand",KeyConditionExpression:"brand = :brand",ExpressionAttributeValues:{":brand":e}}))).Items||[]}async getRule(e){return(await this.docClient.send(new p.GetCommand({TableName:this.rulesTable,Key:{ruleId:e}}))).Item||null}async putRule(e){await this.docClient.send(new p.PutCommand({TableName:this.rulesTable,Item:{...e,updatedAt:new Date().toISOString()}}))}async getAllRules(){return((await this.docClient.send(new p.ScanCommand({TableName:this.rulesTable}))).Items||[]).sort((n,t)=>n.priority-t.priority)}async deleteRule(e){let{DeleteCommand:n}=await import("@aws-sdk/lib-dynamodb");await this.docClient.send(new n({TableName:this.rulesTable,Key:{ruleId:e}}))}async getProposal(e){return(await this.docClient.send(new p.GetCommand({TableName:this.proposalsTable,Key:{proposalId:e}}))).Item||null}async putProposal(e){await this.docClient.send(new p.PutCommand({TableName:this.proposalsTable,Item:e}))}async batchPutProposals(e){let n=this.chunkArray(e,25);for(let t of n)await this.docClient.send(new p.BatchWriteCommand({RequestItems:{[this.proposalsTable]:t.map(r=>({PutRequest:{Item:r}}))}}))}async getProposalsByStatus(e){return(await this.docClient.send(new p.QueryCommand({TableName:this.proposalsTable,IndexName:"by-status",KeyConditionExpression:"#status = :status",ExpressionAttributeNames:{"#status":"status"},ExpressionAttributeValues:{":status":e},ScanIndexForward:!1}))).Items||[]}async queryProposals(e,n=1,t=50){let r=[],s={},a={};if(e.status){let g=Array.isArray(e.status)?e.status:[e.status];g.length===1&&(r.push("#status = :status"),s["#status"]="status",a[":status"]=g[0])}e.brand&&(r.push("brand = :brand"),a[":brand"]=e.brand),e.batchId&&(r.push("batchId = :batchId"),a[":batchId"]=e.batchId),e.hasWarnings&&(r.push("size(warnings) > :zero"),a[":zero"]=0);let u=(await this.docClient.send(new p.ScanCommand({TableName:this.proposalsTable,FilterExpression:r.length>0?r.join(" AND "):void 0,ExpressionAttributeNames:Object.keys(s).length>0?s:void 0,ExpressionAttributeValues:Object.keys(a).length>0?a:void 0}))).Items||[];if(e.searchTerm){let g=e.searchTerm.toLowerCase();u=u.filter(b=>b.sku.toLowerCase().includes(g)||b.productTitle.toLowerCase().includes(g))}u.sort((g,b)=>new Date(b.createdAt).getTime()-new Date(g.createdAt).getTime());let c=u.length,h=(n-1)*t;return{items:u.slice(h,h+t),totalCount:c,page:n,pageSize:t,hasMore:h+t<c}}async updateProposalStatus(e,n,t,r,s){let a=["#status = :status","reviewedAt = :reviewedAt","reviewedBy = :reviewedBy"],i={"#status":"status"},u={":status":n,":reviewedAt":new Date().toISOString(),":reviewedBy":t};r&&(a.push("reviewNotes = :notes"),u[":notes"]=r),s!==void 0&&(a.push("approvedPrice = :approvedPrice"),u[":approvedPrice"]=s),await this.docClient.send(new p.UpdateCommand({TableName:this.proposalsTable,Key:{proposalId:e},UpdateExpression:`SET ${a.join(", ")}`,ExpressionAttributeNames:i,ExpressionAttributeValues:u}))}async getChannel(e){return(await this.docClient.send(new p.GetCommand({TableName:this.channelsTable,Key:{channelId:e}}))).Item||null}async putChannel(e){await this.docClient.send(new p.PutCommand({TableName:this.channelsTable,Item:{...e,lastUpdated:new Date().toISOString()}}))}async getAllChannels(){return(await this.docClient.send(new p.ScanCommand({TableName:this.channelsTable}))).Items||[]}async getCarrierCost(e){return(await this.docClient.send(new p.GetCommand({TableName:this.carrierCostsTable,Key:{carrierId:e}}))).Item||null}async putCarrierCost(e){await this.docClient.send(new p.PutCommand({TableName:this.carrierCostsTable,Item:{...e,lastUpdated:new Date().toISOString()}}))}async getAllCarrierCosts(){return(await this.docClient.send(new p.ScanCommand({TableName:this.carrierCostsTable}))).Items||[]}async deleteCarrierCost(e){let{DeleteCommand:n}=await import("@aws-sdk/lib-dynamodb");await this.docClient.send(new n({TableName:this.carrierCostsTable,Key:{carrierId:e}}))}async batchPutCarrierCosts(e){let n=new Date().toISOString(),t=this.chunkArray(e,25);for(let r of t)await this.docClient.send(new p.BatchWriteCommand({RequestItems:{[this.carrierCostsTable]:r.map(s=>({PutRequest:{Item:{...s,lastUpdated:n}}}))}}))}async batchPutOrders(e){let n=this.chunkArray(e,25);for(let t of n)await this.docClient.send(new p.BatchWriteCommand({RequestItems:{[this.ordersTable]:t.map(r=>({PutRequest:{Item:r}}))}}))}async getOrdersByDate(e){return(await this.docClient.send(new p.QueryCommand({TableName:this.ordersTable,IndexName:"by-date",KeyConditionExpression:"orderDateDay = :dateDay",ExpressionAttributeValues:{":dateDay":e}}))).Items||[]}async getOrdersByChannel(e,n,t){return(await this.docClient.send(new p.QueryCommand({TableName:this.ordersTable,IndexName:"by-channel",KeyConditionExpression:"channelName = :channel AND orderDate BETWEEN :fromDate AND :toDate",ExpressionAttributeValues:{":channel":e,":fromDate":n,":toDate":t}}))).Items||[]}async getOrderCount(){return(await this.docClient.send(new p.ScanCommand({TableName:this.ordersTable,Select:"COUNT"}))).Count||0}async getOrder(e){return(await this.docClient.send(new p.GetCommand({TableName:this.ordersTable,Key:{orderId:e}}))).Item||null}async updateOrderDelivery(e,n){await this.docClient.send(new p.UpdateCommand({TableName:this.ordersTable,Key:{orderId:e},UpdateExpression:"SET deliveryCarrier = :carrier, deliveryCarrierRaw = :carrierRaw, deliveryParcels = :parcels, deliveryImportedAt = :importedAt",ExpressionAttributeValues:{":carrier":n.deliveryCarrier,":carrierRaw":n.deliveryCarrierRaw,":parcels":n.deliveryParcels,":importedAt":new Date().toISOString()}}))}async getAllOrders(){let e=[],n;do{let t=await this.docClient.send(new p.ScanCommand({TableName:this.ordersTable,ExclusiveStartKey:n}));t.Items&&e.push(...t.Items),n=t.LastEvaluatedKey}while(n);return e}async getProductLookupMap(){let e=await this.getAllProducts(),n=new Map,t=new Map;for(let r of e)n.set(r.sku.toUpperCase(),r),r.balterleySku&&t.set(r.balterleySku.toUpperCase(),r);return{bySku:n,byBalterleySku:t}}async getSalesBySku(e=7){let n=new Map,t=new Date,r=[];for(let s=0;s<e;s++){let a=new Date(t);a.setDate(a.getDate()-s),r.push(a.toISOString().substring(0,10))}for(let s of r){let a=await this.getOrdersByDate(s);for(let i of a)if(i.lines)for(let u of i.lines){let c=n.get(u.sku)||{quantity:0,revenue:0};c.quantity+=u.quantity,c.revenue+=u.lineTotalInclVat,n.set(u.sku,c)}}return n}chunkArray(e,n){let t=[];for(let r=0;r<e.length;r+=n)t.push(e.slice(r,r+n));return t}};function K(){return new G({productsTable:process.env.PRODUCTS_TABLE||"repricing-products",rulesTable:process.env.PRICING_RULES_TABLE||"repricing-rules",proposalsTable:process.env.PRICE_PROPOSALS_TABLE||"repricing-proposals",channelsTable:process.env.CHANNEL_CONFIG_TABLE||"repricing-channels",ordersTable:process.env.ORDERS_TABLE||"repricing-orders",carrierCostsTable:process.env.CARRIER_COSTS_TABLE||"repricing-carrier-costs"})}var z=require("uuid"),d=K();async function se(o,e){console.log("API request:",{method:o.httpMethod,path:o.path,requestId:e.awsRequestId});try{let n=o.path,t=o.httpMethod;return n.startsWith("/products")?oe(o):n.startsWith("/proposals")?ae(o):n.startsWith("/rules")?ce(o):n.startsWith("/channels")?le(o):n.startsWith("/analytics")?ue(o):n.startsWith("/import")?de(o):n.startsWith("/carriers")?me(o):n==="/sync"&&t==="POST"?ge(o):l(404,{error:"Not found"})}catch(n){return console.error("API error:",n),l(500,{error:n instanceof Error?n.message:"Internal server error"})}}async function oe(o){let e=o.httpMethod,n=o.pathParameters?.sku;if(e==="GET"&&!n){let t=await d.getAllProducts();return l(200,{items:t,count:t.length})}if(e==="GET"&&n){let t=await d.getProduct(n);return t?l(200,t):l(404,{error:"Product not found"})}if(e==="PUT"&&n){let t=JSON.parse(o.body||"{}"),r=await d.getProduct(n);if(!r)return l(404,{error:"Product not found"});let s={...r,costPrice:t.costPrice??r.costPrice,deliveryCost:t.deliveryCost??r.deliveryCost,category:t.category??r.category};return await d.putProduct(s),l(200,s)}return l(405,{error:"Method not allowed"})}async function ae(o){let e=o.httpMethod,n=o.path,t=o.pathParameters?.proposalId;if(n.endsWith("/bulk-approve")&&e==="POST"){let r=JSON.parse(o.body||"{}"),s=[];for(let a of r.proposalIds)await d.updateProposalStatus(a,"approved",r.reviewedBy,r.notes),s.push({proposalId:a,status:"approved"});return l(200,{results:s})}if(n.endsWith("/bulk-reject")&&e==="POST"){let r=JSON.parse(o.body||"{}"),s=[];for(let a of r.proposalIds)await d.updateProposalStatus(a,"rejected",r.reviewedBy,r.notes),s.push({proposalId:a,status:"rejected"});return l(200,{results:s})}if(n.endsWith("/push")&&e==="POST")return ie(o);if(e==="GET"&&!t){let r=o.queryStringParameters||{},s={status:r.status,batchId:r.batchId,brand:r.brand,searchTerm:r.search,hasWarnings:r.hasWarnings==="true"},a=parseInt(r.page||"1",10),i=parseInt(r.pageSize||"50",10),u=await d.queryProposals(s,a,i);return l(200,u)}if(e==="GET"&&t){let r=await d.getProposal(t);return r?l(200,r):l(404,{error:"Proposal not found"})}if(e==="PUT"&&t){let r=JSON.parse(o.body||"{}"),{action:s,modifiedPrice:a,notes:i,reviewedBy:u}=r;if(!s||!u)return l(400,{error:"action and reviewedBy are required"});let c,h;switch(s){case"approve":c="approved";break;case"reject":c="rejected";break;case"modify":if(a===void 0)return l(400,{error:"modifiedPrice required for modify action"});c="modified",h=a;break;default:return l(400,{error:"Invalid action"})}await d.updateProposalStatus(t,c,u,i,h);let f=await d.getProposal(t);return l(200,f)}return l(405,{error:"Method not allowed"})}async function ie(o){let n=JSON.parse(o.body||"{}").dryRun===!0,t=await d.getProposalsByStatus("approved"),r=await d.getProposalsByStatus("modified"),s=[...t,...r];if(s.length===0)return l(200,{message:"No approved proposals to push",count:0});let a=s.map(h=>({merchantProductNo:h.sku,price:h.approvedPrice??h.proposedPrice}));if(n)return l(200,{dryRun:!0,count:a.length,updates:a});let i=process.env.CHANNEL_ENGINE_SECRET_ARN;if(!i)return l(500,{error:"ChannelEngine not configured"});let c=await(await q(i)).updatePrices(a);if(c.success)for(let h of s)await d.updateProposalStatus(h.proposalId,"pushed","system","Pushed to ChannelEngine");return l(200,{success:c.success,pushed:a.length,errors:c.errors})}async function ce(o){let e=o.httpMethod,n=o.pathParameters?.ruleId;if(e==="GET"&&!n){let t=await d.getAllRules();return l(200,{items:t,count:t.length})}if(e==="GET"&&n){let t=await d.getRule(n);return t?l(200,t):l(404,{error:"Rule not found"})}if(e==="POST"){let t=JSON.parse(o.body||"{}"),r={ruleId:(0,z.v4)(),name:t.name,description:t.description,priority:t.priority??100,isActive:t.isActive??!0,conditions:t.conditions||{},action:t.action,createdAt:new Date().toISOString(),updatedAt:new Date().toISOString()};return await d.putRule(r),l(201,r)}if(e==="PUT"&&n){let t=await d.getRule(n);if(!t)return l(404,{error:"Rule not found"});let r=JSON.parse(o.body||"{}"),s={...t,name:r.name??t.name,description:r.description??t.description,priority:r.priority??t.priority,isActive:r.isActive??t.isActive,conditions:r.conditions??t.conditions,action:r.action??t.action,updatedAt:new Date().toISOString()};return await d.putRule(s),l(200,s)}return e==="DELETE"&&n?(await d.deleteRule(n),l(204,null)):l(405,{error:"Method not allowed"})}async function le(o){let e=o.httpMethod,n=o.pathParameters?.channelId;if(e==="GET"&&!n){let t=await d.getAllChannels();return l(200,{items:t,count:t.length})}if(e==="GET"&&n){let t=await d.getChannel(n);return t?l(200,t):l(404,{error:"Channel not found"})}if(e==="PUT"&&n){let t=await d.getChannel(n),r=JSON.parse(o.body||"{}"),s={channelId:n,name:r.name??t?.name??n,isActive:r.isActive??t?.isActive??!0,commissionPercent:r.commissionPercent??t?.commissionPercent??0,fixedFee:r.fixedFee??t?.fixedFee,paymentProcessingPercent:r.paymentProcessingPercent??t?.paymentProcessingPercent,defaultAcosPercent:r.defaultAcosPercent??t?.defaultAcosPercent,includeAdvertisingInMargin:r.includeAdvertisingInMargin??t?.includeAdvertisingInMargin??!0,vatPercent:r.vatPercent??t?.vatPercent??20,pricesIncludeVat:r.pricesIncludeVat??t?.pricesIncludeVat??!0,channelEngineId:r.channelEngineId??t?.channelEngineId,lastUpdated:new Date().toISOString()};return await d.putChannel(s),l(200,s)}return l(405,{error:"Method not allowed"})}async function ue(o){let e=o.path,n=o.queryStringParameters||{};if(e.endsWith("/summary")){let t=await d.getAllProducts(),r=await d.getProposalsByStatus("pending"),s={totalProducts:t.length,productsWithCosts:t.filter(a=>a.costPrice>0).length,productsWithoutCosts:t.filter(a=>!a.costPrice||a.costPrice===0).length,outOfStock:t.filter(a=>a.stockLevel===0).length,lowStock:t.filter(a=>a.stockLevel>0&&a.stockLevel<10).length,pendingProposals:r.length,avgMargin:t.length>0?t.reduce((a,i)=>a+(i.calculatedMargin||0),0)/t.length:0};return l(200,s)}if(e.endsWith("/margins")){let t=await d.getAllProducts(),r={negative:t.filter(s=>(s.calculatedMargin||0)<0).length,low:t.filter(s=>(s.calculatedMargin||0)>=0&&(s.calculatedMargin||0)<15).length,target:t.filter(s=>(s.calculatedMargin||0)>=15&&(s.calculatedMargin||0)<30).length,high:t.filter(s=>(s.calculatedMargin||0)>=30).length};return l(200,{marginBands:r,total:t.length})}if(e.endsWith("/sales")){let t=parseInt(n.days||"7",10),r=await d.getSalesBySku(t),s={};return r.forEach((a,i)=>{s[i]=a}),l(200,{days:t,skuCount:r.size,sales:s})}return l(404,{error:"Analytics endpoint not found"})}async function de(o){let e=o.path;if(e.endsWith("/costs")&&o.httpMethod==="POST"){let t=JSON.parse(o.body||"{}").data;if(!t||!Array.isArray(t))return l(400,{error:"Invalid data format. Expected { data: [...] }"});let{bySku:r,byBalterleySku:s}=await d.getProductLookupMap();console.log(`[Import] Built lookup maps: ${r.size} products by SKU, ${s.size} by Balterley SKU`);let a=0,i=0,u=0,c=[],h=[];for(let y of t){let w=y.sku.toUpperCase().trim(),C=r.get(w);C||(C=s.get(w),C&&u++),C?(C.costPrice=y.costPrice,y.deliveryCost!==void 0&&(C.deliveryCost=y.deliveryCost),h.push(C),a++):(i++,c.length<20&&c.push(y.sku))}h.length>0&&(console.log(`[Import] Batch writing ${h.length} products...`),await d.batchPutProducts(h));let f=new Set(t.map(y=>y.sku.toUpperCase().trim()));console.log(`[Import] importedSkuSet size: ${f.size}, bySku size: ${r.size}`);let g=[],b=0;for(let[y,w]of r)f.has(y)||(b++,g.length<50&&g.push(w.sku));let D=b;return console.log(`[Import] Found ${b} DB SKUs missing from file, collected ${g.length} samples`),console.log(`[Import] Complete: ${a} updated, ${i} not found in DB, ${D} DB SKUs missing from file, ${u} matched by Balterley SKU`),c.length>0&&console.log(`[Import] Sample file SKUs not in DB: ${c.join(", ")}`),g.length>0&&console.log(`[Import] Sample DB SKUs missing from file: ${g.join(", ")}`),l(200,{message:"Cost import complete",updated:a,notFoundInDb:i,matchedByBalterleySku:u,total:t.length,sampleNotFoundInDb:c.length>0?c:void 0,dbProductsMissingFromFile:D,sampleDbSkusMissingFromFile:g.length>0?g:void 0})}return e.endsWith("/delivery")&&o.httpMethod==="POST"?pe(o):l(404,{error:"Import endpoint not found"})}async function pe(o){let n=JSON.parse(o.body||"{}").data;if(!n||!Array.isArray(n))return l(400,{error:"Invalid data format. Expected { data: [...] }"});console.log(`[DeliveryImport] Processing ${n.length} delivery records`);let t=await d.getAllCarrierCosts(),r=new Map(t.map(m=>[m.carrierId,m.costPerParcel]));console.log(`[DeliveryImport] Loaded ${t.length} carrier cost configurations`);let s=await d.getAllOrders();console.log(`[DeliveryImport] Loaded ${s.length} orders for matching`);let a=await d.getAllProducts(),i=new Map(a.map(m=>[m.sku,m]));console.log(`[DeliveryImport] Loaded ${a.length} products for delivery cost calculation`);let u=new Map(s.map(m=>[m.channelOrderNo,m])),c=new Set,h=new Set,f=0,g=0,b=0,D=0,y=new Map;for(let m of n){if(f++,L(m.carrier)){h.add(m.carrier),b++;continue}let P=B(m.carrier);P!=="unknown"&&c.add(P);let v=m.orderNumber.trim(),I=u.get(v);if(!I&&v.includes("-")){let k=v.split("-")[0];I=u.get(k)}if(I){await d.updateOrderDelivery(I.orderId,{deliveryCarrier:P,deliveryCarrierRaw:m.carrier,deliveryParcels:m.parcels}),g++;let k=I.lines||[],_=r.get(P)||0,x=m.parcels*_,A=k.reduce((S,T)=>{let E=(T.lineTotalInclVat||T.unitPriceInclVat||0)*(T.quantity||1);return S+E},0);for(let S of k){let T=S.sku;if(!T)continue;y.has(T)||y.set(T,{carrierCounts:{},totalDeliveryCost:0,totalQuantity:0,orderCount:0});let E=y.get(T);E.carrierCounts[P]=(E.carrierCounts[P]||0)+1;let W=(S.lineTotalInclVat||S.unitPriceInclVat||0)*(S.quantity||1),j=A>0?W/A:1/k.length,J=x*j;E.totalDeliveryCost+=J,E.totalQuantity+=S.quantity||1,E.orderCount+=1}}else D++}let w=[];for(let m of c)if(!r.has(m)){let P={carrierId:m,carrierName:$(m),costPerParcel:0,isActive:!0,lastUpdated:new Date().toISOString()};w.push(P),r.set(m,0)}w.length>0&&(await d.batchPutCarrierCosts(w),console.log(`[DeliveryImport] Created ${w.length} new carrier entries`));let C=0,N=[];for(let[m,P]of y){let v="unknown",I=0;for(let[A,S]of Object.entries(P.carrierCounts))S>I&&(I=S,v=A);let k=P.totalQuantity>0?P.totalDeliveryCost/P.totalQuantity:0,_=r.get(v)||0,x=i.get(m);if(x&&P.totalDeliveryCost>0){let A=Math.round(k*100)/100;x.deliveryCost!==A&&(await d.putProduct({...x,deliveryCost:A}),C++),N.push({sku:m,carrier:v,cost:A,totalQuantity:P.totalQuantity,totalDeliveryCost:Math.round(P.totalDeliveryCost*100)/100})}else x&&N.push({sku:m,carrier:v,cost:0,totalQuantity:P.totalQuantity,totalDeliveryCost:0})}console.log(`[DeliveryImport] Complete: ${g} matched, ${D} not found, ${b} skipped (excluded carriers), ${C} products updated with delivery costs`);let M="";if(g===0)M="No orders matched. Check that PONumber in Vector Summary matches your ChannelEngine order IDs.";else{let m=[];m.push(`Updated ${g} orders with delivery info.`),C>0&&m.push(`Updated ${C} products with delivery costs.`),w.length>0&&m.push("New carriers created - please set costs on the Delivery Costs page.");let P=Array.from(c).filter(v=>r.get(v)===0);P.length>0&&m.push(`Carriers missing costs (${P.join(", ")}) - set costs to calculate delivery cost per SKU.`),M=m.join(" ")}return l(200,{message:"Delivery import complete",ordersProcessed:f,ordersMatched:g,ordersNotFound:D,ordersSkipped:b,productsUpdated:C,excludedCarriers:Array.from(h),carriersFound:Array.from(c),newCarriersCreated:w.map(m=>m.carrierName),skuDeliveryCosts:N.slice(0,50),note:M})}async function me(o){let e=o.httpMethod,n=o.pathParameters?.carrierId;if(e==="GET"&&!n){let t=await d.getAllCarrierCosts();return l(200,{items:t,count:t.length})}if(e==="GET"&&n){let t=await d.getCarrierCost(n);return t?l(200,t):l(404,{error:"Carrier not found"})}if(e==="POST"){let t=JSON.parse(o.body||"{}"),r=B(t.carrierName||t.carrierId),s={carrierId:r,carrierName:t.carrierName||$(r),costPerParcel:t.costPerParcel??0,isActive:t.isActive??!0,lastUpdated:new Date().toISOString()};return await d.putCarrierCost(s),l(201,s)}if(e==="PUT"&&n){let t=await d.getCarrierCost(n);if(!t)return l(404,{error:"Carrier not found"});let r=JSON.parse(o.body||"{}"),s={...t,carrierName:r.carrierName??t.carrierName,costPerParcel:r.costPerParcel??t.costPerParcel,isActive:r.isActive??t.isActive,lastUpdated:new Date().toISOString()};return await d.putCarrierCost(s),l(200,s)}return e==="DELETE"&&n?(await d.deleteCarrierCost(n),l(204,null)):l(405,{error:"Method not allowed"})}async function ge(o){return l(200,{message:"Manual sync not yet implemented. Use AWS Console to invoke data-sync Lambda."})}function l(o,e){return{statusCode:o,headers:{"Content-Type":"application/json","Access-Control-Allow-Origin":"*","Access-Control-Allow-Methods":"GET, POST, PUT, DELETE, OPTIONS","Access-Control-Allow-Headers":"Content-Type, Authorization"},body:e?JSON.stringify(e):""}}0&&(module.exports={handler});
//# sourceMappingURL=index.js.map
