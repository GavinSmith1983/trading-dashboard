"use strict";var T=Object.create;var f=Object.defineProperty;var E=Object.getOwnPropertyDescriptor;var k=Object.getOwnPropertyNames;var R=Object.getPrototypeOf,x=Object.prototype.hasOwnProperty;var N=(a,e)=>{for(var n in e)f(a,n,{get:e[n],enumerable:!0})},w=(a,e,n,r)=>{if(e&&typeof e=="object"||typeof e=="function")for(let t of k(e))!x.call(a,t)&&t!==n&&f(a,t,{get:()=>e[t],enumerable:!(r=E(e,t))||r.enumerable});return a};var C=(a,e,n)=>(n=a!=null?T(R(a)):{},w(e||!a||!a.__esModule?f(n,"default",{value:a,enumerable:!0}):n,a)),M=a=>w(f({},"__esModule",{value:!0}),a);var z={};N(z,{handler:()=>B});module.exports=M(z);var D=require("googleapis");var y=class{apiKey;tenantId;baseUrl;constructor(e){this.apiKey=e.apiKey,this.tenantId=e.tenantId,this.baseUrl=e.baseUrl||"https://api.channelengine.net/api/v2"}async request(e,n="GET",r,t={}){let s=new URLSearchParams;s.set("apikey",this.apiKey);for(let[l,u]of Object.entries(t))s.set(l,String(u));let o=`${this.baseUrl}${e}?${s.toString()}`,i=await fetch(o,{method:n,headers:{"Content-Type":"application/json",Accept:"application/json"},body:r?JSON.stringify(r):void 0});if(!i.ok){let l=await i.text();throw new Error(`ChannelEngine API error: ${i.status} ${i.statusText} - ${l}`)}return i.json()}async fetchProducts(e){let n=[],r=1,t=100,s=!0,o=0;for(console.log(`[CE] Starting product fetch from ${this.baseUrl}/products`);s;){console.log(`[CE] Fetching page ${r}...`);try{let i=await this.request("/products","GET",void 0,{page:r,pageSize:t});if(o=i.TotalCount||o,i.Content&&i.Content.length>0){let l=[];for(let u of i.Content)l.push({merchantProductNo:u.MerchantProductNo,name:u.Name,description:u.Description,brand:u.Brand,ean:u.Ean,stock:u.Stock,price:u.Price,categoryTrail:u.CategoryTrail});n.push(...l),console.log(`[CE] Page ${r}: Got ${l.length} products (${n.length}/${o})`),e&&await e(l,r,o),r++,s=i.Content.length===t}else console.log(`[CE] Page ${r}: No more products`),s=!1}catch(i){throw console.error(`[CE] Error fetching page ${r}:`,i),i}}return console.log(`[CE] Completed: Fetched ${n.length} total products`),n}async fetchSalesData(e,n){let r=new Map,t=1,s=100,o=!0,i=e.toISOString(),l=n.toISOString();for(;o;){let u=await this.request("/orders","GET",void 0,{fromDate:i,toDate:l,page:t,pageSize:s});if(u.Content&&u.Content.length>0){for(let m of u.Content)if(m.Lines)for(let h of m.Lines){let g=r.get(h.MerchantProductNo)||{quantity:0,revenue:0};g.quantity+=h.Quantity,g.revenue+=h.UnitPriceInclVat*h.Quantity,r.set(h.MerchantProductNo,g)}t++,o=u.Content.length===s}else o=!1}return r}async fetchSalesMetrics(){let e=new Date,n=new Date(e.getTime()-7*24*60*60*1e3),r=new Date(e.getTime()-30*24*60*60*1e3),[t,s]=await Promise.all([this.fetchSalesData(n,e),this.fetchSalesData(r,e)]),o=new Set([...t.keys(),...s.keys()]);return Array.from(o).map(i=>({merchantProductNo:i,salesLast7Days:t.get(i)?.quantity||0,salesLast30Days:s.get(i)?.quantity||0}))}async fetchOrders(e,n){let r=[],t=1,s=100,o=!0,i=0,l=e.toISOString();for(console.log(`[CE] Starting order fetch from ${l}`);o;){console.log(`[CE] Fetching orders page ${t}...`);try{let u=await this.request("/orders","GET",void 0,{fromDate:l,page:t,pageSize:s});i=u.TotalCount||i,u.Content&&u.Content.length>0?(r.push(...u.Content),console.log(`[CE] Page ${t}: Got ${u.Content.length} orders (${r.length}/${i})`),n&&await n(u.Content,t,i),t++,o=u.Content.length===s):(console.log(`[CE] Page ${t}: No more orders`),o=!1)}catch(u){throw console.error(`[CE] Error fetching orders page ${t}:`,u),u}}return console.log(`[CE] Completed: Fetched ${r.length} total orders`),r}async updatePrices(e){let n=[];for(let t=0;t<e.length;t+=100){let s=e.slice(t,t+100);try{let o=s.map(l=>({MerchantProductNo:l.merchantProductNo,Price:l.price})),i=await this.request("/products/bulk","PUT",o);i.Success||n.push(`Batch ${t/100+1}: ${i.Message}`)}catch(o){n.push(`Batch ${t/100+1}: ${o instanceof Error?o.message:"Unknown error"}`)}}return{success:n.length===0,errors:n}}async updateStock(e){let n=[];for(let t=0;t<e.length;t+=100){let s=e.slice(t,t+100);try{let o=s.map(l=>({MerchantProductNo:l.merchantProductNo,Stock:l.stock})),i=await this.request("/offer/stock","PUT",o);i.Success||n.push(`Batch ${t/100+1}: ${i.Message}`)}catch(o){n.push(`Batch ${t/100+1}: ${o instanceof Error?o.message:"Unknown error"}`)}}return{success:n.length===0,errors:n}}};async function v(a){let{SecretsManagerClient:e,GetSecretValueCommand:n}=await import("@aws-sdk/client-secrets-manager"),t=await new e({}).send(new n({SecretId:a}));if(!t.SecretString)throw new Error("ChannelEngine secret not found");let s=JSON.parse(t.SecretString);return new y({apiKey:s.apiKey,tenantId:s.tenantId,baseUrl:s.baseUrl})}var O=require("uuid");var A=require("@aws-sdk/client-dynamodb"),d=require("@aws-sdk/lib-dynamodb"),b=class{docClient;productsTable;rulesTable;proposalsTable;channelsTable;ordersTable;orderLinesTable;constructor(e){let n=new A.DynamoDBClient({});this.docClient=d.DynamoDBDocumentClient.from(n,{marshallOptions:{removeUndefinedValues:!0}}),this.productsTable=e.productsTable,this.rulesTable=e.rulesTable,this.proposalsTable=e.proposalsTable,this.channelsTable=e.channelsTable,this.ordersTable=e.ordersTable||"repricing-orders",this.orderLinesTable=e.orderLinesTable||"repricing-order-lines"}async getProduct(e){return(await this.docClient.send(new d.GetCommand({TableName:this.productsTable,Key:{sku:e}}))).Item||null}async putProduct(e){await this.docClient.send(new d.PutCommand({TableName:this.productsTable,Item:{...e,lastUpdated:new Date().toISOString()}}))}async getAllProducts(){let e=[],n;do{let r=await this.docClient.send(new d.ScanCommand({TableName:this.productsTable,ExclusiveStartKey:n}));r.Items&&e.push(...r.Items),n=r.LastEvaluatedKey}while(n);return e}async batchPutProducts(e){let n=new Date().toISOString(),r=this.chunkArray(e,25);for(let t of r)await this.docClient.send(new d.BatchWriteCommand({RequestItems:{[this.productsTable]:t.map(s=>({PutRequest:{Item:{...s,lastUpdated:n}}}))}}))}async getProductsByBrand(e){return(await this.docClient.send(new d.QueryCommand({TableName:this.productsTable,IndexName:"by-brand",KeyConditionExpression:"brand = :brand",ExpressionAttributeValues:{":brand":e}}))).Items||[]}async getRule(e){return(await this.docClient.send(new d.GetCommand({TableName:this.rulesTable,Key:{ruleId:e}}))).Item||null}async putRule(e){await this.docClient.send(new d.PutCommand({TableName:this.rulesTable,Item:{...e,updatedAt:new Date().toISOString()}}))}async getAllRules(){return((await this.docClient.send(new d.ScanCommand({TableName:this.rulesTable}))).Items||[]).sort((n,r)=>n.priority-r.priority)}async deleteRule(e){let{DeleteCommand:n}=await import("@aws-sdk/lib-dynamodb");await this.docClient.send(new n({TableName:this.rulesTable,Key:{ruleId:e}}))}async getProposal(e){return(await this.docClient.send(new d.GetCommand({TableName:this.proposalsTable,Key:{proposalId:e}}))).Item||null}async putProposal(e){await this.docClient.send(new d.PutCommand({TableName:this.proposalsTable,Item:e}))}async batchPutProposals(e){let n=this.chunkArray(e,25);for(let r of n)await this.docClient.send(new d.BatchWriteCommand({RequestItems:{[this.proposalsTable]:r.map(t=>({PutRequest:{Item:t}}))}}))}async getProposalsByStatus(e){return(await this.docClient.send(new d.QueryCommand({TableName:this.proposalsTable,IndexName:"by-status",KeyConditionExpression:"#status = :status",ExpressionAttributeNames:{"#status":"status"},ExpressionAttributeValues:{":status":e},ScanIndexForward:!1}))).Items||[]}async queryProposals(e,n=1,r=50){let t=[],s={},o={};if(e.status){let g=Array.isArray(e.status)?e.status:[e.status];g.length===1&&(t.push("#status = :status"),s["#status"]="status",o[":status"]=g[0])}e.brand&&(t.push("brand = :brand"),o[":brand"]=e.brand),e.batchId&&(t.push("batchId = :batchId"),o[":batchId"]=e.batchId),e.hasWarnings&&(t.push("size(warnings) > :zero"),o[":zero"]=0);let l=(await this.docClient.send(new d.ScanCommand({TableName:this.proposalsTable,FilterExpression:t.length>0?t.join(" AND "):void 0,ExpressionAttributeNames:Object.keys(s).length>0?s:void 0,ExpressionAttributeValues:Object.keys(o).length>0?o:void 0}))).Items||[];if(e.searchTerm){let g=e.searchTerm.toLowerCase();l=l.filter(P=>P.sku.toLowerCase().includes(g)||P.productTitle.toLowerCase().includes(g))}l.sort((g,P)=>new Date(P.createdAt).getTime()-new Date(g.createdAt).getTime());let u=l.length,m=(n-1)*r;return{items:l.slice(m,m+r),totalCount:u,page:n,pageSize:r,hasMore:m+r<u}}async updateProposalStatus(e,n,r,t,s){let o=["#status = :status","reviewedAt = :reviewedAt","reviewedBy = :reviewedBy"],i={"#status":"status"},l={":status":n,":reviewedAt":new Date().toISOString(),":reviewedBy":r};t&&(o.push("reviewNotes = :notes"),l[":notes"]=t),s!==void 0&&(o.push("approvedPrice = :approvedPrice"),l[":approvedPrice"]=s),await this.docClient.send(new d.UpdateCommand({TableName:this.proposalsTable,Key:{proposalId:e},UpdateExpression:`SET ${o.join(", ")}`,ExpressionAttributeNames:i,ExpressionAttributeValues:l}))}async getChannel(e){return(await this.docClient.send(new d.GetCommand({TableName:this.channelsTable,Key:{channelId:e}}))).Item||null}async putChannel(e){await this.docClient.send(new d.PutCommand({TableName:this.channelsTable,Item:{...e,lastUpdated:new Date().toISOString()}}))}async getAllChannels(){return(await this.docClient.send(new d.ScanCommand({TableName:this.channelsTable}))).Items||[]}async batchPutOrders(e){let n=this.chunkArray(e,25);for(let r of n)await this.docClient.send(new d.BatchWriteCommand({RequestItems:{[this.ordersTable]:r.map(t=>({PutRequest:{Item:t}}))}}))}async batchPutOrderLines(e){let n=this.chunkArray(e,25);for(let r of n)await this.docClient.send(new d.BatchWriteCommand({RequestItems:{[this.orderLinesTable]:r.map(t=>({PutRequest:{Item:t}}))}}))}async getOrderLinesBySku(e,n,r){let t="sku = :sku",s={":sku":e};return n&&r?(t+=" AND orderDate BETWEEN :fromDate AND :toDate",s[":fromDate"]=n,s[":toDate"]=r):n&&(t+=" AND orderDate >= :fromDate",s[":fromDate"]=n),(await this.docClient.send(new d.QueryCommand({TableName:this.orderLinesTable,IndexName:"by-sku",KeyConditionExpression:t,ExpressionAttributeValues:s}))).Items||[]}async getOrderLinesByDate(e){return(await this.docClient.send(new d.QueryCommand({TableName:this.orderLinesTable,IndexName:"by-date",KeyConditionExpression:"orderDateDay = :dateDay",ExpressionAttributeValues:{":dateDay":e}}))).Items||[]}async getOrderLinesByChannelAndDate(e,n,r){return(await this.docClient.send(new d.QueryCommand({TableName:this.orderLinesTable,IndexName:"by-channel-date",KeyConditionExpression:"channelName = :channel AND orderDate BETWEEN :fromDate AND :toDate",ExpressionAttributeValues:{":channel":e,":fromDate":n,":toDate":r}}))).Items||[]}async getOrderCount(){return(await this.docClient.send(new d.ScanCommand({TableName:this.ordersTable,Select:"COUNT"}))).Count||0}async getOrderLineCount(){return(await this.docClient.send(new d.ScanCommand({TableName:this.orderLinesTable,Select:"COUNT"}))).Count||0}chunkArray(e,n){let r=[];for(let t=0;t<e.length;t+=n)r.push(e.slice(t,t+n));return r}};function I(){return new b({productsTable:process.env.PRODUCTS_TABLE||"repricing-products",rulesTable:process.env.PRICING_RULES_TABLE||"repricing-rules",proposalsTable:process.env.PRICE_PROPOSALS_TABLE||"repricing-proposals",channelsTable:process.env.CHANNEL_CONFIG_TABLE||"repricing-channels",ordersTable:process.env.ORDERS_TABLE||"repricing-orders",orderLinesTable:process.env.ORDER_LINES_TABLE||"repricing-order-lines"})}var S=require("uuid"),p=I();async function B(a,e){console.log("API request:",{method:a.httpMethod,path:a.path,requestId:e.awsRequestId});try{let n=a.path,r=a.httpMethod;return n.startsWith("/products")?L(a):n.startsWith("/proposals")?G(a):n.startsWith("/rules")?_(a):n.startsWith("/channels")?U(a):n.startsWith("/analytics")?F(a):n.startsWith("/import")?q(a):n==="/sync"&&r==="POST"?V(a):c(404,{error:"Not found"})}catch(n){return console.error("API error:",n),c(500,{error:n instanceof Error?n.message:"Internal server error"})}}async function L(a){let e=a.httpMethod,n=a.pathParameters?.sku;if(e==="GET"&&!n){let r=await p.getAllProducts();return c(200,{items:r,count:r.length})}if(e==="GET"&&n){let r=await p.getProduct(n);return r?c(200,r):c(404,{error:"Product not found"})}if(e==="PUT"&&n){let r=JSON.parse(a.body||"{}"),t=await p.getProduct(n);if(!t)return c(404,{error:"Product not found"});let s={...t,costPrice:r.costPrice??t.costPrice,deliveryCost:r.deliveryCost??t.deliveryCost,category:r.category??t.category};return await p.putProduct(s),c(200,s)}return c(405,{error:"Method not allowed"})}async function G(a){let e=a.httpMethod,n=a.path,r=a.pathParameters?.proposalId;if(n.endsWith("/bulk-approve")&&e==="POST"){let t=JSON.parse(a.body||"{}"),s=[];for(let o of t.proposalIds)await p.updateProposalStatus(o,"approved",t.reviewedBy,t.notes),s.push({proposalId:o,status:"approved"});return c(200,{results:s})}if(n.endsWith("/bulk-reject")&&e==="POST"){let t=JSON.parse(a.body||"{}"),s=[];for(let o of t.proposalIds)await p.updateProposalStatus(o,"rejected",t.reviewedBy,t.notes),s.push({proposalId:o,status:"rejected"});return c(200,{results:s})}if(n.endsWith("/push")&&e==="POST")return $(a);if(e==="GET"&&!r){let t=a.queryStringParameters||{},s={status:t.status,batchId:t.batchId,brand:t.brand,searchTerm:t.search,hasWarnings:t.hasWarnings==="true"},o=parseInt(t.page||"1",10),i=parseInt(t.pageSize||"50",10),l=await p.queryProposals(s,o,i);return c(200,l)}if(e==="GET"&&r){let t=await p.getProposal(r);return t?c(200,t):c(404,{error:"Proposal not found"})}if(e==="PUT"&&r){let t=JSON.parse(a.body||"{}"),{action:s,modifiedPrice:o,notes:i,reviewedBy:l}=t;if(!s||!l)return c(400,{error:"action and reviewedBy are required"});let u,m;switch(s){case"approve":u="approved";break;case"reject":u="rejected";break;case"modify":if(o===void 0)return c(400,{error:"modifiedPrice required for modify action"});u="modified",m=o;break;default:return c(400,{error:"Invalid action"})}await p.updateProposalStatus(r,u,l,i,m);let h=await p.getProposal(r);return c(200,h)}return c(405,{error:"Method not allowed"})}async function $(a){let n=JSON.parse(a.body||"{}").dryRun===!0,r=await p.getProposalsByStatus("approved"),t=await p.getProposalsByStatus("modified"),s=[...r,...t];if(s.length===0)return c(200,{message:"No approved proposals to push",count:0});let o=s.map(m=>({merchantProductNo:m.sku,price:m.approvedPrice??m.proposedPrice}));if(n)return c(200,{dryRun:!0,count:o.length,updates:o});let i=process.env.CHANNEL_ENGINE_SECRET_ARN;if(!i)return c(500,{error:"ChannelEngine not configured"});let u=await(await v(i)).updatePrices(o);if(u.success)for(let m of s)await p.updateProposalStatus(m.proposalId,"pushed","system","Pushed to ChannelEngine");return c(200,{success:u.success,pushed:o.length,errors:u.errors})}async function _(a){let e=a.httpMethod,n=a.pathParameters?.ruleId;if(e==="GET"&&!n){let r=await p.getAllRules();return c(200,{items:r,count:r.length})}if(e==="GET"&&n){let r=await p.getRule(n);return r?c(200,r):c(404,{error:"Rule not found"})}if(e==="POST"){let r=JSON.parse(a.body||"{}"),t={ruleId:(0,S.v4)(),name:r.name,description:r.description,priority:r.priority??100,isActive:r.isActive??!0,conditions:r.conditions||{},action:r.action,createdAt:new Date().toISOString(),updatedAt:new Date().toISOString()};return await p.putRule(t),c(201,t)}if(e==="PUT"&&n){let r=await p.getRule(n);if(!r)return c(404,{error:"Rule not found"});let t=JSON.parse(a.body||"{}"),s={...r,name:t.name??r.name,description:t.description??r.description,priority:t.priority??r.priority,isActive:t.isActive??r.isActive,conditions:t.conditions??r.conditions,action:t.action??r.action,updatedAt:new Date().toISOString()};return await p.putRule(s),c(200,s)}return e==="DELETE"&&n?(await p.deleteRule(n),c(204,null)):c(405,{error:"Method not allowed"})}async function U(a){let e=a.httpMethod,n=a.pathParameters?.channelId;if(e==="GET"&&!n){let r=await p.getAllChannels();return c(200,{items:r,count:r.length})}if(e==="GET"&&n){let r=await p.getChannel(n);return r?c(200,r):c(404,{error:"Channel not found"})}if(e==="PUT"&&n){let r=await p.getChannel(n),t=JSON.parse(a.body||"{}"),s={channelId:n,name:t.name??r?.name??n,isActive:t.isActive??r?.isActive??!0,commissionPercent:t.commissionPercent??r?.commissionPercent??0,fixedFee:t.fixedFee??r?.fixedFee,paymentProcessingPercent:t.paymentProcessingPercent??r?.paymentProcessingPercent,defaultAcosPercent:t.defaultAcosPercent??r?.defaultAcosPercent,includeAdvertisingInMargin:t.includeAdvertisingInMargin??r?.includeAdvertisingInMargin??!0,vatPercent:t.vatPercent??r?.vatPercent??20,pricesIncludeVat:t.pricesIncludeVat??r?.pricesIncludeVat??!0,channelEngineId:t.channelEngineId??r?.channelEngineId,lastUpdated:new Date().toISOString()};return await p.putChannel(s),c(200,s)}return c(405,{error:"Method not allowed"})}async function F(a){let e=a.path;if(e.endsWith("/summary")){let n=await p.getAllProducts(),r=await p.getProposalsByStatus("pending"),t={totalProducts:n.length,productsWithCosts:n.filter(s=>s.costPrice>0).length,productsWithoutCosts:n.filter(s=>!s.costPrice||s.costPrice===0).length,outOfStock:n.filter(s=>s.stockLevel===0).length,lowStock:n.filter(s=>s.stockLevel>0&&s.stockLevel<10).length,pendingProposals:r.length,avgMargin:n.length>0?n.reduce((s,o)=>s+(o.calculatedMargin||0),0)/n.length:0};return c(200,t)}if(e.endsWith("/margins")){let n=await p.getAllProducts(),r={negative:n.filter(t=>(t.calculatedMargin||0)<0).length,low:n.filter(t=>(t.calculatedMargin||0)>=0&&(t.calculatedMargin||0)<15).length,target:n.filter(t=>(t.calculatedMargin||0)>=15&&(t.calculatedMargin||0)<30).length,high:n.filter(t=>(t.calculatedMargin||0)>=30).length};return c(200,{marginBands:r,total:n.length})}return c(404,{error:"Analytics endpoint not found"})}async function q(a){if(a.path.endsWith("/costs")&&a.httpMethod==="POST"){let r=JSON.parse(a.body||"{}").data;if(!r||!Array.isArray(r))return c(400,{error:"Invalid data format. Expected { data: [...] }"});let t=0,s=0;for(let o of r){let i=await p.getProduct(o.sku);i?(i.costPrice=o.costPrice,o.deliveryCost!==void 0&&(i.deliveryCost=o.deliveryCost),await p.putProduct(i),t++):s++}return c(200,{message:"Cost import complete",updated:t,notFound:s,total:r.length})}return c(404,{error:"Import endpoint not found"})}async function V(a){return c(200,{message:"Manual sync not yet implemented. Use AWS Console to invoke data-sync Lambda."})}function c(a,e){return{statusCode:a,headers:{"Content-Type":"application/json","Access-Control-Allow-Origin":"*","Access-Control-Allow-Methods":"GET, POST, PUT, DELETE, OPTIONS","Access-Control-Allow-Headers":"Content-Type, Authorization"},body:e?JSON.stringify(e):""}}0&&(module.exports={handler});
//# sourceMappingURL=index.js.map
