"use strict";var D=Object.create;var f=Object.defineProperty;var N=Object.getOwnPropertyDescriptor;var M=Object.getOwnPropertyNames;var O=Object.getPrototypeOf,B=Object.prototype.hasOwnProperty;var _=(o,e)=>{for(var r in e)f(o,r,{get:e[r],enumerable:!0})},v=(o,e,r,n)=>{if(e&&typeof e=="object"||typeof e=="function")for(let t of M(e))!B.call(o,t)&&t!==r&&f(o,t,{get:()=>e[t],enumerable:!(n=N(e,t))||n.enumerable});return o};var S=(o,e,r)=>(r=o!=null?D(O(o)):{},v(e||!o||!o.__esModule?f(r,"default",{value:o,enumerable:!0}):r,o)),$=o=>v(f({},"__esModule",{value:!0}),o);var F={};_(F,{handler:()=>U});module.exports=$(F);var E=require("uuid");var T={amazon:{channelId:"amazon",name:"Amazon UK",isActive:!0,commissionPercent:15,fixedFee:0,paymentProcessingPercent:0,defaultAcosPercent:15,includeAdvertisingInMargin:!0,vatPercent:20,pricesIncludeVat:!0},ebay:{channelId:"ebay",name:"eBay UK",isActive:!0,commissionPercent:12.8,fixedFee:.3,paymentProcessingPercent:0,defaultAcosPercent:10,includeAdvertisingInMargin:!0,vatPercent:20,pricesIncludeVat:!0},bandq:{channelId:"bandq",name:"B&Q",isActive:!0,commissionPercent:15,fixedFee:0,paymentProcessingPercent:0,defaultAcosPercent:0,includeAdvertisingInMargin:!1,vatPercent:20,pricesIncludeVat:!0},manomano:{channelId:"manomano",name:"ManoMano",isActive:!0,commissionPercent:15,fixedFee:0,paymentProcessingPercent:0,defaultAcosPercent:10,includeAdvertisingInMargin:!0,vatPercent:20,pricesIncludeVat:!0},shopify:{channelId:"shopify",name:"Shopify (Direct)",isActive:!0,commissionPercent:0,fixedFee:0,paymentProcessingPercent:2.9,defaultAcosPercent:5,includeAdvertisingInMargin:!0,vatPercent:20,pricesIncludeVat:!0}};var b={minimumMarginPercent:15,maximumDiscountPercent:50,defaultRoundingRule:"nearest_99p",calculateWithVat:!0,includeAdvertisingInMargin:!0};function I(o,e,r,n,t,s,a,l,u){let c=1+l/100,m=u?o/c:o,d=u?o-m:0,g=o*(n/100),p=o*(s/100),P=o*(a/100),h=e+r+g+t+p+P,q=m-h+d,w=o-h,x=w/o*100;return{sellingPrice:o,vatAmount:d,priceExVat:m,costPrice:e,deliveryCost:r,channelCommission:g,channelFixedFee:t,paymentProcessing:p,advertisingCost:P,totalCosts:h,netProfit:w,marginPercent:x}}var L=require("googleapis");var k=require("uuid"),C=class{config;rules;channels;constructor(e=b,r=[],n=[]){this.config=e,this.rules=r.sort((t,s)=>t.priority-s.priority),this.channels=new Map(n.map(t=>[t.channelId,t]))}calculatePrice(e,r="amazon"){let n=this.channels.get(r);if(!n)throw new Error(`Channel ${r} not configured`);let t=[];(!e.costPrice||e.costPrice<=0)&&t.push("Missing cost price - cannot calculate accurate margin");let s=this.calculateCostBreakdown(e,e.currentPrice,n),a=this.findApplicableRule(e,s),l=e.currentPrice,u="No rule applied - price unchanged";if(a){let h=this.applyRule(a,e,n);l=h.price,u=h.reason}l=this.applyRounding(l,this.config.defaultRoundingRule);let c=this.calculateFloorPrice(e,n),m=!1;l<c&&(l=this.applyRounding(c,this.config.defaultRoundingRule),t.push(`Price raised to floor (${this.config.minimumMarginPercent}% minimum margin)`),m=!0);let d=e.mrp,g=!1;l>d&&(l=d,t.push("Price capped at MRP"),g=!0);let p=this.calculateCostBreakdown(e,l,n),P=p.marginPercent<this.config.minimumMarginPercent;return P&&!m&&t.push(`Margin (${p.marginPercent.toFixed(1)}%) below minimum (${this.config.minimumMarginPercent}%)`),{sku:e.sku,currentPrice:e.currentPrice,proposedPrice:l,priceChange:l-e.currentPrice,priceChangePercent:e.currentPrice>0?(l-e.currentPrice)/e.currentPrice*100:0,currentMargin:s.marginPercent,proposedMargin:p.marginPercent,marginChange:p.marginPercent-s.marginPercent,currentProfit:s.netProfit,proposedProfit:p.netProfit,costBreakdown:p,appliedRule:a?.name,reason:u,warnings:t,belowMinimumMargin:P,atFloorPrice:m,atCeilingPrice:g}}calculateCostBreakdown(e,r,n){let t=n.includeAdvertisingInMargin&&n.defaultAcosPercent||0;return I(r,e.costPrice||0,e.deliveryCost||0,n.commissionPercent,n.fixedFee||0,n.paymentProcessingPercent||0,t,n.vatPercent,n.pricesIncludeVat)}findApplicableRule(e,r){for(let n of this.rules)if(n.isActive&&this.ruleMatches(n,e,r))return n}ruleMatches(e,r,n){let t=e.conditions;return!(t.brands&&t.brands.length>0&&!t.brands.includes(r.brand)||t.categories&&t.categories.length>0&&(!r.category||!t.categories.includes(r.category))||t.skus&&t.skus.length>0&&!t.skus.includes(r.sku)||t.skuPatterns&&t.skuPatterns.length>0&&!t.skuPatterns.some(a=>new RegExp(a).test(r.sku))||t.marginBelow!==void 0&&n.marginPercent>=t.marginBelow||t.marginAbove!==void 0&&n.marginPercent<=t.marginAbove||t.stockBelow!==void 0&&r.stockLevel>=t.stockBelow||t.stockAbove!==void 0&&r.stockLevel<=t.stockAbove||t.salesVelocityBelow!==void 0&&r.salesLast7Days>=t.salesVelocityBelow||t.salesVelocityAbove!==void 0&&r.salesLast7Days<=t.salesVelocityAbove||t.priceBelow!==void 0&&r.currentPrice>=t.priceBelow||t.priceAbove!==void 0&&r.currentPrice<=t.priceAbove)}applyRule(e,r,n){let t=e.action;switch(t.type){case"set_margin":{let s=t.value/100,a=(n.commissionPercent+(n.paymentProcessingPercent||0)+(n.defaultAcosPercent||0))/100,l=(r.costPrice||0)+(r.deliveryCost||0)+(n.fixedFee||0),u=1-a-s;return u<=0?{price:r.currentPrice,reason:`Cannot achieve ${t.value}% margin - costs too high`}:{price:l/u,reason:`Set to achieve ${t.value}% margin (rule: ${e.name})`}}case"set_markup":return{price:(r.costPrice||0)*t.value,reason:`Applied ${t.value}x markup on cost (rule: ${e.name})`};case"adjust_percent":{let s=r.currentPrice*(1+t.value/100),a=t.value>=0?"increase":"decrease";return{price:s,reason:`${Math.abs(t.value)}% ${a} (rule: ${e.name})`}}case"adjust_fixed":{let s=r.currentPrice+t.value,a=t.value>=0?"increase":"decrease";return{price:s,reason:`\xA3${Math.abs(t.value).toFixed(2)} ${a} (rule: ${e.name})`}}case"set_price":return{price:t.value,reason:`Set to fixed price \xA3${t.value.toFixed(2)} (rule: ${e.name})`};case"match_mrp":return{price:r.mrp,reason:`Set to MRP (rule: ${e.name})`};case"discount_from_mrp":return{price:r.mrp*(1-t.value/100),reason:`${t.value}% discount from MRP (rule: ${e.name})`};default:return{price:r.currentPrice,reason:"Unknown action type"}}}calculateFloorPrice(e,r){let n=this.config.minimumMarginPercent/100,t=(r.commissionPercent+(r.paymentProcessingPercent||0)+(r.defaultAcosPercent||0))/100,s=(e.costPrice||0)+(e.deliveryCost||0)+(r.fixedFee||0),a=1-t-n;return a<=0?e.currentPrice:s/a}applyRounding(e,r){switch(r){case"nearest_99p":return Math.floor(e)+.99;case"nearest_95p":return Math.floor(e)+.95;case"nearest_pound":return Math.round(e);case"round_down":return Math.floor(e*100)/100;case"round_up":return Math.ceil(e*100)/100;case"none":default:return Math.round(e*100)/100}}generateProposals(e,r){let n=[];for(let t of e){let s=this.calculatePrice(t);if(Math.abs(s.priceChange)<.01)continue;let a={proposalId:(0,k.v4)(),sku:t.sku,productTitle:t.title,brand:t.brand,category:t.category,currentPrice:s.currentPrice,proposedPrice:s.proposedPrice,priceChange:s.priceChange,priceChangePercent:s.priceChangePercent,currentMargin:s.currentMargin,proposedMargin:s.proposedMargin,marginChange:s.marginChange,costBreakdown:s.costBreakdown,stockLevel:t.stockLevel,salesLast7Days:t.salesLast7Days,salesLast30Days:t.salesLast30Days,appliedRuleName:s.appliedRule,reason:s.reason,warnings:s.warnings,status:"pending",createdAt:new Date().toISOString(),batchId:r,ttl:Math.floor(Date.now()/1e3)+30*24*60*60};n.push(a)}return n}};var A=require("@aws-sdk/client-dynamodb"),i=require("@aws-sdk/lib-dynamodb"),y=class{docClient;productsTable;rulesTable;proposalsTable;channelsTable;ordersTable;carrierCostsTable;constructor(e){let r=new A.DynamoDBClient({});this.docClient=i.DynamoDBDocumentClient.from(r,{marshallOptions:{removeUndefinedValues:!0}}),this.productsTable=e.productsTable,this.rulesTable=e.rulesTable,this.proposalsTable=e.proposalsTable,this.channelsTable=e.channelsTable,this.ordersTable=e.ordersTable||"repricing-orders",this.carrierCostsTable=e.carrierCostsTable||"repricing-carrier-costs"}async getProduct(e){return(await this.docClient.send(new i.GetCommand({TableName:this.productsTable,Key:{sku:e}}))).Item||null}async putProduct(e){await this.docClient.send(new i.PutCommand({TableName:this.productsTable,Item:{...e,lastUpdated:new Date().toISOString()}}))}async getAllProducts(){let e=[],r;do{let n=await this.docClient.send(new i.ScanCommand({TableName:this.productsTable,ExclusiveStartKey:r}));n.Items&&e.push(...n.Items),r=n.LastEvaluatedKey}while(r);return e}async batchPutProducts(e){let r=new Date().toISOString(),n=this.chunkArray(e,25);for(let t of n)await this.docClient.send(new i.BatchWriteCommand({RequestItems:{[this.productsTable]:t.map(s=>({PutRequest:{Item:{...s,lastUpdated:r}}}))}}))}async getProductsByBrand(e){return(await this.docClient.send(new i.QueryCommand({TableName:this.productsTable,IndexName:"by-brand",KeyConditionExpression:"brand = :brand",ExpressionAttributeValues:{":brand":e}}))).Items||[]}async getRule(e){return(await this.docClient.send(new i.GetCommand({TableName:this.rulesTable,Key:{ruleId:e}}))).Item||null}async putRule(e){await this.docClient.send(new i.PutCommand({TableName:this.rulesTable,Item:{...e,updatedAt:new Date().toISOString()}}))}async getAllRules(){return((await this.docClient.send(new i.ScanCommand({TableName:this.rulesTable}))).Items||[]).sort((r,n)=>r.priority-n.priority)}async deleteRule(e){let{DeleteCommand:r}=await import("@aws-sdk/lib-dynamodb");await this.docClient.send(new r({TableName:this.rulesTable,Key:{ruleId:e}}))}async getProposal(e){return(await this.docClient.send(new i.GetCommand({TableName:this.proposalsTable,Key:{proposalId:e}}))).Item||null}async putProposal(e){await this.docClient.send(new i.PutCommand({TableName:this.proposalsTable,Item:e}))}async batchPutProposals(e){let r=this.chunkArray(e,25);for(let n of r)await this.docClient.send(new i.BatchWriteCommand({RequestItems:{[this.proposalsTable]:n.map(t=>({PutRequest:{Item:t}}))}}))}async getProposalsByStatus(e){return(await this.docClient.send(new i.QueryCommand({TableName:this.proposalsTable,IndexName:"by-status",KeyConditionExpression:"#status = :status",ExpressionAttributeNames:{"#status":"status"},ExpressionAttributeValues:{":status":e},ScanIndexForward:!1}))).Items||[]}async queryProposals(e,r=1,n=50){let t=[],s={},a={};if(e.status){let g=Array.isArray(e.status)?e.status:[e.status];g.length===1&&(t.push("#status = :status"),s["#status"]="status",a[":status"]=g[0])}e.brand&&(t.push("brand = :brand"),a[":brand"]=e.brand),e.batchId&&(t.push("batchId = :batchId"),a[":batchId"]=e.batchId),e.hasWarnings&&(t.push("size(warnings) > :zero"),a[":zero"]=0);let u=(await this.docClient.send(new i.ScanCommand({TableName:this.proposalsTable,FilterExpression:t.length>0?t.join(" AND "):void 0,ExpressionAttributeNames:Object.keys(s).length>0?s:void 0,ExpressionAttributeValues:Object.keys(a).length>0?a:void 0}))).Items||[];if(e.searchTerm){let g=e.searchTerm.toLowerCase();u=u.filter(p=>p.sku.toLowerCase().includes(g)||p.productTitle.toLowerCase().includes(g))}u.sort((g,p)=>new Date(p.createdAt).getTime()-new Date(g.createdAt).getTime());let c=u.length,m=(r-1)*n;return{items:u.slice(m,m+n),totalCount:c,page:r,pageSize:n,hasMore:m+n<c}}async updateProposalStatus(e,r,n,t,s){let a=["#status = :status","reviewedAt = :reviewedAt","reviewedBy = :reviewedBy"],l={"#status":"status"},u={":status":r,":reviewedAt":new Date().toISOString(),":reviewedBy":n};t&&(a.push("reviewNotes = :notes"),u[":notes"]=t),s!==void 0&&(a.push("approvedPrice = :approvedPrice"),u[":approvedPrice"]=s),await this.docClient.send(new i.UpdateCommand({TableName:this.proposalsTable,Key:{proposalId:e},UpdateExpression:`SET ${a.join(", ")}`,ExpressionAttributeNames:l,ExpressionAttributeValues:u}))}async getChannel(e){return(await this.docClient.send(new i.GetCommand({TableName:this.channelsTable,Key:{channelId:e}}))).Item||null}async putChannel(e){await this.docClient.send(new i.PutCommand({TableName:this.channelsTable,Item:{...e,lastUpdated:new Date().toISOString()}}))}async getAllChannels(){return(await this.docClient.send(new i.ScanCommand({TableName:this.channelsTable}))).Items||[]}async getCarrierCost(e){return(await this.docClient.send(new i.GetCommand({TableName:this.carrierCostsTable,Key:{carrierId:e}}))).Item||null}async putCarrierCost(e){await this.docClient.send(new i.PutCommand({TableName:this.carrierCostsTable,Item:{...e,lastUpdated:new Date().toISOString()}}))}async getAllCarrierCosts(){return(await this.docClient.send(new i.ScanCommand({TableName:this.carrierCostsTable}))).Items||[]}async deleteCarrierCost(e){let{DeleteCommand:r}=await import("@aws-sdk/lib-dynamodb");await this.docClient.send(new r({TableName:this.carrierCostsTable,Key:{carrierId:e}}))}async batchPutCarrierCosts(e){let r=new Date().toISOString(),n=this.chunkArray(e,25);for(let t of n)await this.docClient.send(new i.BatchWriteCommand({RequestItems:{[this.carrierCostsTable]:t.map(s=>({PutRequest:{Item:{...s,lastUpdated:r}}}))}}))}async batchPutOrders(e){let r=this.chunkArray(e,25);for(let n of r)await this.docClient.send(new i.BatchWriteCommand({RequestItems:{[this.ordersTable]:n.map(t=>({PutRequest:{Item:t}}))}}))}async getOrdersByDate(e){return(await this.docClient.send(new i.QueryCommand({TableName:this.ordersTable,IndexName:"by-date",KeyConditionExpression:"orderDateDay = :dateDay",ExpressionAttributeValues:{":dateDay":e}}))).Items||[]}async getOrdersByChannel(e,r,n){return(await this.docClient.send(new i.QueryCommand({TableName:this.ordersTable,IndexName:"by-channel",KeyConditionExpression:"channelName = :channel AND orderDate BETWEEN :fromDate AND :toDate",ExpressionAttributeValues:{":channel":e,":fromDate":r,":toDate":n}}))).Items||[]}async getOrderCount(){return(await this.docClient.send(new i.ScanCommand({TableName:this.ordersTable,Select:"COUNT"}))).Count||0}async getOrder(e){return(await this.docClient.send(new i.GetCommand({TableName:this.ordersTable,Key:{orderId:e}}))).Item||null}async updateOrderDelivery(e,r){await this.docClient.send(new i.UpdateCommand({TableName:this.ordersTable,Key:{orderId:e},UpdateExpression:"SET deliveryCarrier = :carrier, deliveryCarrierRaw = :carrierRaw, deliveryParcels = :parcels, deliveryImportedAt = :importedAt",ExpressionAttributeValues:{":carrier":r.deliveryCarrier,":carrierRaw":r.deliveryCarrierRaw,":parcels":r.deliveryParcels,":importedAt":new Date().toISOString()}}))}async getAllOrders(){let e=[],r;do{let n=await this.docClient.send(new i.ScanCommand({TableName:this.ordersTable,ExclusiveStartKey:r}));n.Items&&e.push(...n.Items),r=n.LastEvaluatedKey}while(r);return e}async getProductLookupMap(){let e=await this.getAllProducts(),r=new Map,n=new Map;for(let t of e)r.set(t.sku.toUpperCase(),t),t.balterleySku&&n.set(t.balterleySku.toUpperCase(),t);return{bySku:r,byBalterleySku:n}}async getSalesBySku(e=7){let r=new Map,n=new Date,t=[];for(let s=0;s<e;s++){let a=new Date(n);a.setDate(a.getDate()-s),t.push(a.toISOString().substring(0,10))}for(let s of t){let a=await this.getOrdersByDate(s);for(let l of a)if(l.lines)for(let u of l.lines){let c=r.get(u.sku)||{quantity:0,revenue:0};c.quantity+=u.quantity,c.revenue+=u.lineTotalInclVat,r.set(u.sku,c)}}return r}chunkArray(e,r){let n=[];for(let t=0;t<e.length;t+=r)n.push(e.slice(t,t+r));return n}};function R(){return new y({productsTable:process.env.PRODUCTS_TABLE||"repricing-products",rulesTable:process.env.PRICING_RULES_TABLE||"repricing-rules",proposalsTable:process.env.PRICE_PROPOSALS_TABLE||"repricing-proposals",channelsTable:process.env.CHANNEL_CONFIG_TABLE||"repricing-channels",ordersTable:process.env.ORDERS_TABLE||"repricing-orders",carrierCostsTable:process.env.CARRIER_COSTS_TABLE||"repricing-carrier-costs"})}async function U(o,e){console.log("Starting price calculation",{event:o,requestId:e.awsRequestId});let r=R(),n=(0,E.v4)();try{console.log("Loading products...");let t=await r.getAllProducts();console.log(`Loaded ${t.length} products`);let s=t.filter(d=>d.costPrice>0);if(console.log(`${s.length} products have cost data`),s.length===0){console.warn("No products with cost data - skipping price calculation");return}console.log("Loading pricing rules...");let a=await r.getAllRules();console.log(`Loaded ${a.length} pricing rules`),console.log("Loading channel configuration...");let l=await r.getAllChannels();if(l.length===0){console.log("No channels configured - initializing defaults");let d=Object.values(T).map(g=>({...g,lastUpdated:new Date().toISOString()}));for(let g of d)await r.putChannel(g);l=d}let u=new C(b,a,l);console.log("Generating price proposals...");let c=u.generateProposals(s,n);if(console.log(`Generated ${c.length} proposals`),c.length===0){console.log("No price changes proposed");return}console.log("Saving proposals..."),await r.batchPutProposals(c),console.log("Proposals saved");let m={batchId:n,totalProducts:t.length,productsWithCosts:s.length,proposalsGenerated:c.length,priceIncreases:c.filter(d=>d.priceChange>0).length,priceDecreases:c.filter(d=>d.priceChange<0).length,avgPriceChange:c.length>0?c.reduce((d,g)=>d+g.priceChangePercent,0)/c.length:0,avgMarginChange:c.length>0?c.reduce((d,g)=>d+g.marginChange,0)/c.length:0,proposalsWithWarnings:c.filter(d=>d.warnings.length>0).length};console.log("Calculation summary:",m),console.log(`Price proposals ready for review. Batch ID: ${n}`)}catch(t){throw console.error("Price calculation failed:",t),t}}0&&(module.exports={handler});
//# sourceMappingURL=index.js.map
