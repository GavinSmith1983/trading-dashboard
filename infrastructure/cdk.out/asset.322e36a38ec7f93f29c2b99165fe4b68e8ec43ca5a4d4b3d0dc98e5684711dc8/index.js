"use strict";var x=Object.create;var w=Object.defineProperty;var M=Object.getOwnPropertyDescriptor;var D=Object.getOwnPropertyNames;var N=Object.getPrototypeOf,B=Object.prototype.hasOwnProperty;var O=(a,t)=>{for(var r in t)w(a,r,{get:t[r],enumerable:!0})},I=(a,t,r,e)=>{if(t&&typeof t=="object"||typeof t=="function")for(let n of D(t))!B.call(a,n)&&n!==r&&w(a,n,{get:()=>t[n],enumerable:!(e=M(t,n))||e.enumerable});return a};var A=(a,t,r)=>(r=a!=null?x(N(a)):{},I(t||!a||!a.__esModule?w(r,"default",{value:a,enumerable:!0}):r,a)),$=a=>I(w({},"__esModule",{value:!0}),a);var J={};O(J,{handler:()=>F});module.exports=$(J);var G=require("googleapis");var C=class{apiKey;tenantId;baseUrl;constructor(t){this.apiKey=t.apiKey,this.tenantId=t.tenantId,this.baseUrl=t.baseUrl||"https://api.channelengine.net/api/v2"}async request(t,r="GET",e,n={}){let s=new URLSearchParams;s.set("apikey",this.apiKey);for(let[u,c]of Object.entries(n))s.set(u,String(c));let o=`${this.baseUrl}${t}?${s.toString()}`,i=await fetch(o,{method:r,headers:{"Content-Type":"application/json",Accept:"application/json"},body:e?JSON.stringify(e):void 0});if(!i.ok){let u=await i.text();throw new Error(`ChannelEngine API error: ${i.status} ${i.statusText} - ${u}`)}return i.json()}async fetchProducts(t){let r=[],e=1,n=100,s=!0,o=0;for(console.log(`[CE] Starting product fetch from ${this.baseUrl}/products`);s;){console.log(`[CE] Fetching page ${e}...`);try{let i=await this.request("/products","GET",void 0,{page:e,pageSize:n});if(o=i.TotalCount||o,i.Content&&i.Content.length>0){let u=[];for(let c of i.Content)u.push({merchantProductNo:c.MerchantProductNo,name:c.Name,description:c.Description,brand:c.Brand,ean:c.Ean,stock:c.Stock,price:c.Price,categoryTrail:c.CategoryTrail});r.push(...u),console.log(`[CE] Page ${e}: Got ${u.length} products (${r.length}/${o})`),t&&await t(u,e,o),e++,s=i.Content.length===n}else console.log(`[CE] Page ${e}: No more products`),s=!1}catch(i){throw console.error(`[CE] Error fetching page ${e}:`,i),i}}return console.log(`[CE] Completed: Fetched ${r.length} total products`),r}async fetchSalesData(t,r){let e=new Map,n=1,s=100,o=!0,i=t.toISOString(),u=r.toISOString();for(;o;){let c=await this.request("/orders","GET",void 0,{fromDate:i,toDate:u,page:n,pageSize:s});if(c.Content&&c.Content.length>0){for(let m of c.Content)if(m.Lines)for(let h of m.Lines){let g=e.get(h.MerchantProductNo)||{quantity:0,revenue:0};g.quantity+=h.Quantity,g.revenue+=h.UnitPriceInclVat*h.Quantity,e.set(h.MerchantProductNo,g)}n++,o=c.Content.length===s}else o=!1}return e}async fetchSalesMetrics(){let t=new Date,r=new Date(t.getTime()-7*24*60*60*1e3),e=new Date(t.getTime()-30*24*60*60*1e3),[n,s]=await Promise.all([this.fetchSalesData(r,t),this.fetchSalesData(e,t)]),o=new Set([...n.keys(),...s.keys()]);return Array.from(o).map(i=>({merchantProductNo:i,salesLast7Days:n.get(i)?.quantity||0,salesLast30Days:s.get(i)?.quantity||0}))}async fetchOrders(t,r){let e=[],n=1,s=100,o=!0,i=0,u=t.toISOString();for(console.log(`[CE] Starting order fetch from ${u}`);o;){console.log(`[CE] Fetching orders page ${n}...`);try{let c=await this.request("/orders","GET",void 0,{fromDate:u,page:n,pageSize:s});i=c.TotalCount||i,c.Content&&c.Content.length>0?(e.push(...c.Content),console.log(`[CE] Page ${n}: Got ${c.Content.length} orders (${e.length}/${i})`),r&&await r(c.Content,n,i),n++,o=c.Content.length===s):(console.log(`[CE] Page ${n}: No more orders`),o=!1)}catch(c){throw console.error(`[CE] Error fetching orders page ${n}:`,c),c}}return console.log(`[CE] Completed: Fetched ${e.length} total orders`),e}async updatePrices(t){let r=[];for(let n=0;n<t.length;n+=100){let s=t.slice(n,n+100);try{let o=s.map(u=>({MerchantProductNo:u.merchantProductNo,Price:u.price})),i=await this.request("/products/bulk","PUT",o);i.Success||r.push(`Batch ${n/100+1}: ${i.Message}`)}catch(o){r.push(`Batch ${n/100+1}: ${o instanceof Error?o.message:"Unknown error"}`)}}return{success:r.length===0,errors:r}}async updateStock(t){let r=[];for(let n=0;n<t.length;n+=100){let s=t.slice(n,n+100);try{let o=s.map(u=>({MerchantProductNo:u.merchantProductNo,Stock:u.stock})),i=await this.request("/offer/stock","PUT",o);i.Success||r.push(`Batch ${n/100+1}: ${i.Message}`)}catch(o){r.push(`Batch ${n/100+1}: ${o instanceof Error?o.message:"Unknown error"}`)}}return{success:r.length===0,errors:r}}};async function k(a){let{SecretsManagerClient:t,GetSecretValueCommand:r}=await import("@aws-sdk/client-secrets-manager"),n=await new t({}).send(new r({SecretId:a}));if(!n.SecretString)throw new Error("ChannelEngine secret not found");let s=JSON.parse(n.SecretString);return new C({apiKey:s.apiKey,tenantId:s.tenantId,baseUrl:s.baseUrl})}var U=require("uuid");var T=require("@aws-sdk/client-dynamodb"),d=require("@aws-sdk/lib-dynamodb"),S=class{docClient;productsTable;rulesTable;proposalsTable;channelsTable;ordersTable;constructor(t){let r=new T.DynamoDBClient({});this.docClient=d.DynamoDBDocumentClient.from(r,{marshallOptions:{removeUndefinedValues:!0}}),this.productsTable=t.productsTable,this.rulesTable=t.rulesTable,this.proposalsTable=t.proposalsTable,this.channelsTable=t.channelsTable,this.ordersTable=t.ordersTable||"repricing-orders"}async getProduct(t){return(await this.docClient.send(new d.GetCommand({TableName:this.productsTable,Key:{sku:t}}))).Item||null}async putProduct(t){await this.docClient.send(new d.PutCommand({TableName:this.productsTable,Item:{...t,lastUpdated:new Date().toISOString()}}))}async getAllProducts(){let t=[],r;do{let e=await this.docClient.send(new d.ScanCommand({TableName:this.productsTable,ExclusiveStartKey:r}));e.Items&&t.push(...e.Items),r=e.LastEvaluatedKey}while(r);return t}async batchPutProducts(t){let r=new Date().toISOString(),e=this.chunkArray(t,25);for(let n of e)await this.docClient.send(new d.BatchWriteCommand({RequestItems:{[this.productsTable]:n.map(s=>({PutRequest:{Item:{...s,lastUpdated:r}}}))}}))}async getProductsByBrand(t){return(await this.docClient.send(new d.QueryCommand({TableName:this.productsTable,IndexName:"by-brand",KeyConditionExpression:"brand = :brand",ExpressionAttributeValues:{":brand":t}}))).Items||[]}async getRule(t){return(await this.docClient.send(new d.GetCommand({TableName:this.rulesTable,Key:{ruleId:t}}))).Item||null}async putRule(t){await this.docClient.send(new d.PutCommand({TableName:this.rulesTable,Item:{...t,updatedAt:new Date().toISOString()}}))}async getAllRules(){return((await this.docClient.send(new d.ScanCommand({TableName:this.rulesTable}))).Items||[]).sort((r,e)=>r.priority-e.priority)}async deleteRule(t){let{DeleteCommand:r}=await import("@aws-sdk/lib-dynamodb");await this.docClient.send(new r({TableName:this.rulesTable,Key:{ruleId:t}}))}async getProposal(t){return(await this.docClient.send(new d.GetCommand({TableName:this.proposalsTable,Key:{proposalId:t}}))).Item||null}async putProposal(t){await this.docClient.send(new d.PutCommand({TableName:this.proposalsTable,Item:t}))}async batchPutProposals(t){let r=this.chunkArray(t,25);for(let e of r)await this.docClient.send(new d.BatchWriteCommand({RequestItems:{[this.proposalsTable]:e.map(n=>({PutRequest:{Item:n}}))}}))}async getProposalsByStatus(t){return(await this.docClient.send(new d.QueryCommand({TableName:this.proposalsTable,IndexName:"by-status",KeyConditionExpression:"#status = :status",ExpressionAttributeNames:{"#status":"status"},ExpressionAttributeValues:{":status":t},ScanIndexForward:!1}))).Items||[]}async queryProposals(t,r=1,e=50){let n=[],s={},o={};if(t.status){let g=Array.isArray(t.status)?t.status:[t.status];g.length===1&&(n.push("#status = :status"),s["#status"]="status",o[":status"]=g[0])}t.brand&&(n.push("brand = :brand"),o[":brand"]=t.brand),t.batchId&&(n.push("batchId = :batchId"),o[":batchId"]=t.batchId),t.hasWarnings&&(n.push("size(warnings) > :zero"),o[":zero"]=0);let u=(await this.docClient.send(new d.ScanCommand({TableName:this.proposalsTable,FilterExpression:n.length>0?n.join(" AND "):void 0,ExpressionAttributeNames:Object.keys(s).length>0?s:void 0,ExpressionAttributeValues:Object.keys(o).length>0?o:void 0}))).Items||[];if(t.searchTerm){let g=t.searchTerm.toLowerCase();u=u.filter(f=>f.sku.toLowerCase().includes(g)||f.productTitle.toLowerCase().includes(g))}u.sort((g,f)=>new Date(f.createdAt).getTime()-new Date(g.createdAt).getTime());let c=u.length,m=(r-1)*e;return{items:u.slice(m,m+e),totalCount:c,page:r,pageSize:e,hasMore:m+e<c}}async updateProposalStatus(t,r,e,n,s){let o=["#status = :status","reviewedAt = :reviewedAt","reviewedBy = :reviewedBy"],i={"#status":"status"},u={":status":r,":reviewedAt":new Date().toISOString(),":reviewedBy":e};n&&(o.push("reviewNotes = :notes"),u[":notes"]=n),s!==void 0&&(o.push("approvedPrice = :approvedPrice"),u[":approvedPrice"]=s),await this.docClient.send(new d.UpdateCommand({TableName:this.proposalsTable,Key:{proposalId:t},UpdateExpression:`SET ${o.join(", ")}`,ExpressionAttributeNames:i,ExpressionAttributeValues:u}))}async getChannel(t){return(await this.docClient.send(new d.GetCommand({TableName:this.channelsTable,Key:{channelId:t}}))).Item||null}async putChannel(t){await this.docClient.send(new d.PutCommand({TableName:this.channelsTable,Item:{...t,lastUpdated:new Date().toISOString()}}))}async getAllChannels(){return(await this.docClient.send(new d.ScanCommand({TableName:this.channelsTable}))).Items||[]}async batchPutOrders(t){let r=this.chunkArray(t,25);for(let e of r)await this.docClient.send(new d.BatchWriteCommand({RequestItems:{[this.ordersTable]:e.map(n=>({PutRequest:{Item:n}}))}}))}async getOrdersByDate(t){return(await this.docClient.send(new d.QueryCommand({TableName:this.ordersTable,IndexName:"by-date",KeyConditionExpression:"orderDateDay = :dateDay",ExpressionAttributeValues:{":dateDay":t}}))).Items||[]}async getOrdersByChannel(t,r,e){return(await this.docClient.send(new d.QueryCommand({TableName:this.ordersTable,IndexName:"by-channel",KeyConditionExpression:"channelName = :channel AND orderDate BETWEEN :fromDate AND :toDate",ExpressionAttributeValues:{":channel":t,":fromDate":r,":toDate":e}}))).Items||[]}async getOrderCount(){return(await this.docClient.send(new d.ScanCommand({TableName:this.ordersTable,Select:"COUNT"}))).Count||0}async getProductLookupMap(){let t=await this.getAllProducts(),r=new Map,e=new Map;for(let n of t)r.set(n.sku.toUpperCase(),n),n.balterleySku&&e.set(n.balterleySku.toUpperCase(),n);return{bySku:r,byBalterleySku:e}}async getSalesBySku(t=7){let r=new Map,e=new Date,n=[];for(let s=0;s<t;s++){let o=new Date(e);o.setDate(o.getDate()-s),n.push(o.toISOString().substring(0,10))}for(let s of n){let o=await this.getOrdersByDate(s);for(let i of o)if(i.lines)for(let u of i.lines){let c=r.get(u.sku)||{quantity:0,revenue:0};c.quantity+=u.quantity,c.revenue+=u.lineTotalInclVat,r.set(u.sku,c)}}return r}chunkArray(t,r){let e=[];for(let n=0;n<t.length;n+=r)e.push(t.slice(n,n+r));return e}};function E(){return new S({productsTable:process.env.PRODUCTS_TABLE||"repricing-products",rulesTable:process.env.PRICING_RULES_TABLE||"repricing-rules",proposalsTable:process.env.PRICE_PROPOSALS_TABLE||"repricing-proposals",channelsTable:process.env.CHANNEL_CONFIG_TABLE||"repricing-channels",ordersTable:process.env.ORDERS_TABLE||"repricing-orders"})}var R=require("uuid"),p=E();async function F(a,t){console.log("API request:",{method:a.httpMethod,path:a.path,requestId:t.awsRequestId});try{let r=a.path,e=a.httpMethod;return r.startsWith("/products")?_(a):r.startsWith("/proposals")?L(a):r.startsWith("/rules")?V(a):r.startsWith("/channels")?z(a):r.startsWith("/analytics")?K(a):r.startsWith("/import")?W(a):r==="/sync"&&e==="POST"?j(a):l(404,{error:"Not found"})}catch(r){return console.error("API error:",r),l(500,{error:r instanceof Error?r.message:"Internal server error"})}}async function _(a){let t=a.httpMethod,r=a.pathParameters?.sku;if(t==="GET"&&!r){let e=await p.getAllProducts();return l(200,{items:e,count:e.length})}if(t==="GET"&&r){let e=await p.getProduct(r);return e?l(200,e):l(404,{error:"Product not found"})}if(t==="PUT"&&r){let e=JSON.parse(a.body||"{}"),n=await p.getProduct(r);if(!n)return l(404,{error:"Product not found"});let s={...n,costPrice:e.costPrice??n.costPrice,deliveryCost:e.deliveryCost??n.deliveryCost,category:e.category??n.category};return await p.putProduct(s),l(200,s)}return l(405,{error:"Method not allowed"})}async function L(a){let t=a.httpMethod,r=a.path,e=a.pathParameters?.proposalId;if(r.endsWith("/bulk-approve")&&t==="POST"){let n=JSON.parse(a.body||"{}"),s=[];for(let o of n.proposalIds)await p.updateProposalStatus(o,"approved",n.reviewedBy,n.notes),s.push({proposalId:o,status:"approved"});return l(200,{results:s})}if(r.endsWith("/bulk-reject")&&t==="POST"){let n=JSON.parse(a.body||"{}"),s=[];for(let o of n.proposalIds)await p.updateProposalStatus(o,"rejected",n.reviewedBy,n.notes),s.push({proposalId:o,status:"rejected"});return l(200,{results:s})}if(r.endsWith("/push")&&t==="POST")return q(a);if(t==="GET"&&!e){let n=a.queryStringParameters||{},s={status:n.status,batchId:n.batchId,brand:n.brand,searchTerm:n.search,hasWarnings:n.hasWarnings==="true"},o=parseInt(n.page||"1",10),i=parseInt(n.pageSize||"50",10),u=await p.queryProposals(s,o,i);return l(200,u)}if(t==="GET"&&e){let n=await p.getProposal(e);return n?l(200,n):l(404,{error:"Proposal not found"})}if(t==="PUT"&&e){let n=JSON.parse(a.body||"{}"),{action:s,modifiedPrice:o,notes:i,reviewedBy:u}=n;if(!s||!u)return l(400,{error:"action and reviewedBy are required"});let c,m;switch(s){case"approve":c="approved";break;case"reject":c="rejected";break;case"modify":if(o===void 0)return l(400,{error:"modifiedPrice required for modify action"});c="modified",m=o;break;default:return l(400,{error:"Invalid action"})}await p.updateProposalStatus(e,c,u,i,m);let h=await p.getProposal(e);return l(200,h)}return l(405,{error:"Method not allowed"})}async function q(a){let r=JSON.parse(a.body||"{}").dryRun===!0,e=await p.getProposalsByStatus("approved"),n=await p.getProposalsByStatus("modified"),s=[...e,...n];if(s.length===0)return l(200,{message:"No approved proposals to push",count:0});let o=s.map(m=>({merchantProductNo:m.sku,price:m.approvedPrice??m.proposedPrice}));if(r)return l(200,{dryRun:!0,count:o.length,updates:o});let i=process.env.CHANNEL_ENGINE_SECRET_ARN;if(!i)return l(500,{error:"ChannelEngine not configured"});let c=await(await k(i)).updatePrices(o);if(c.success)for(let m of s)await p.updateProposalStatus(m.proposalId,"pushed","system","Pushed to ChannelEngine");return l(200,{success:c.success,pushed:o.length,errors:c.errors})}async function V(a){let t=a.httpMethod,r=a.pathParameters?.ruleId;if(t==="GET"&&!r){let e=await p.getAllRules();return l(200,{items:e,count:e.length})}if(t==="GET"&&r){let e=await p.getRule(r);return e?l(200,e):l(404,{error:"Rule not found"})}if(t==="POST"){let e=JSON.parse(a.body||"{}"),n={ruleId:(0,R.v4)(),name:e.name,description:e.description,priority:e.priority??100,isActive:e.isActive??!0,conditions:e.conditions||{},action:e.action,createdAt:new Date().toISOString(),updatedAt:new Date().toISOString()};return await p.putRule(n),l(201,n)}if(t==="PUT"&&r){let e=await p.getRule(r);if(!e)return l(404,{error:"Rule not found"});let n=JSON.parse(a.body||"{}"),s={...e,name:n.name??e.name,description:n.description??e.description,priority:n.priority??e.priority,isActive:n.isActive??e.isActive,conditions:n.conditions??e.conditions,action:n.action??e.action,updatedAt:new Date().toISOString()};return await p.putRule(s),l(200,s)}return t==="DELETE"&&r?(await p.deleteRule(r),l(204,null)):l(405,{error:"Method not allowed"})}async function z(a){let t=a.httpMethod,r=a.pathParameters?.channelId;if(t==="GET"&&!r){let e=await p.getAllChannels();return l(200,{items:e,count:e.length})}if(t==="GET"&&r){let e=await p.getChannel(r);return e?l(200,e):l(404,{error:"Channel not found"})}if(t==="PUT"&&r){let e=await p.getChannel(r),n=JSON.parse(a.body||"{}"),s={channelId:r,name:n.name??e?.name??r,isActive:n.isActive??e?.isActive??!0,commissionPercent:n.commissionPercent??e?.commissionPercent??0,fixedFee:n.fixedFee??e?.fixedFee,paymentProcessingPercent:n.paymentProcessingPercent??e?.paymentProcessingPercent,defaultAcosPercent:n.defaultAcosPercent??e?.defaultAcosPercent,includeAdvertisingInMargin:n.includeAdvertisingInMargin??e?.includeAdvertisingInMargin??!0,vatPercent:n.vatPercent??e?.vatPercent??20,pricesIncludeVat:n.pricesIncludeVat??e?.pricesIncludeVat??!0,channelEngineId:n.channelEngineId??e?.channelEngineId,lastUpdated:new Date().toISOString()};return await p.putChannel(s),l(200,s)}return l(405,{error:"Method not allowed"})}async function K(a){let t=a.path,r=a.queryStringParameters||{};if(t.endsWith("/summary")){let e=await p.getAllProducts(),n=await p.getProposalsByStatus("pending"),s={totalProducts:e.length,productsWithCosts:e.filter(o=>o.costPrice>0).length,productsWithoutCosts:e.filter(o=>!o.costPrice||o.costPrice===0).length,outOfStock:e.filter(o=>o.stockLevel===0).length,lowStock:e.filter(o=>o.stockLevel>0&&o.stockLevel<10).length,pendingProposals:n.length,avgMargin:e.length>0?e.reduce((o,i)=>o+(i.calculatedMargin||0),0)/e.length:0};return l(200,s)}if(t.endsWith("/margins")){let e=await p.getAllProducts(),n={negative:e.filter(s=>(s.calculatedMargin||0)<0).length,low:e.filter(s=>(s.calculatedMargin||0)>=0&&(s.calculatedMargin||0)<15).length,target:e.filter(s=>(s.calculatedMargin||0)>=15&&(s.calculatedMargin||0)<30).length,high:e.filter(s=>(s.calculatedMargin||0)>=30).length};return l(200,{marginBands:n,total:e.length})}if(t.endsWith("/sales")){let e=parseInt(r.days||"7",10),n=await p.getSalesBySku(e),s={};return n.forEach((o,i)=>{s[i]=o}),l(200,{days:e,skuCount:n.size,sales:s})}return l(404,{error:"Analytics endpoint not found"})}async function W(a){if(a.path.endsWith("/costs")&&a.httpMethod==="POST"){let e=JSON.parse(a.body||"{}").data;if(!e||!Array.isArray(e))return l(400,{error:"Invalid data format. Expected { data: [...] }"});let{bySku:n,byBalterleySku:s}=await p.getProductLookupMap();console.log(`[Import] Built lookup maps: ${n.size} products by SKU, ${s.size} by Balterley SKU`);let o=0,i=0,u=0,c=[],m=[];for(let P of e){let b=P.sku.toUpperCase().trim(),y=n.get(b);y||(y=s.get(b),y&&u++),y?(y.costPrice=P.costPrice,P.deliveryCost!==void 0&&(y.deliveryCost=P.deliveryCost),m.push(y),o++):(i++,c.length<20&&c.push(P.sku))}m.length>0&&(console.log(`[Import] Batch writing ${m.length} products...`),await p.batchPutProducts(m));let h=new Set(e.map(P=>P.sku.toUpperCase().trim()));console.log(`[Import] importedSkuSet size: ${h.size}, bySku size: ${n.size}`);let g=[],f=0;for(let[P,b]of n)h.has(P)||(f++,g.length<50&&g.push(b.sku));let v=f;return console.log(`[Import] Found ${f} DB SKUs missing from file, collected ${g.length} samples`),console.log(`[Import] Complete: ${o} updated, ${i} not found in DB, ${v} DB SKUs missing from file, ${u} matched by Balterley SKU`),c.length>0&&console.log(`[Import] Sample file SKUs not in DB: ${c.join(", ")}`),g.length>0&&console.log(`[Import] Sample DB SKUs missing from file: ${g.join(", ")}`),l(200,{message:"Cost import complete",updated:o,notFoundInDb:i,matchedByBalterleySku:u,total:e.length,sampleNotFoundInDb:c.length>0?c:void 0,dbProductsMissingFromFile:v,sampleDbSkusMissingFromFile:g.length>0?g:void 0})}return l(404,{error:"Import endpoint not found"})}async function j(a){return l(200,{message:"Manual sync not yet implemented. Use AWS Console to invoke data-sync Lambda."})}function l(a,t){return{statusCode:a,headers:{"Content-Type":"application/json","Access-Control-Allow-Origin":"*","Access-Control-Allow-Methods":"GET, POST, PUT, DELETE, OPTIONS","Access-Control-Allow-Headers":"Content-Type, Authorization"},body:t?JSON.stringify(t):""}}0&&(module.exports={handler});
//# sourceMappingURL=index.js.map
