"use strict";var k=Object.create;var f=Object.defineProperty;var A=Object.getOwnPropertyDescriptor;var D=Object.getOwnPropertyNames;var I=Object.getPrototypeOf,R=Object.prototype.hasOwnProperty;var x=(u,e)=>{for(var t in e)f(u,t,{get:e[t],enumerable:!0})},v=(u,e,t,n)=>{if(e&&typeof e=="object"||typeof e=="function")for(let r of D(e))!R.call(u,r)&&r!==t&&f(u,r,{get:()=>e[r],enumerable:!(n=A(e,r))||n.enumerable});return u};var y=(u,e,t)=>(t=u!=null?k(I(u)):{},v(e||!u||!u.__esModule?f(t,"default",{value:u,enumerable:!0}):t,u)),N=u=>v(f({},"__esModule",{value:!0}),u);var L={};x(L,{handler:()=>O});module.exports=N(L);var M=require("googleapis");var C=class{apiKey;tenantId;baseUrl;constructor(e){this.apiKey=e.apiKey,this.tenantId=e.tenantId,this.baseUrl=e.baseUrl||"https://api.channelengine.net/api/v2"}async request(e,t="GET",n,r={}){let s=new URLSearchParams;s.set("apikey",this.apiKey);for(let[l,o]of Object.entries(r))s.set(l,String(o));let a=`${this.baseUrl}${e}?${s.toString()}`,i=await fetch(a,{method:t,headers:{"Content-Type":"application/json",Accept:"application/json"},body:n?JSON.stringify(n):void 0});if(!i.ok){let l=await i.text();throw new Error(`ChannelEngine API error: ${i.status} ${i.statusText} - ${l}`)}return i.json()}async fetchProducts(e){let t=[],n=1,r=100,s=!0,a=0;for(console.log(`[CE] Starting product fetch from ${this.baseUrl}/products`);s;){console.log(`[CE] Fetching page ${n}...`);try{let i=await this.request("/products","GET",void 0,{page:n,pageSize:r});if(a=i.TotalCount||a,i.Content&&i.Content.length>0){let l=[];for(let o of i.Content)l.push({merchantProductNo:o.MerchantProductNo,name:o.Name,description:o.Description,brand:o.Brand,ean:o.Ean,stock:o.Stock,price:o.Price,categoryTrail:o.CategoryTrail});t.push(...l),console.log(`[CE] Page ${n}: Got ${l.length} products (${t.length}/${a})`),e&&await e(l,n,a),n++,s=i.Content.length===r}else console.log(`[CE] Page ${n}: No more products`),s=!1}catch(i){throw console.error(`[CE] Error fetching page ${n}:`,i),i}}return console.log(`[CE] Completed: Fetched ${t.length} total products`),t}async fetchSalesData(e,t){let n=new Map,r=1,s=100,a=!0,i=e.toISOString(),l=t.toISOString();for(;a;){let o=await this.request("/orders","GET",void 0,{fromDate:i,toDate:l,page:r,pageSize:s});if(o.Content&&o.Content.length>0){for(let p of o.Content)if(p.Lines)for(let m of p.Lines){let d=n.get(m.MerchantProductNo)||{quantity:0,revenue:0};d.quantity+=m.Quantity,d.revenue+=m.UnitPriceInclVat*m.Quantity,n.set(m.MerchantProductNo,d)}r++,a=o.Content.length===s}else a=!1}return n}async fetchSalesMetrics(){let e=new Date,t=new Date(e.getTime()-7*24*60*60*1e3),n=new Date(e.getTime()-30*24*60*60*1e3),[r,s]=await Promise.all([this.fetchSalesData(t,e),this.fetchSalesData(n,e)]),a=new Set([...r.keys(),...s.keys()]);return Array.from(a).map(i=>({merchantProductNo:i,salesLast7Days:r.get(i)?.quantity||0,salesLast30Days:s.get(i)?.quantity||0}))}async fetchOrders(e,t){let n=[],r=1,s=100,a=!0,i=0,l=e.toISOString();for(console.log(`[CE] Starting order fetch from ${l}`);a;){console.log(`[CE] Fetching orders page ${r}...`);try{let o=await this.request("/orders","GET",void 0,{fromDate:l,page:r,pageSize:s});i=o.TotalCount||i,o.Content&&o.Content.length>0?(n.push(...o.Content),console.log(`[CE] Page ${r}: Got ${o.Content.length} orders (${n.length}/${i})`),t&&await t(o.Content,r,i),r++,a=o.Content.length===s):(console.log(`[CE] Page ${r}: No more orders`),a=!1)}catch(o){throw console.error(`[CE] Error fetching orders page ${r}:`,o),o}}return console.log(`[CE] Completed: Fetched ${n.length} total orders`),n}async updatePrices(e){let t=[];for(let r=0;r<e.length;r+=100){let s=e.slice(r,r+100);try{let a=s.map(l=>({MerchantProductNo:l.merchantProductNo,Price:l.price})),i=await this.request("/products/bulk","PUT",a);i.Success||t.push(`Batch ${r/100+1}: ${i.Message}`)}catch(a){t.push(`Batch ${r/100+1}: ${a instanceof Error?a.message:"Unknown error"}`)}}return{success:t.length===0,errors:t}}async updateStock(e){let t=[];for(let r=0;r<e.length;r+=100){let s=e.slice(r,r+100);try{let a=s.map(l=>({MerchantProductNo:l.merchantProductNo,Stock:l.stock})),i=await this.request("/offer/stock","PUT",a);i.Success||t.push(`Batch ${r/100+1}: ${i.Message}`)}catch(a){t.push(`Batch ${r/100+1}: ${a instanceof Error?a.message:"Unknown error"}`)}}return{success:t.length===0,errors:t}}};async function S(u){let{SecretsManagerClient:e,GetSecretValueCommand:t}=await import("@aws-sdk/client-secrets-manager"),r=await new e({}).send(new t({SecretId:u}));if(!r.SecretString)throw new Error("ChannelEngine secret not found");let s=JSON.parse(r.SecretString);return new C({apiKey:s.apiKey,tenantId:s.tenantId,baseUrl:s.baseUrl})}var _=require("uuid");var E=require("@aws-sdk/client-dynamodb"),c=require("@aws-sdk/lib-dynamodb"),w=class{docClient;productsTable;rulesTable;proposalsTable;channelsTable;ordersTable;carrierCostsTable;constructor(e){let t=new E.DynamoDBClient({});this.docClient=c.DynamoDBDocumentClient.from(t,{marshallOptions:{removeUndefinedValues:!0}}),this.productsTable=e.productsTable,this.rulesTable=e.rulesTable,this.proposalsTable=e.proposalsTable,this.channelsTable=e.channelsTable,this.ordersTable=e.ordersTable||"repricing-orders",this.carrierCostsTable=e.carrierCostsTable||"repricing-carrier-costs"}async getProduct(e){return(await this.docClient.send(new c.GetCommand({TableName:this.productsTable,Key:{sku:e}}))).Item||null}async putProduct(e){await this.docClient.send(new c.PutCommand({TableName:this.productsTable,Item:{...e,lastUpdated:new Date().toISOString()}}))}async getAllProducts(){let e=[],t;do{let n=await this.docClient.send(new c.ScanCommand({TableName:this.productsTable,ExclusiveStartKey:t}));n.Items&&e.push(...n.Items),t=n.LastEvaluatedKey}while(t);return e}async batchPutProducts(e){let t=new Date().toISOString(),n=this.chunkArray(e,25);for(let r of n)await this.docClient.send(new c.BatchWriteCommand({RequestItems:{[this.productsTable]:r.map(s=>({PutRequest:{Item:{...s,lastUpdated:t}}}))}}))}async getProductsByBrand(e){return(await this.docClient.send(new c.QueryCommand({TableName:this.productsTable,IndexName:"by-brand",KeyConditionExpression:"brand = :brand",ExpressionAttributeValues:{":brand":e}}))).Items||[]}async getRule(e){return(await this.docClient.send(new c.GetCommand({TableName:this.rulesTable,Key:{ruleId:e}}))).Item||null}async putRule(e){await this.docClient.send(new c.PutCommand({TableName:this.rulesTable,Item:{...e,updatedAt:new Date().toISOString()}}))}async getAllRules(){return((await this.docClient.send(new c.ScanCommand({TableName:this.rulesTable}))).Items||[]).sort((t,n)=>t.priority-n.priority)}async deleteRule(e){let{DeleteCommand:t}=await import("@aws-sdk/lib-dynamodb");await this.docClient.send(new t({TableName:this.rulesTable,Key:{ruleId:e}}))}async getProposal(e){return(await this.docClient.send(new c.GetCommand({TableName:this.proposalsTable,Key:{proposalId:e}}))).Item||null}async putProposal(e){await this.docClient.send(new c.PutCommand({TableName:this.proposalsTable,Item:e}))}async batchPutProposals(e){let t=this.chunkArray(e,25);for(let n of t)await this.docClient.send(new c.BatchWriteCommand({RequestItems:{[this.proposalsTable]:n.map(r=>({PutRequest:{Item:r}}))}}))}async getProposalsByStatus(e){return(await this.docClient.send(new c.QueryCommand({TableName:this.proposalsTable,IndexName:"by-status",KeyConditionExpression:"#status = :status",ExpressionAttributeNames:{"#status":"status"},ExpressionAttributeValues:{":status":e},ScanIndexForward:!1}))).Items||[]}async queryProposals(e,t=1,n=50){let r=[],s={},a={};if(e.status){let d=Array.isArray(e.status)?e.status:[e.status];d.length===1&&(r.push("#status = :status"),s["#status"]="status",a[":status"]=d[0])}e.brand&&(r.push("brand = :brand"),a[":brand"]=e.brand),e.batchId&&(r.push("batchId = :batchId"),a[":batchId"]=e.batchId),e.hasWarnings&&(r.push("size(warnings) > :zero"),a[":zero"]=0);let l=(await this.docClient.send(new c.ScanCommand({TableName:this.proposalsTable,FilterExpression:r.length>0?r.join(" AND "):void 0,ExpressionAttributeNames:Object.keys(s).length>0?s:void 0,ExpressionAttributeValues:Object.keys(a).length>0?a:void 0}))).Items||[];if(e.searchTerm){let d=e.searchTerm.toLowerCase();l=l.filter(g=>g.sku.toLowerCase().includes(d)||g.productTitle.toLowerCase().includes(d))}l.sort((d,g)=>new Date(g.createdAt).getTime()-new Date(d.createdAt).getTime());let o=l.length,p=(t-1)*n;return{items:l.slice(p,p+n),totalCount:o,page:t,pageSize:n,hasMore:p+n<o}}async updateProposalStatus(e,t,n,r,s){let a=["#status = :status","reviewedAt = :reviewedAt","reviewedBy = :reviewedBy"],i={"#status":"status"},l={":status":t,":reviewedAt":new Date().toISOString(),":reviewedBy":n};r&&(a.push("reviewNotes = :notes"),l[":notes"]=r),s!==void 0&&(a.push("approvedPrice = :approvedPrice"),l[":approvedPrice"]=s),await this.docClient.send(new c.UpdateCommand({TableName:this.proposalsTable,Key:{proposalId:e},UpdateExpression:`SET ${a.join(", ")}`,ExpressionAttributeNames:i,ExpressionAttributeValues:l}))}async getChannel(e){return(await this.docClient.send(new c.GetCommand({TableName:this.channelsTable,Key:{channelId:e}}))).Item||null}async putChannel(e){await this.docClient.send(new c.PutCommand({TableName:this.channelsTable,Item:{...e,lastUpdated:new Date().toISOString()}}))}async getAllChannels(){return(await this.docClient.send(new c.ScanCommand({TableName:this.channelsTable}))).Items||[]}async getCarrierCost(e){return(await this.docClient.send(new c.GetCommand({TableName:this.carrierCostsTable,Key:{carrierId:e}}))).Item||null}async putCarrierCost(e){await this.docClient.send(new c.PutCommand({TableName:this.carrierCostsTable,Item:{...e,lastUpdated:new Date().toISOString()}}))}async getAllCarrierCosts(){return(await this.docClient.send(new c.ScanCommand({TableName:this.carrierCostsTable}))).Items||[]}async deleteCarrierCost(e){let{DeleteCommand:t}=await import("@aws-sdk/lib-dynamodb");await this.docClient.send(new t({TableName:this.carrierCostsTable,Key:{carrierId:e}}))}async batchPutCarrierCosts(e){let t=new Date().toISOString(),n=this.chunkArray(e,25);for(let r of n)await this.docClient.send(new c.BatchWriteCommand({RequestItems:{[this.carrierCostsTable]:r.map(s=>({PutRequest:{Item:{...s,lastUpdated:t}}}))}}))}async batchPutOrders(e){let t=this.chunkArray(e,25);for(let n of t)await this.docClient.send(new c.BatchWriteCommand({RequestItems:{[this.ordersTable]:n.map(r=>({PutRequest:{Item:r}}))}}))}async getOrdersByDate(e){return(await this.docClient.send(new c.QueryCommand({TableName:this.ordersTable,IndexName:"by-date",KeyConditionExpression:"orderDateDay = :dateDay",ExpressionAttributeValues:{":dateDay":e}}))).Items||[]}async getOrdersByChannel(e,t,n){return(await this.docClient.send(new c.QueryCommand({TableName:this.ordersTable,IndexName:"by-channel",KeyConditionExpression:"channelName = :channel AND orderDate BETWEEN :fromDate AND :toDate",ExpressionAttributeValues:{":channel":e,":fromDate":t,":toDate":n}}))).Items||[]}async getOrderCount(){return(await this.docClient.send(new c.ScanCommand({TableName:this.ordersTable,Select:"COUNT"}))).Count||0}async getOrder(e){return(await this.docClient.send(new c.GetCommand({TableName:this.ordersTable,Key:{orderId:e}}))).Item||null}async updateOrderDelivery(e,t){await this.docClient.send(new c.UpdateCommand({TableName:this.ordersTable,Key:{orderId:e},UpdateExpression:"SET deliveryCarrier = :carrier, deliveryCarrierRaw = :carrierRaw, deliveryParcels = :parcels, deliveryImportedAt = :importedAt",ExpressionAttributeValues:{":carrier":t.deliveryCarrier,":carrierRaw":t.deliveryCarrierRaw,":parcels":t.deliveryParcels,":importedAt":new Date().toISOString()}}))}async getAllOrders(){let e=[],t;do{let n=await this.docClient.send(new c.ScanCommand({TableName:this.ordersTable,ExclusiveStartKey:t}));n.Items&&e.push(...n.Items),t=n.LastEvaluatedKey}while(t);return e}async getProductLookupMap(){let e=await this.getAllProducts(),t=new Map,n=new Map;for(let r of e)t.set(r.sku.toUpperCase(),r),r.balterleySku&&n.set(r.balterleySku.toUpperCase(),r);return{bySku:t,byBalterleySku:n}}async getSalesBySku(e=7){let t=new Map,n=new Date,r=[];for(let s=0;s<e;s++){let a=new Date(n);a.setDate(a.getDate()-s),r.push(a.toISOString().substring(0,10))}for(let s of r){let a=await this.getOrdersByDate(s);for(let i of a)if(i.lines)for(let l of i.lines){let o=t.get(l.sku)||{quantity:0,revenue:0};o.quantity+=l.quantity,o.revenue+=l.lineTotalInclVat,t.set(l.sku,o)}}return t}chunkArray(e,t){let n=[];for(let r=0;r<e.length;r+=t)n.push(e.slice(r,r+t));return n}};function T(){return new w({productsTable:process.env.PRODUCTS_TABLE||"repricing-products",rulesTable:process.env.PRICING_RULES_TABLE||"repricing-rules",proposalsTable:process.env.PRICE_PROPOSALS_TABLE||"repricing-proposals",channelsTable:process.env.CHANNEL_CONFIG_TABLE||"repricing-channels",ordersTable:process.env.ORDERS_TABLE||"repricing-orders",carrierCostsTable:process.env.CARRIER_COSTS_TABLE||"repricing-carrier-costs"})}async function O(u,e){console.log("Starting data sync",{event:u,requestId:e.awsRequestId});let t=T(),n=0,r=0;try{console.log("[DB] Loading existing products to preserve cost data...");let s=await t.getAllProducts(),a=new Map(s.map(o=>[o.sku,o]));console.log(`[DB] Found ${s.length} existing products`),console.log("[CE] Starting incremental fetch and save...");let i=process.env.CHANNEL_ENGINE_SECRET_ARN;if(!i)throw new Error("CHANNEL_ENGINE_SECRET_ARN not configured");await(await S(i)).fetchProducts(async(o,p,m)=>{let d=new Date().toISOString(),g=o.map(h=>{let b=h.merchantProductNo,P=a.get(b);return{sku:b,title:h.name||b,brand:h.brand||"Unknown",category:h.categoryTrail||"Uncategorized",mrp:P?.mrp||0,currentPrice:h.price,costPrice:P?.costPrice||0,deliveryCost:P?.deliveryCost||0,stockLevel:h.stock,stockLastUpdated:d,salesLast7Days:P?.salesLast7Days||0,salesLast30Days:P?.salesLast30Days||0,lastUpdated:d,lastSyncedFromChannelEngine:d}});await t.batchPutProducts(g),n+=g.length,r=m,console.log(`[DB] Saved batch ${p}: ${g.length} products (${n}/${m} total saved)`)}),console.log(`[DONE] Data sync complete: ${n} products saved to DynamoDB`)}catch(s){throw console.error(`[ERROR] Data sync failed after saving ${n} products:`,s),s}}0&&(module.exports={handler});
//# sourceMappingURL=index.js.map
